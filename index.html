<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Allabroad</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a1a">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOT & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --red:        #DC143C;
  --red-dark:   #b01030;
  --glass:      rgba(255,255,255,0.11);
  --glass-b:    rgba(255,255,255,0.22);
  --text:       #ffffff;
  --dim:        rgba(255,255,255,0.45);
  --sand:       #c8a96e;
  --cd-h:       68px;
  --tab-h:      64px;
  --sat: env(safe-area-inset-top,0px);
  --sab: env(safe-area-inset-bottom,0px);
  --sal: env(safe-area-inset-left,0px);
  --sar: env(safe-area-inset-right,0px);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;background:#0a0a1a;color:var(--text);font-family:'DM Sans',sans-serif;overflow:hidden;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREENS â€” single-page navigation
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{
  position:fixed;inset:0;
  display:flex;flex-direction:column;
  opacity:0;pointer-events:none;
  transition:opacity 0.3s ease;
  overflow:hidden;
}
.screen.active{opacity:1;pointer-events:all;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘  AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-auth{
  background:linear-gradient(160deg,#0a0a1a 0%,#1a1a3e 50%,#0a0a1a 100%);
  align-items:center;justify-content:center;
  padding:40px 24px calc(var(--sab)+40px);
  padding-top:calc(var(--sat)+40px);
}
.auth-bg-word{
  position:absolute;font-family:'Playfair Display',serif;
  font-size:clamp(5rem,25vw,14rem);font-weight:900;
  color:rgba(255,255,255,0.025);letter-spacing:-0.02em;
  top:50%;left:50%;transform:translate(-50%,-50%);
  white-space:nowrap;pointer-events:none;user-select:none;
}
.auth-logo{
  font-family:'Playfair Display',serif;
  font-size:3rem;font-weight:900;letter-spacing:-0.02em;
  color:var(--text);margin-bottom:4px;text-align:center;
}
.auth-logo span{color:var(--red);}
.auth-tag{
  font-size:0.72rem;letter-spacing:0.22em;text-transform:uppercase;
  color:var(--dim);margin-bottom:40px;text-align:center;
}
.auth-card{
  width:100%;max-width:400px;
  background:rgba(255,255,255,0.07);
  border:1px solid var(--glass-b);
  border-radius:24px;padding:28px 24px;
  backdrop-filter:blur(20px);
}
.auth-tabs{
  display:flex;gap:0;
  background:rgba(0,0,0,0.3);
  border-radius:12px;padding:4px;
  margin-bottom:24px;
}
.auth-tab{
  flex:1;padding:8px;border:none;background:none;
  color:var(--dim);font-family:'DM Sans',sans-serif;
  font-size:0.85rem;font-weight:500;border-radius:9px;
  cursor:pointer;transition:all 0.2s;
}
.auth-tab.active{background:var(--red);color:#fff;}
.auth-field{margin-bottom:14px;}
.auth-field label{
  display:block;font-size:0.68rem;letter-spacing:0.14em;
  text-transform:uppercase;color:var(--dim);margin-bottom:7px;
}
.auth-field input{
  width:100%;padding:13px 14px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:11px;color:#fff;
  font-family:'DM Sans',sans-serif;font-size:1rem;
  outline:none;transition:border-color 0.2s;
  -webkit-appearance:none;
}
.auth-field input:focus{border-color:var(--red);}
.auth-field input::placeholder{color:var(--dim);}
.auth-err{font-size:0.78rem;color:#ff6b6b;min-height:18px;margin-bottom:10px;}
.btn-primary{
  width:100%;padding:14px;
  background:linear-gradient(135deg,var(--red),var(--red-dark));
  border:none;border-radius:11px;
  color:#fff;font-family:'DM Sans',sans-serif;
  font-size:0.95rem;font-weight:600;
  cursor:pointer;touch-action:manipulation;
  transition:opacity 0.2s,transform 0.15s;
}
.btn-primary:active{transform:scale(0.98);}
.auth-or{
  text-align:center;color:var(--dim);font-size:0.75rem;
  margin:14px 0;letter-spacing:0.1em;
}
.btn-ghost{
  width:100%;padding:12px;
  background:none;border:1px solid rgba(255,255,255,0.15);
  border-radius:11px;color:var(--dim);
  font-family:'DM Sans',sans-serif;font-size:0.88rem;
  cursor:pointer;touch-action:manipulation;
  transition:border-color 0.2s,color 0.2s;
}
.btn-ghost:hover{border-color:var(--red);color:var(--red);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘¡ DASHBOARD SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-dash{background:#0a0a1a;}
.dash-head{
  position:relative;z-index:10;
  padding:calc(var(--sat)+20px) 20px 0;
  background:linear-gradient(to bottom,#0a0a1a 70%,transparent);
  flex-shrink:0;
}
.dash-topbar{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:22px;
}
.dash-logo{
  font-family:'Playfair Display',serif;
  font-size:1.7rem;font-weight:900;letter-spacing:-0.01em;
}
.dash-logo span{color:var(--red);}
.dash-user-row{display:flex;align-items:center;gap:10px;}
.dash-signout{
  background:none;border:none;color:var(--dim);
  font-size:0.75rem;font-family:'DM Sans',sans-serif;
  cursor:pointer;padding:4px 8px;
  transition:color 0.2s;touch-action:manipulation;
}
.dash-signout:hover{color:var(--red);}
.dash-avatar{
  width:36px;height:36px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:600;font-size:0.8rem;color:#0a0a1a;
}
.dash-greeting{
  font-family:'Playfair Display',serif;
  font-size:1.8rem;font-weight:700;line-height:1.15;
  margin-bottom:3px;
}
.dash-greeting em{font-style:italic;color:var(--sand);}
.dash-sub{font-size:0.75rem;color:var(--dim);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:18px;}
.dash-actions{display:flex;gap:9px;margin-bottom:18px;}
.btn-new{
  flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
  padding:13px 16px;
  background:linear-gradient(135deg,var(--red),var(--red-dark));
  border:none;border-radius:14px;
  color:#fff;font-family:'DM Sans',sans-serif;
  font-size:0.9rem;font-weight:600;
  cursor:pointer;touch-action:manipulation;
  transition:opacity 0.2s,transform 0.15s;
}
.btn-new:active{transform:scale(0.97);}
.btn-join{
  padding:13px 18px;
  background:rgba(255,255,255,0.08);
  border:1px solid var(--glass-b);border-radius:14px;
  color:var(--dim);font-family:'DM Sans',sans-serif;
  font-size:0.9rem;white-space:nowrap;
  cursor:pointer;touch-action:manipulation;
  transition:border-color 0.2s,color 0.2s;
}
.btn-join:hover{border-color:var(--red);color:var(--red);}
.dash-lbl{
  font-size:0.67rem;letter-spacing:0.2em;text-transform:uppercase;
  color:var(--dim);padding:0 20px;margin-bottom:12px;flex-shrink:0;
}
.trips-scroll{
  flex:1;overflow-y:auto;overflow-x:hidden;
  padding:0 20px calc(var(--sab)+24px);
  -webkit-overflow-scrolling:touch;
}
.trips-scroll::-webkit-scrollbar{display:none;}

/* Trip cards */
.trip-card{
  position:relative;border-radius:20px;overflow:hidden;
  margin-bottom:14px;height:190px;
  cursor:pointer;
  border:1px solid rgba(255,255,255,0.08);
  transition:transform 0.25s cubic-bezier(0.34,1.3,0.64,1);
}
.trip-card:active{transform:scale(0.97);}
.tc-bg{
  position:absolute;inset:0;background-size:cover;background-position:center;
  transition:transform 0.5s ease;
}
.trip-card:hover .tc-bg{transform:scale(1.04);}
.tc-ov{
  position:absolute;inset:0;
  background:linear-gradient(to top,rgba(10,10,26,0.93) 0%,rgba(10,10,26,0.35) 55%,rgba(10,10,26,0.08) 100%);
}
.tc-code{
  position:absolute;top:14px;right:14px;
  padding:4px 11px;
  background:rgba(10,10,26,0.7);
  border:1px solid rgba(255,255,255,0.2);
  border-radius:20px;
  font-size:0.65rem;letter-spacing:0.15em;color:var(--sand);
  backdrop-filter:blur(8px);
}
.tc-body{position:absolute;bottom:0;left:0;right:0;padding:18px 20px;}
.tc-badge{
  display:inline-block;padding:3px 10px;
  background:rgba(220,20,60,0.25);border:1px solid rgba(220,20,60,0.4);
  border-radius:20px;font-size:0.63rem;letter-spacing:0.14em;
  text-transform:uppercase;color:var(--red);margin-bottom:7px;
}
.tc-dest{
  font-family:'Playfair Display',serif;
  font-size:1.65rem;font-weight:700;line-height:1.1;margin-bottom:6px;
}
.tc-meta{display:flex;gap:14px;font-size:0.72rem;color:rgba(255,255,255,0.6);}
.dash-empty{text-align:center;padding:60px 20px;}
.dash-empty-icon{font-size:2.8rem;margin-bottom:14px;opacity:0.4;}
.dash-empty-ttl{
  font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;
  color:rgba(255,255,255,0.5);margin-bottom:8px;
}
.dash-empty-sub{font-size:0.8rem;color:var(--dim);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘¢ TRIP INTERIOR â€” identical structure to London app
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-trip{background:#0a0a1a;}

/* Dynamic background image */
.trip-bg{
  position:fixed;inset:0;z-index:0;
  background-size:cover;background-position:center;
  filter:brightness(0.35);
  transition:background-image 0.6s ease,filter 1.2s;
}

.airplane{
  position:fixed;top:20px;left:-80px;font-size:2rem;
  z-index:100;animation:fly 18s linear infinite;pointer-events:none;
}
@keyframes fly{0%{left:-80px}100%{left:110vw}}

/* â”€â”€ Countdown bar â”€â”€ */
#cdBar{
  position:fixed;top:0;left:0;right:0;z-index:300;
  height:calc(var(--cd-h) + var(--sat));
  padding-top:var(--sat);
  background:rgba(10,10,26,0.96);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-bottom:1px solid rgba(255,255,255,0.08);
  display:flex;align-items:center;justify-content:center;gap:0;
  padding-left:max(20px,var(--sal));padding-right:max(20px,var(--sar));
}
.cd-cell{text-align:center;flex:1;max-width:90px;}
.cd-num{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;line-height:1;display:block;}
.cd-lbl{font-size:0.58rem;opacity:0.45;letter-spacing:1.2px;text-transform:uppercase;margin-top:2px;display:block;}
.cd-sep{font-family:'Playfair Display',serif;font-size:1.5rem;opacity:0.2;padding:0 4px;align-self:center;margin-bottom:8px;}
#arrivedPill{
  display:none;
  background:linear-gradient(135deg,var(--red),#8B0010);
  border-radius:30px;padding:9px 22px;
  font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;
  animation:pulse 2s infinite;
}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.75}}

/* Back button sits in countdown bar */
#btnBackToTrips{
  position:absolute;left:max(14px,var(--sal));top:calc(var(--sat) + 12px);
  display:flex;align-items:center;gap:5px;
  padding:7px 13px;
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.18);
  border-radius:30px;
  color:#fff;font-size:0.78rem;font-family:'DM Sans',sans-serif;
  cursor:pointer;touch-action:manipulation;
  backdrop-filter:blur(10px);
  transition:border-color 0.2s;
}
#btnBackToTrips:hover{border-color:var(--red);}

/* â”€â”€ Scrollable content â”€â”€ */
.scroll-wrap{
  position:relative;z-index:10;
  max-width:800px;margin:0 auto;
  padding:calc(var(--cd-h) + var(--sat) + 14px) max(20px,var(--sal)) calc(var(--tab-h) + var(--sab) + 16px) max(20px,var(--sar));
}

/* â”€â”€ Glass card â”€â”€ */
.glass{
  background:var(--glass);
  backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);
  border:1px solid var(--glass-b);
  border-radius:20px;padding:22px;
  margin-bottom:14px;
}

/* â”€â”€ Trip header â”€â”€ */
.trip-hdr{text-align:center;padding:28px 0 18px;}
.trip-hdr h1{font-family:'Playfair Display',serif;font-size:3rem;line-height:1;}
.trip-hdr h1 span{color:var(--red);}
.trip-hdr-sub{font-size:0.85rem;opacity:0.5;margin-top:6px;}

/* â”€â”€ Buttons â”€â”€ */
.btn{
  padding:10px 18px;border:none;border-radius:10px;
  cursor:pointer;font-weight:500;font-family:'DM Sans',sans-serif;
  transition:background 0.18s,transform 0.1s;
  font-size:0.9rem;-webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
}
.btn:active{transform:scale(0.96);}
.btn-red{background:var(--red);color:#fff;}
.btn-red:hover{background:var(--red-dark);}
.btn-glass{background:rgba(255,255,255,0.1);color:#fff;border:1px solid var(--glass-b);}
.btn-sm{padding:6px 14px;font-size:0.8rem;}
.btn-icon{padding:10px 13px;}

/* â”€â”€ Inputs â”€â”€ */
.input-row{display:flex;gap:9px;margin-bottom:13px;flex-wrap:wrap;}
input[type="text"],input[type="time"],textarea,select{
  flex:1;min-width:0;padding:13px 14px;
  background:rgba(255,255,255,0.1);
  border:1px solid var(--glass-b);
  border-radius:10px;color:#fff;outline:none;
  font-family:'DM Sans',sans-serif;font-size:1rem;
  -webkit-appearance:none;
}
input::placeholder{color:rgba(255,255,255,0.38);}
textarea{resize:vertical;min-height:120px;width:100%;}
select option{background:#1a1a3e;color:#fff;}

/* â”€â”€ List items â”€â”€ */
.item-row{
  display:flex;align-items:center;gap:11px;
  padding:13px 14px;
  background:rgba(255,255,255,0.05);
  border-radius:10px;margin-bottom:8px;
}
.item-row.checked .item-name{text-decoration:line-through;opacity:0.4;}
.item-name{flex:1;font-size:0.95rem;}
.del-btn{
  background:none;border:none;color:white;
  opacity:0.3;cursor:pointer;font-size:1.2rem;
  padding:8px 10px;margin:-6px -4px;
  transition:opacity 0.15s;touch-action:manipulation;
}
.del-btn:active{opacity:0.9;}
.del-btn:hover{opacity:0.7;}
.item-row input[type="checkbox"]{
  width:22px;height:22px;min-width:22px;
  accent-color:var(--red);cursor:pointer;
}
.empty{opacity:0.38;font-size:0.85rem;padding:5px 0;}

/* â”€â”€ Section header â”€â”€ */
.sec-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.sec-hdr h3{margin:0;font-size:1rem;font-weight:600;}

/* â”€â”€ Ticket cards â”€â”€ */
.ticket-card{
  background:rgba(255,255,255,0.07);border-radius:12px;
  padding:12px;margin-bottom:9px;
  display:flex;align-items:center;gap:13px;
  cursor:pointer;transition:background 0.18s;
}
.ticket-card:active{background:rgba(255,255,255,0.14);}
.t-thumb{width:52px;height:52px;border-radius:8px;object-fit:cover;flex-shrink:0;}
.t-thumb-ph{
  width:52px;height:52px;border-radius:8px;flex-shrink:0;
  background:rgba(220,20,60,0.15);
  display:flex;align-items:center;justify-content:center;font-size:1.4rem;
}
.photo-preview{display:none;align-items:center;gap:10px;margin-bottom:12px;padding:10px 13px;background:rgba(255,255,255,0.05);border-radius:10px;}
.photo-preview.on{display:flex;}

/* â”€â”€ Image modal â”€â”€ */
.img-modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,0.94);z-index:1000;
  align-items:center;justify-content:center;flex-direction:column;gap:14px;
}
.img-modal.open{display:flex;}
.img-modal img{max-width:95vw;max-height:85vh;border-radius:12px;}
.img-modal-x{color:white;font-size:0.95rem;opacity:0.55;cursor:pointer;padding:12px 28px;}

/* â”€â”€ Itinerary â”€â”€ */
.ev-row{
  display:flex;gap:10px;align-items:flex-start;
  padding:12px;background:rgba(255,255,255,0.06);
  border-radius:12px;margin-bottom:8px;
  border-left:3px solid var(--red);
}
.ev-time{font-size:0.8rem;color:rgba(255,255,255,0.55);min-width:44px;padding-top:2px;flex-shrink:0;}
.ev-body{flex:1;}
.ev-title{font-weight:500;font-size:0.95rem;}
.ev-note{font-size:0.8rem;opacity:0.5;margin-top:3px;}
.day-tabs{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:14px;}
.day-tab{
  padding:5px 13px;border-radius:20px;font-size:0.8rem;font-weight:500;
  cursor:pointer;border:1px solid var(--glass-b);
  background:rgba(255,255,255,0.07);color:white;
  transition:background 0.18s,border-color 0.18s;
  -webkit-tap-highlight-color:transparent;touch-action:manipulation;
}
.day-tab.active{background:var(--red);border-color:var(--red);}
.ev-form{display:none;margin-top:12px;padding-top:14px;border-top:1px solid var(--glass-b);}
.ev-form.on{display:block;}

/* â”€â”€ Memories â”€â”€ */
.mem-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.mem-cell{aspect-ratio:1;border-radius:10px;overflow:hidden;cursor:pointer;position:relative;background:rgba(255,255,255,0.05);}
.mem-cell img{width:100%;height:100%;object-fit:cover;transition:transform 0.2s;}
.mem-cell:active img{transform:scale(1.06);}
.mem-del{
  position:absolute;top:4px;right:4px;
  background:rgba(0,0,0,0.65);border:none;color:white;
  border-radius:50%;width:24px;height:24px;font-size:0.7rem;
  cursor:pointer;display:none;align-items:center;justify-content:center;
}
.mem-cell:hover .mem-del{display:flex;}
.mem-cap{
  position:absolute;bottom:0;left:0;right:0;
  background:linear-gradient(transparent,rgba(0,0,0,0.7));
  padding:8px 6px 5px;font-size:0.7rem;
  opacity:0;transition:opacity 0.2s;
}
.mem-cell:hover .mem-cap{opacity:1;}
.mem-preview{display:none;margin-bottom:14px;}
.mem-preview.on{display:block;}

/* â”€â”€ Traveler settings â”€â”€ */
#travelerSettingsList .item-row input[type="text"]{
  background:rgba(255,255,255,0.08);border:1px solid var(--glass-b);
  border-radius:8px;color:#fff;font-family:'DM Sans',sans-serif;
}
#travelerSettingsList .item-row input[type="text"]:focus{
  border-color:rgba(255,255,255,0.5);outline:none;
}
.notes-ok{font-size:0.75rem;color:#4caf50;}

/* â”€â”€ Dropbox guide â”€â”€ */
.help-step{display:flex;gap:12px;margin-bottom:16px;align-items:flex-start;}
.step-n{
  background:var(--red);color:white;border-radius:50%;
  width:24px;height:24px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-size:0.75rem;font-weight:700;margin-top:2px;
}
code{font-family:monospace;}

/* â”€â”€ Confetti â”€â”€ */
.cp{position:fixed;top:-12px;z-index:9999;pointer-events:none;animation:cfFall linear forwards;}
@keyframes cfFall{to{top:110vh;transform:rotate(720deg) translateX(var(--drift));}}

/* â”€â”€ Tab slider â”€â”€ */
.tabs-vp{overflow:hidden;}
.tabs-sl{display:flex;transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);will-change:transform;}
.tab-pnl{min-width:100%;}

/* â”€â”€ Bottom tab bar â”€â”€ */
.tab-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:200;
  background:rgba(10,10,26,0.97);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:1px solid rgba(255,255,255,0.1);
  display:flex;
  padding-bottom:var(--sab);
  padding-left:var(--sal);padding-right:var(--sar);
}
.tab-btn{
  flex:1;display:flex;flex-direction:column;
  align-items:center;gap:3px;padding:12px 4px 8px;
  border:none;background:none;color:rgba(255,255,255,0.38);
  cursor:pointer;font-family:'DM Sans',sans-serif;
  font-size:0.65rem;font-weight:500;letter-spacing:0.3px;
  transition:color 0.2s;-webkit-tap-highlight-color:transparent;
  min-height:52px;touch-action:manipulation;
}
.t-icon{font-size:1.35rem;line-height:1;transition:transform 0.2s;display:block;}
.tab-btn.active{color:#fff;}
.tab-btn.active .t-icon{transform:translateY(-2px);}
.tab-btn::after{
  content:'';display:block;width:22px;height:3px;
  border-radius:2px;background:var(--red);
  opacity:0;transform:scaleX(0);
  transition:opacity 0.2s,transform 0.2s;margin-top:2px;
}
.tab-btn.active::after{opacity:1;transform:scaleX(1);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS (bottom-sheet style)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-bd{
  position:fixed;inset:0;background:rgba(0,0,0,0.7);
  z-index:500;display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;
  transition:opacity 0.3s;
  backdrop-filter:blur(4px);
}
.modal-bd.open{opacity:1;pointer-events:all;}
.modal-sh{
  width:100%;max-width:520px;
  background:#111a28;
  border:1px solid var(--glass-b);
  border-radius:28px 28px 0 0;
  padding:12px 26px calc(var(--sab)+32px);
  transform:translateY(30px);
  transition:transform 0.35s cubic-bezier(0.34,1.2,0.64,1);
}
.modal-bd.open .modal-sh{transform:translateY(0);}
.modal-handle{width:40px;height:4px;background:rgba(255,255,255,0.15);border-radius:2px;margin:0 auto 22px;}
.modal-title{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;margin-bottom:5px;}
.modal-sub{font-size:0.78rem;color:var(--dim);margin-bottom:20px;line-height:1.5;}
.modal-field{margin-bottom:14px;}
.modal-field label{
  display:block;font-size:0.67rem;letter-spacing:0.14em;
  text-transform:uppercase;color:var(--dim);margin-bottom:7px;
}
.modal-field input{
  width:100%;padding:13px 14px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:11px;color:#fff;
  font-family:'DM Sans',sans-serif;font-size:1rem;
  outline:none;transition:border-color 0.2s;
  -webkit-appearance:none;
}
.modal-field input:focus{border-color:var(--red);}
.modal-field input::placeholder{color:var(--dim);}
.modal-err{font-size:0.78rem;color:#ff6b6b;min-height:18px;margin-bottom:10px;}
.modal-btns{display:flex;gap:10px;}
.modal-btns .btn-primary{flex:1;}
.btn-cancel{
  padding:14px 18px;
  background:rgba(255,255,255,0.07);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:11px;color:var(--dim);
  font-family:'DM Sans',sans-serif;font-size:0.88rem;
  cursor:pointer;touch-action:manipulation;
}

/* Destination preview */
.dest-prev{width:100%;height:110px;border-radius:11px;overflow:hidden;margin-bottom:14px;display:none;position:relative;}
.dest-prev img{width:100%;height:100%;object-fit:cover;}
.dest-prev-lbl{position:absolute;bottom:0;left:0;right:0;padding:7px 11px;background:linear-gradient(transparent,rgba(10,10,26,0.8));font-size:0.72rem;color:rgba(255,255,255,0.8);}

/* Toast */
.toast{
  position:fixed;bottom:calc(var(--sab)+88px);left:50%;
  transform:translateX(-50%) translateY(16px);
  background:#1a2f45;border:1px solid var(--glass-b);
  border-radius:30px;padding:9px 20px;
  font-size:0.8rem;color:var(--sand);z-index:800;
  opacity:0;transition:opacity 0.2s,transform 0.2s;
  white-space:nowrap;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* Travelers in settings (coloured avatars, no rename) */
.trav-row{
  display:flex;align-items:center;gap:12px;
  padding:12px 14px;
  background:rgba(255,255,255,0.05);border-radius:10px;margin-bottom:8px;
}
.trav-av{
  width:36px;height:36px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:600;font-size:0.82rem;color:#0a0a1a;flex-shrink:0;
}
.trav-info{flex:1;}
.trav-name{font-size:0.9rem;font-weight:500;}
.trav-role{font-size:0.7rem;color:var(--dim);text-transform:uppercase;letter-spacing:0.08em;margin-top:2px;}
.trav-badge{padding:3px 9px;border-radius:20px;font-size:0.63rem;letter-spacing:0.1em;text-transform:uppercase;font-weight:500;}
.b-owner{background:rgba(220,20,60,0.2);color:var(--red);}
.b-traveler{background:rgba(39,174,96,0.15);color:#6fcf97;}

@media(min-width:600px){
  .modal-bd{align-items:center;}
  .modal-sh{border-radius:24px;padding-bottom:28px;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â‘  AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-auth" class="screen active">
  <div class="auth-bg-word">Allabroad</div>
  <div class="auth-logo">All<span>abroad</span></div>
  <div class="auth-tag">Plan together. Travel further.</div>
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="setAuthTab('login')">Sign In</button>
      <button class="auth-tab" onclick="setAuthTab('signup')">Sign Up</button>
    </div>
    <div id="auth-login">
      <div class="auth-field"><label>Username</label>
        <input type="text" id="li-user" placeholder="your username" autocomplete="username"></div>
      <div class="auth-field"><label>Password</label>
        <input type="password" id="li-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"
          onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div class="auth-err" id="li-err"></div>
      <button class="btn-primary" onclick="doLogin()">Sign In â†’</button>
    </div>
    <div id="auth-signup" style="display:none">
      <div class="auth-field"><label>Username</label>
        <input type="text" id="su-user" placeholder="at least 3 characters" autocomplete="username"></div>
      <div class="auth-field"><label>Password</label>
        <input type="password" id="su-pass" placeholder="min 6 characters" autocomplete="new-password"></div>
      <div class="auth-field"><label>Confirm Password</label>
        <input type="password" id="su-pass2" placeholder="repeat password" autocomplete="new-password"
          onkeydown="if(event.key==='Enter')doSignup()"></div>
      <div class="auth-err" id="su-err"></div>
      <button class="btn-primary" onclick="doSignup()">Create Account â†’</button>
    </div>
    <div class="auth-or">â€” or â€”</div>
    <button class="btn-ghost" onclick="doGuest()">Continue as Guest</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â‘¡ DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-dash" class="screen">
  <div class="dash-head">
    <div class="dash-topbar">
      <div class="dash-logo">All<span>abroad</span></div>
      <div class="dash-user-row">
        <button class="dash-signout" onclick="doLogout()">Sign out</button>
        <div class="dash-avatar" id="dash-av">?</div>
      </div>
    </div>
    <div class="dash-greeting">Good <em id="dash-tod">day</em>,<br><span id="dash-uname">Traveller</span></div>
    <div class="dash-sub">âœ¦ Ready to explore</div>
    <div class="dash-actions">
      <button class="btn-new" onclick="openNewTrip()"><span style="font-size:1.2rem;font-weight:300;">+</span> New Trip</button>
      <button class="btn-join" onclick="openJoinTrip()">ğŸ”— Join Trip</button>
    </div>
  </div>
  <div class="dash-lbl" id="dash-lbl">Your Trips</div>
  <div class="trips-scroll" id="trips-list"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â‘¢ TRIP INTERIOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-trip" class="screen">
  <div class="trip-bg" id="tripBg"></div>
  <div class="airplane">âœˆï¸</div>

  <!-- Countdown bar (with back button) -->
  <div id="cdBar">
    <button id="btnBackToTrips" onclick="goToDash()">â† Trips</button>
    <div class="cd-cell" id="cdDaysCell"><span class="cd-num" id="cdDays">--</span><span class="cd-lbl">Days</span></div>
    <span class="cd-sep">:</span>
    <div class="cd-cell" id="cdHoursCell"><span class="cd-num" id="cdHours">--</span><span class="cd-lbl">Hours</span></div>
    <span class="cd-sep">:</span>
    <div class="cd-cell" id="cdMinsCell"><span class="cd-num" id="cdMins">--</span><span class="cd-lbl">Mins</span></div>
    <div id="arrivedPill">ğŸ‰ You're there!</div>
  </div>

  <!-- Scrollable content -->
  <div class="scroll-wrap">

    <!-- Trip heading -->
    <div class="trip-hdr">
      <h1 id="tripTitle">Destination<span>.</span></h1>
      <p class="trip-hdr-sub" id="tripSubtitle">Dates TBD</p>
    </div>

    <!-- Weather + sync strip -->
    <div class="glass" style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;">
      <div>
        <div id="tripTemp" style="font-size:1.4rem;font-weight:700;">--Â°C</div>
        <div id="tripSky"  style="font-size:0.78rem;opacity:0.6;margin-top:2px;">Loading weatherâ€¦</div>
      </div>
      <div style="text-align:right;">
        <div id="syncStatus" style="display:none;">Ready</div>
        <div style="font-size:0.7rem;opacity:0.4;margin-top:2px;" id="tripCodeStrip"></div>
      </div>
    </div>

    <!-- Tab panels -->
    <div class="tabs-vp">
      <div class="tabs-sl" id="tabsSlider">

        <!-- TAB 0: PREP -->
        <div class="tab-pnl">
          <div class="glass" style="padding:12px 16px;margin-bottom:14px;">
            <div style="font-size:0.72rem;opacity:0.5;letter-spacing:1px;text-transform:uppercase;margin-bottom:9px;">Viewing lists for</div>
            <div class="day-tabs" id="travelerTabs" style="margin-bottom:0;"></div>
          </div>
          <div class="glass">
            <h3 style="margin-bottom:14px;">ğŸ›ï¸ Buy Before Trip</h3>
            <div class="input-row">
              <input type="text" id="shopInput" placeholder="Add itemâ€¦" onkeydown="if(event.key==='Enter')addItem('shopping','shopInput')">
              <button class="btn btn-red" onclick="addItem('shopping','shopInput')">Add</button>
            </div>
            <div id="shopList"></div>
          </div>
          <div class="glass">
            <h3 style="margin-bottom:14px;">ğŸ“¦ Packing List</h3>
            <div class="input-row">
              <input type="text" id="packInput" placeholder="Add itemâ€¦" onkeydown="if(event.key==='Enter')addItem('packing','packInput')">
              <button class="btn btn-red" onclick="addItem('packing','packInput')">Add</button>
            </div>
            <div id="packList"></div>
          </div>
          <div class="glass">
            <h3 style="margin-bottom:14px;">ğŸ—ºï¸ Shopping There</h3>
            <div class="input-row">
              <input type="text" id="ukShopInput" placeholder="Add itemâ€¦" onkeydown="if(event.key==='Enter')addItem('ukShopping','ukShopInput')">
              <button class="btn btn-red" onclick="addItem('ukShopping','ukShopInput')">Add</button>
            </div>
            <div id="ukShopList"></div>
          </div>
          <div class="glass">
            <div class="sec-hdr">
              <h3>ğŸ“ Shared Notes</h3>
              <span id="notesSavedLabel" class="notes-ok"></span>
            </div>
            <textarea id="notesArea" placeholder="Hotel confirmations, addresses, things to rememberâ€¦"></textarea>
            <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
              <button class="btn btn-red" onclick="saveNotes()">Save Notes</button>
              <span style="font-size:0.8rem;opacity:0.4;">Syncs to all devices</span>
            </div>
          </div>
        </div>

        <!-- TAB 1: TRIP -->
        <div class="tab-pnl">
          <div class="glass">
            <div class="sec-hdr">
              <h3>ğŸ—“ï¸ Itinerary</h3>
              <button class="btn btn-sm btn-red" onclick="showAddEvent()">+ Add</button>
            </div>
            <div class="day-tabs" id="dayTabs"></div>
            <div id="itineraryList"></div>
            <div class="ev-form" id="eventForm">
              <div style="font-size:0.85rem;font-weight:600;margin-bottom:10px;opacity:0.7;" id="evFormTitle">Add Event</div>
              <div class="input-row">
                <select id="evDay" style="flex:0 0 auto;max-width:108px;"></select>
                <input type="time" id="evTime" style="flex:0 0 108px;">
                <input type="text" id="evTitle" placeholder="Event title" onkeydown="if(event.key==='Enter')saveEvent()">
              </div>
              <div class="input-row">
                <input type="text" id="evNote" placeholder="Note (optional)" onkeydown="if(event.key==='Enter')saveEvent()">
              </div>
              <div style="display:flex;gap:8px;">
                <button class="btn btn-red" id="evSaveBtn" onclick="saveEvent()">Save Event</button>
                <button class="btn btn-glass" onclick="cancelEvent()">Cancel</button>
              </div>
            </div>
          </div>
          <div class="glass">
            <h3 style="margin-bottom:14px;">ğŸŸï¸ Ticket Vault</h3>
            <div class="input-row">
              <input type="text" id="ticketName" placeholder="Ticket nameâ€¦" onkeydown="if(event.key==='Enter')addTicket()">
              <input type="file" id="ticketFile" accept="image/*" style="display:none" onchange="processImage(this,'ticket')">
              <button class="btn btn-glass btn-icon" onclick="document.getElementById('ticketFile').click()">ğŸ“·</button>
              <button class="btn btn-red" onclick="addTicket()">Save</button>
            </div>
            <div class="photo-preview" id="photoPreview">
              <img id="previewImg" style="height:52px;border-radius:7px;border:1px solid var(--glass-b);" alt="">
              <span style="flex:1;font-size:0.85rem;opacity:0.8;">Photo ready âœ…</span>
              <button onclick="clearTicketPhoto()" class="del-btn">âœ•</button>
            </div>
            <div id="ticketList"></div>
          </div>
        </div>

        <!-- TAB 2: MEMORIES -->
        <div class="tab-pnl">
          <div class="glass">
            <div class="sec-hdr">
              <h3>ğŸ“¸ Memories</h3>
              <input type="file" id="memFile" accept="image/*" style="display:none" onchange="processImage(this,'memory')">
              <button class="btn btn-sm btn-red" onclick="document.getElementById('memFile').click()">+ Photo</button>
            </div>
            <div class="mem-preview" id="memPreviewRow">
              <img id="memPreviewImg" style="height:70px;border-radius:8px;border:1px solid var(--glass-b);display:block;margin-bottom:10px;" alt="">
              <div class="input-row" style="margin-bottom:0;">
                <input type="text" id="memCaption" placeholder="Caption (optional)" onkeydown="if(event.key==='Enter')addMemory()">
                <button class="btn btn-red" onclick="addMemory()">Add</button>
                <button class="btn btn-glass" onclick="cancelMemory()">âœ•</button>
              </div>
            </div>
            <div id="memoriesGrid" class="mem-grid"></div>
          </div>
        </div>

        <!-- TAB 3: SETTINGS -->
        <div class="tab-pnl">

          <!-- Sync status pill â€” no user-facing Dropbox config needed -->
          <div class="glass" style="padding:14px 18px;display:flex;align-items:center;justify-content:space-between;">
            <div style="font-size:0.85rem;font-weight:600;">Cloud Sync</div>
            <div style="display:flex;align-items:center;gap:8px;">
              <div id="syncDot" style="width:8px;height:8px;border-radius:50%;background:#4caf50;box-shadow:0 0 6px #4caf50;"></div>
              <div id="syncStatus" style="font-size:0.8rem;color:#4caf50;">Connected</div>
              <button class="btn btn-glass btn-icon" onclick="syncFromCloud()" title="Sync now" style="padding:6px 10px;font-size:0.85rem;">ğŸ”„</button>
            </div>
          </div>

          <!-- Travelers â€” read-only view (Allabroad handles adding via join codes) -->
          <div class="glass" style="padding:14px 18px;">
            <div style="font-size:0.85rem;font-weight:600;margin-bottom:3px;">ğŸ‘¥ Travelers</div>
            <div style="font-size:0.72rem;opacity:0.5;margin-bottom:12px;">Share the join code to invite others. Each person gets their own prep lists.</div>
            <div id="travelerSettingsList"></div>
            <div style="margin-top:10px;padding:10px 14px;background:rgba(220,20,60,0.08);border:1px solid rgba(220,20,60,0.2);border-radius:10px;font-size:0.8rem;display:flex;align-items:center;justify-content:space-between;">
              <span style="color:var(--dim);">Join code:</span>
              <span id="settingsCodeDisplay" style="font-weight:600;letter-spacing:0.15em;color:var(--sand);cursor:pointer;" onclick="copyTripCode()">â€”â€”</span>
            </div>
          </div>

          <!-- Notifications -->
          <div class="glass" style="padding:14px 18px;">
            <div style="font-size:0.85rem;font-weight:600;margin-bottom:6px;">ğŸ”” Notifications</div>
            <div style="font-size:0.78rem;opacity:0.55;margin-bottom:12px;">Get a morning alert each day counting down to your trip.</div>
            <button class="btn btn-glass" style="width:100%;" onclick="requestNotifPermission()">Enable Morning Alerts</button>
            <div id="notifStatus" style="font-size:0.75rem;opacity:0.5;margin-top:8px;text-align:center;">Alerts: Off</div>
          </div>

          <!-- Danger zone -->
          <div class="glass" style="padding:14px 18px;">
            <div style="font-size:0.85rem;font-weight:600;margin-bottom:6px;">âš ï¸ Danger Zone</div>
            <div style="font-size:0.78rem;opacity:0.55;margin-bottom:12px;">Wipe this trip's data and start fresh on all devices.</div>
            <button class="btn btn-glass" style="width:100%;border-color:rgba(220,20,60,0.4);color:rgba(255,100,100,0.85);" onclick="resetApp()">ğŸ—‘ï¸ Reset Trip Data</button>
          </div>

        </div>
      </div><!-- /tabs-sl -->
    </div><!-- /tabs-vp -->


  </div><!-- /scroll-wrap -->

  <!-- Bottom tab bar -->
  <nav class="tab-bar" id="tripTabBar">
    <button class="tab-btn active" id="tab-0" onclick="switchTab(0)"><span class="t-icon">âœˆï¸</span>Prep</button>
    <button class="tab-btn" id="tab-1" onclick="switchTab(1)"><span class="t-icon">ğŸ—“ï¸</span>Trip</button>
    <button class="tab-btn" id="tab-2" onclick="switchTab(2)"><span class="t-icon">ğŸ“¸</span>Memories</button>
    <button class="tab-btn" id="tab-3" onclick="switchTab(3)"><span class="t-icon">âš™ï¸</span>Settings</button>
  </nav>
</div>

<!-- Fullscreen image modal -->
<div class="img-modal" id="imgModal" onclick="closeImgModal()">
  <img id="fullImg" alt="Full size">
  <span class="img-modal-x">âœ• Tap to close</span>
</div>

<!-- Dashboard modals -->
<div class="modal-bd" id="md-new-trip">
  <div class="modal-sh">
    <div class="modal-handle"></div>
    <div class="modal-title">New Trip</div>
    <div class="modal-sub">Where to? We'll pick a photo and generate a join code automatically.</div>
    <div class="dest-prev" id="dest-prev"><img id="dest-prev-img" src="" alt=""><div class="dest-prev-lbl" id="dest-prev-lbl"></div></div>
    <div class="modal-field"><label>Destination</label>
      <input type="text" id="nd-dest" placeholder="e.g. Tokyo, Amalfi Coast, Maldives" oninput="onDestInput(this.value)" onkeydown="if(event.key==='Enter')document.getElementById('nd-dates').focus()"></div>
    <div class="modal-field"><label>Travel Dates</label>
      <input type="text" id="nd-dates" placeholder="e.g. June 12â€“20, 2026"></div>
    <div class="modal-err" id="nd-err"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeMd('md-new-trip')">Cancel</button>
      <button class="btn-primary" onclick="createTrip()">Create Trip â†’</button>
    </div>
  </div>
</div>

<div class="modal-bd" id="md-join-trip">
  <div class="modal-sh">
    <div class="modal-handle"></div>
    <div class="modal-title">Join a Trip</div>
    <div class="modal-sub">Enter the 6-character code shared by your trip organiser.</div>
    <div class="modal-field"><label>Join Code</label>
      <input type="text" id="jt-code" placeholder="e.g. AX7K9M" maxlength="6"
        style="text-transform:uppercase;letter-spacing:0.2em;font-size:1.1rem;text-align:center;"
        onkeydown="if(event.key==='Enter')joinTrip()"></div>
    <div class="modal-err" id="jt-err"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeMd('md-join-trip')">Cancel</button>
      <button class="btn-primary" onclick="joinTrip()">Join â†’</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALLABROAD DB â€” localStorage, keyed per trip
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WAND_KEY = 'allabroad_v2';
function wDB()  { try{return JSON.parse(localStorage.getItem(WAND_KEY))||{users:{},trips:{}};}catch{return{users:{},trips:{}};} }
function wSave(db){ try{localStorage.setItem(WAND_KEY,JSON.stringify(db));}catch(e){} }

// Auth session
let CU = null; // current user object {username}
try{ CU = JSON.parse(sessionStorage.getItem('allabroad_cu')); }catch{}

// Currently open trip id
let openTripId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DESTINATION PHOTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEST_PHOTOS = {
  tokyo:     'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=1600&q=80',
  japan:     'https://images.unsplash.com/photo-1528360983277-13d401cdc186?w=1600&q=80',
  paris:     'https://images.unsplash.com/photo-1499856871958-5b9627545d1a?w=1600&q=80',
  france:    'https://images.unsplash.com/photo-1431274172761-fca41d930114?w=1600&q=80',
  london:    'https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=1600&q=80',
  uk:        'https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=1600&q=80',
  rome:      'https://images.unsplash.com/photo-1552832230-c0197dd311b5?w=1600&q=80',
  italy:     'https://images.unsplash.com/photo-1555992336-03a23c7b20ee?w=1600&q=80',
  amalfi:    'https://images.unsplash.com/photo-1533587851505-d119e13fa0d7?w=1600&q=80',
  barcelona: 'https://images.unsplash.com/photo-1511527661048-7fe73d85e9a4?w=1600&q=80',
  spain:     'https://images.unsplash.com/photo-1543783207-ec64e4d95325?w=1600&q=80',
  bali:      'https://images.unsplash.com/photo-1537996194471-e657df975ab4?w=1600&q=80',
  maldives:  'https://images.unsplash.com/photo-1514282401047-d79a71a590e8?w=1600&q=80',
  dubai:     'https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=1600&q=80',
  iceland:   'https://images.unsplash.com/photo-1476610182048-b716b8518aae?w=1600&q=80',
  patagonia: 'https://images.unsplash.com/photo-1508193638397-1c4234db14d8?w=1600&q=80',
  morocco:   'https://images.unsplash.com/photo-1539020140153-e479b8c22e70?w=1600&q=80',
  amsterdam: 'https://images.unsplash.com/photo-1534351590666-13e3e96b5017?w=1600&q=80',
  bangkok:   'https://images.unsplash.com/photo-1508009603885-50cf7c8dd0d5?w=1600&q=80',
  thailand:  'https://images.unsplash.com/photo-1552465011-b4e21bf6e79a?w=1600&q=80',
  sydney:    'https://images.unsplash.com/photo-1524293581917-878a6d017c71?w=1600&q=80',
  australia: 'https://images.unsplash.com/photo-1494233892892-84542a694e72?w=1600&q=80',
  newyork:   'https://images.unsplash.com/photo-1496442226666-8d4d0e62e6e9?w=1600&q=80',
  nyc:       'https://images.unsplash.com/photo-1496442226666-8d4d0e62e6e9?w=1600&q=80',
  santorini: 'https://images.unsplash.com/photo-1570077188670-e3a8d69ac5ff?w=1600&q=80',
  greece:    'https://images.unsplash.com/photo-1533105079780-92b9be482077?w=1600&q=80',
  lisbon:    'https://images.unsplash.com/photo-1555881400-74d7acaacd8b?w=1600&q=80',
  prague:    'https://images.unsplash.com/photo-1540932239986-30128078f3c5?w=1600&q=80',
  singapore: 'https://images.unsplash.com/photo-1525625293386-3f8f99389edd?w=1600&q=80',
  default:   'https://images.unsplash.com/photo-1488085061387-422e29b40080?w=1600&q=80'
};

function getPhoto(dest){
  if(!dest) return DEST_PHOTOS.default;
  const k = dest.toLowerCase().replace(/[\s,.-]/g,'');
  for(const [kw,url] of Object.entries(DEST_PHOTOS)){
    if(kw==='default') continue;
    if(k.includes(kw)) return url;
  }
  return DEST_PHOTOS.default;
}

// Avatar colours
const AV_COLS = ['#c8a96e','#6fcf97','#56aef7','#e88c6a','#b39ddb','#80cbc4','#f48fb1','#ffe082'];
function avColor(u){ let h=0; for(let i=0;i<u.length;i++) h=(h*31+u.charCodeAt(i))&0xff; return AV_COLS[h%AV_COLS.length]; }
function initials(u){ return u.slice(0,2).toUpperCase(); }
function timeWord(){ const h=new Date().getHours(); return h<12?'morning':h<17?'afternoon':'evening'; }
function genCode(){ const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<6;i++) s+=c[Math.floor(Math.random()*c.length)]; return s; }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('s-'+id).classList.add('active');
}
function goToDash(){
  openTripId=null;
  clearInterval(cdInterval);
  renderDashboard();
  showScreen('dash');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setAuthTab(t){
  document.querySelectorAll('.auth-tab').forEach((b,i)=>b.classList.toggle('active',(i===0&&t==='login')||(i===1&&t==='signup')));
  document.getElementById('auth-login').style.display  = t==='login' ?'':'none';
  document.getElementById('auth-signup').style.display = t==='signup'?'':'none';
}
function doLogin(){
  const db=wDB(), u=document.getElementById('li-user').value.trim().toLowerCase(), p=document.getElementById('li-pass').value;
  const err=document.getElementById('li-err');
  if(!u||!p){err.textContent='Please fill in all fields.';return;}
  if(!db.users[u]){err.textContent='No account found.';return;}
  if(db.users[u].password!==btoa(p)){err.textContent='Incorrect password.';return;}
  err.textContent='';
  CU={username:u}; sessionStorage.setItem('allabroad_cu',JSON.stringify(CU));
  renderDashboard(); showScreen('dash');
}
function doSignup(){
  const db=wDB(), u=document.getElementById('su-user').value.trim().toLowerCase(),
        p=document.getElementById('su-pass').value, p2=document.getElementById('su-pass2').value;
  const err=document.getElementById('su-err');
  if(!u||!p){err.textContent='Please fill in all fields.';return;}
  if(u.length<3){err.textContent='Username must be at least 3 characters.';return;}
  if(p.length<6){err.textContent='Password must be at least 6 characters.';return;}
  if(p!==p2){err.textContent='Passwords do not match.';return;}
  if(db.users[u]){err.textContent='Username already taken.';return;}
  db.users[u]={password:btoa(p),createdAt:Date.now()}; wSave(db);
  err.textContent='';
  CU={username:u}; sessionStorage.setItem('allabroad_cu',JSON.stringify(CU));
  renderDashboard(); showScreen('dash');
}
function doGuest(){
  const db=wDB();
  if(!db.users['guest']) db.users['guest']={password:'',createdAt:Date.now()};
  // Seed demo trip for guest if none
  const existing = Object.values(db.trips).find(t=>t.code==='DEMO01');
  if(!existing){
    const photo = getPhoto('london');
    db.trips['demo-london']={
      id:'demo-london', destination:'London', dates:'May 11â€“15, 2026',
      travelDate:'2026-05-11T15:00:00', tripDays:['May 11','May 12','May 13','May 14','May 15'],
      code:'DEMO01', photo, owner:'guest',
      travelers:[{username:'guest',role:'owner',joinedAt:Date.now()}],
      // Trip-specific state
      state:{itinerary:[
        {id:1,day:0,time:'15:00',title:'Land at Heathrow',note:'Terminal 5'},
        {id:2,day:0,time:'18:00',title:'Check in â€” Hotel',note:'St Pancras Renaissance'},
        {id:3,day:1,time:'09:00',title:'Borough Market',note:'Breakfast & local produce'},
        {id:4,day:1,time:'14:00',title:'Tower of London',note:'Book skip-the-line tickets'},
        {id:5,day:2,time:'10:00',title:'Notting Hill walk',note:'Portobello Road market'},
      ],notes:'Remember to get an Oyster card at the airport!\nLooks like it may rain â€” pack a light jacket.',memories:[]},
      tickets:[], deletedIds:[], deletedTravelers:[],
      personLists:{guest:{shopping:[{id:100,name:'Travel adapter',checked:false}],packing:[{id:101,name:'Passport',checked:false},{id:102,name:'Umbrella',checked:false}],ukShopping:[],shoppingDeleted:[]}},
      createdAt:Date.now()
    };
    wSave(db);
  }
  CU={username:'guest'}; sessionStorage.setItem('allabroad_cu',JSON.stringify(CU));
  renderDashboard(); showScreen('dash');
}
function doLogout(){
  CU=null; openTripId=null;
  clearInterval(cdInterval);
  sessionStorage.removeItem('allabroad_cu');
  showScreen('auth');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  if(!CU) return;
  const db=wDB(), u=CU.username;
  document.getElementById('dash-tod').textContent   = timeWord();
  document.getElementById('dash-uname').textContent = u.charAt(0).toUpperCase()+u.slice(1);
  const av=document.getElementById('dash-av');
  av.textContent=initials(u);
  av.style.background=`linear-gradient(135deg,${avColor(u)},${avColor(u+'x')})`;

  const mine = Object.values(db.trips)
    .filter(t=>t.travelers&&t.travelers.some(tr=>tr.username===u))
    .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  document.getElementById('dash-lbl').textContent = mine.length?`Your Trips (${mine.length})`:'Your Trips';
  const list=document.getElementById('trips-list');
  if(!mine.length){
    list.innerHTML=`<div class="dash-empty"><div class="dash-empty-icon">ğŸŒ</div><div class="dash-empty-ttl">No trips yet</div><div class="dash-empty-sub">Tap <strong>+ New Trip</strong> to start planning</div></div>`;
    return;
  }
  list.innerHTML = mine.map((trip,i)=>{
    const isOwner=trip.owner===u, tc=trip.travelers?.length||1;
    return `<div class="trip-card" onclick="openTrip('${trip.id}')" style="animation:fadeUp 0.35s ${i*0.06}s ease both;">
      <div class="tc-bg" style="background-image:url('${trip.photo||getPhoto(trip.destination)}')"></div>
      <div class="tc-ov"></div>
      <div class="tc-code">${trip.code}</div>
      <div class="tc-body">
        <div class="tc-badge">${isOwner?'âœ¦ Organiser':'âœˆ Traveler'}</div>
        <div class="tc-dest">${esc(trip.destination)}</div>
        <div class="tc-meta"><span>ğŸ“… ${esc(trip.dates||'Dates TBD')}</span><span>ğŸ‘¥ ${tc} ${tc===1?'person':'people'}</span></div>
      </div>
    </div>`;
  }).join('');
}
// Inject fadeUp keyframe
document.head.insertAdjacentHTML('beforeend',`<style>@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:none}}</style>`);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW TRIP / JOIN TRIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNewTrip(){
  document.getElementById('nd-dest').value='';
  document.getElementById('nd-dates').value='';
  document.getElementById('nd-err').textContent='';
  document.getElementById('dest-prev').style.display='none';
  openMd('md-new-trip');
  setTimeout(()=>document.getElementById('nd-dest').focus(),400);
}
let destDebounce=null;
function onDestInput(val){
  clearTimeout(destDebounce);
  destDebounce=setTimeout(()=>{
    const prev=document.getElementById('dest-prev');
    if(val.trim().length>2){
      const url=getPhoto(val);
      document.getElementById('dest-prev-img').src=url;
      document.getElementById('dest-prev-lbl').textContent=val;
      prev.style.display='block';
    }else prev.style.display='none';
  },350);
}
function createTrip(){
  const dest=document.getElementById('nd-dest').value.trim();
  const dates=document.getElementById('nd-dates').value.trim();
  const err=document.getElementById('nd-err');
  if(!dest){err.textContent='Please enter a destination.';return;}
  const db=wDB(), id='trip-'+Date.now(), code=genCode();
  // Parse a travel date from the dates field if possible
  let travelDate = null;
  const m = dates.match(/(\d{1,2})[\/\-\s](\w+)[\/\-\s]?(\d{4})?/);
  if(m) travelDate = dates; // store raw string for countdown parsing

  db.trips[id]={
    id, destination:dest, dates, code,
    photo:getPhoto(dest), owner:CU.username,
    travelers:[{username:CU.username,role:'owner',joinedAt:Date.now()}],
    travelDate: parseTravelDate(dates),
    tripDays: buildTripDays(dates),
    state:{itinerary:[],notes:'',memories:[]},
    tickets:[],deletedIds:[],deletedTravelers:[],
    personLists:{},
    createdAt:Date.now()
  };
  // Create prep lists for owner
  db.trips[id].personLists[CU.username]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};
  wSave(db);
  closeMd('md-new-trip');
  renderDashboard();
  setTimeout(()=>openTrip(id),200);
}

function parseTravelDate(dates){
  // Try to extract an ISO date from strings like "June 12â€“20, 2026" or "12 June 2026"
  if(!dates) return null;
  const months={january:1,february:2,march:3,april:4,may:5,june:6,july:7,august:8,september:9,october:10,november:11,december:12,
    jan:1,feb:2,mar:3,apr:4,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
  const d=dates.toLowerCase();
  for(const [mn,mo] of Object.entries(months)){
    const re=new RegExp(mn+'[\\s]+([\\d]+)[^\\d]*(\\d{4})?','i');
    const m=d.match(re)||d.match(new RegExp('([\\d]+)[^\\d]*'+mn+'[^\\d]*(\\d{4})?','i'));
    if(m){
      const day=parseInt(m[1]||m[2]||1);
      const yr=parseInt(m[3]||m[2]||new Date().getFullYear());
      return new Date(yr,mo-1,day,12,0,0).toISOString();
    }
  }
  return null;
}
function buildTripDays(dates){
  // Generate day labels from "June 12â€“20, 2026" style
  if(!dates) return ['Day 1','Day 2','Day 3','Day 4','Day 5'];
  const m=dates.match(/(\d+)[â€“\-â€”to]+(\d+)/);
  if(!m) return ['Day 1','Day 2','Day 3','Day 4','Day 5'];
  const start=parseInt(m[1]),end=parseInt(m[2]);
  const len=Math.min(end-start+1,14);
  // Try to get month
  const months={jan:'Jan',feb:'Feb',mar:'Mar',apr:'Apr',may:'May',jun:'Jun',jul:'Jul',aug:'Aug',sep:'Sep',oct:'Oct',nov:'Nov',dec:'Dec'};
  let prefix='';
  for(const [k,v] of Object.entries(months)){ if(dates.toLowerCase().includes(k)){prefix=v+' ';break;} }
  return Array.from({length:len>0?len:5},(_, i)=>prefix?(prefix+(start+i)):'Day '+(i+1));
}

function openJoinTrip(){
  document.getElementById('jt-code').value='';
  document.getElementById('jt-err').textContent='';
  openMd('md-join-trip');
  setTimeout(()=>document.getElementById('jt-code').focus(),400);
}
function joinTrip(){
  const code=document.getElementById('jt-code').value.trim().toUpperCase();
  const err=document.getElementById('jt-err');
  if(code.length<4){err.textContent='Please enter a valid code.';return;}
  const db=wDB();
  const trip=Object.values(db.trips).find(t=>t.code===code);
  if(!trip){err.textContent='No trip found with that code.';return;}
  const alreadyIn=trip.travelers?.some(t=>t.username===CU.username);
  if(alreadyIn){err.textContent="You're already in this trip!";return;}
  if(!trip.travelers) trip.travelers=[];
  trip.travelers.push({username:CU.username,role:'traveler',joinedAt:Date.now()});
  // Create their prep list
  if(!trip.personLists) trip.personLists={};
  if(!trip.personLists[CU.username]) trip.personLists[CU.username]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};
  wSave(db);
  closeMd('md-join-trip');
  showToast(`Joined "${trip.destination}"! ğŸ‰`);
  renderDashboard();
  setTimeout(()=>openTrip(trip.id),600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRIP INTERIOR â€” load trip into London-app engine
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// All trip-engine state lives here, loaded fresh each time a trip opens
let TRIP=null; // current trip object from wDB
let TRIP_DAYS=[];
let TRAVEL_DATE=null;
let travelers=[], personLists={}, state={itinerary:[],notes:'',memories:[]};
let tickets=[], deletedIds=[], deletedTravelers=[], tempImg=null;
let activeTraveler=null, activeDay=0, currentTab=0, confettiFired=false;
let syncing=false, syncTimer=null, cdInterval=null;

function openTrip(id){
  const db=wDB();
  TRIP=db.trips[id];
  if(!TRIP) return;
  openTripId=id;

  // Load trip state into engine vars
  TRIP_DAYS  = TRIP.tripDays||['Day 1','Day 2','Day 3','Day 4','Day 5'];
  TRAVEL_DATE= TRIP.travelDate ? new Date(TRIP.travelDate).getTime() : null;
  travelers  = TRIP.travelers||[{username:CU.username,role:'owner',joinedAt:Date.now()}];
  personLists= TRIP.personLists||{};
  state      = TRIP.state||{itinerary:[],notes:'',memories:[]};
  tickets    = TRIP.tickets||[];
  deletedIds = TRIP.deletedIds||[];
  deletedTravelers=TRIP.deletedTravelers||[];
  tempImg    = null;
  activeDay  = 0; currentTab=0; confettiFired=false;

  // Ensure current user has a traveler entry + prep list
  if(!travelers.find(t=>t.username===CU.username)){
    travelers.push({username:CU.username,role:'traveler',joinedAt:Date.now()});
  }
  activeTraveler=CU.username;
  if(!personLists[activeTraveler]) personLists[activeTraveler]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};

  // Update UI
  document.getElementById('tripBg').style.backgroundImage=`url('${TRIP.photo||getPhoto(TRIP.destination)}')`;
  document.getElementById('tripTitle').innerHTML=esc(TRIP.destination)+'<span>.</span>';
  document.getElementById('tripSubtitle').textContent=TRIP.dates||'';
  document.getElementById('tripCodeStrip').textContent='Code: '+TRIP.code;
  document.getElementById('settingsCodeDisplay').textContent=TRIP.code;

  // Reset tabs & slider
  switchTab(0,true);
  document.getElementById('tabsSlider').style.transform='translateX(0)';

  // Render everything
  buildDayTabs(); renderItinerary(); renderNotes();
  renderTravelerTabs(); renderTravelerSettings();
  renderTickets(); renderMemories();

  // Countdown
  clearInterval(cdInterval);
  if(TRAVEL_DATE){ checkArrived(); updateCD(); cdInterval=setInterval(updateCD,1000); }
  else { document.getElementById('cdDays').textContent='--'; document.getElementById('cdHours').textContent='--'; document.getElementById('cdMins').textContent='--'; }

  // Weather â€” fetch for destination
  fetchWeather(TRIP.destination);
  showScreen('trip');
}

// Persist trip state back to wDB
function saveTripLocal(){
  if(!openTripId) return;
  const db=wDB();
  if(!db.trips[openTripId]) return;
  db.trips[openTripId].state      = state;
  db.trips[openTripId].tickets    = tickets;
  db.trips[openTripId].deletedIds = deletedIds;
  db.trips[openTripId].deletedTravelers=deletedTravelers;
  db.trips[openTripId].travelers  = travelers;
  db.trips[openTripId].personLists= personLists;
  wSave(db);
  TRIP=db.trips[openTripId];
}
function saveAndSync(){ saveTripLocal(); render(); setStatus('â˜ï¸ Pendingâ€¦'); clearTimeout(syncTimer); syncTimer=setTimeout(syncToCloud,2000); }
function setStatus(msg){
  const el=document.getElementById('syncStatus');
  const dot=document.getElementById('syncDot');
  if(el)el.textContent=msg;
  if(dot){
    const ok=msg.includes('âœ…')||msg.includes('Connected');
    const err=msg.includes('âŒ')||msg.includes('Error')||msg.includes('Offline');
    const busy=msg.includes('â€¦')||msg.includes('Syncing')||msg.includes('Connecting');
    dot.style.background = ok?'#4caf50':err?'#e74c3c':'#f39c12';
    dot.style.boxShadow  = ok?'0 0 6px #4caf50':err?'0 0 6px #e74c3c':'0 0 6px #f39c12';
    if(el) el.style.color = ok?'#4caf50':err?'#e74c3c':'#f39c12';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDEXEDDB (for images â€” trip-scoped key prefix)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _db;
function openIDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open('AllabroadImages',1);
    r.onupgradeneeded=e=>{ if(!e.target.result.objectStoreNames.contains('imgs')) e.target.result.createObjectStore('imgs',{keyPath:'id'}); };
    r.onsuccess=e=>{_db=e.target.result;res();};
    r.onerror=rej;
  });
}
function idbKey(id){ return (openTripId||'x')+':'+String(id); }
const idb={
  save:(id,url)=>new Promise((res,rej)=>{ const tx=_db.transaction('imgs','readwrite'); tx.objectStore('imgs').put({id:idbKey(id),dataUrl:url}); tx.oncomplete=res;tx.onerror=rej; }),
  get: id=>new Promise(res=>{ const r=_db.transaction('imgs','readonly').objectStore('imgs').get(idbKey(id)); r.onsuccess=()=>res(r.result?r.result.dataUrl:null);r.onerror=()=>res(null); }),
  del: id=>new Promise(res=>{ const tx=_db.transaction('imgs','readwrite'); tx.objectStore('imgs').delete(idbKey(id)); tx.oncomplete=res;tx.onerror=res; }),
  allKeys:()=>new Promise(res=>{ const r=_db.transaction('imgs','readonly').objectStore('imgs').getAllKeys(); r.onsuccess=()=>res((r.result||[]).filter(k=>k.startsWith((openTripId||'x')+':')).map(k=>k.split(':').slice(1).join(':'))); r.onerror=()=>res([]); })
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DROPBOX â€” per trip (uses trip code as folder)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const dbx={
  up:(tok,path,body)=>fetch('https://content.dropboxapi.com/2/files/upload',{method:'POST',headers:{'Authorization':'Bearer '+tok,'Dropbox-API-Arg':JSON.stringify({path,mode:'overwrite',autorename:false,mute:true}),'Content-Type':'application/octet-stream'},body}),
  down:(tok,path)=>fetch('https://content.dropboxapi.com/2/files/download',{method:'POST',headers:{'Authorization':'Bearer '+tok,'Dropbox-API-Arg':JSON.stringify({path})}}),
  del:(tok,path)=>fetch('https://api.dropboxapi.com/2/files/delete_v2',{method:'POST',headers:{'Authorization':'Bearer '+tok,'Content-Type':'application/json'},body:JSON.stringify({path})})
};
let cachedToken=null,tokenExpiry=0;
async function getAccessToken(){
  if(cachedToken&&Date.now()<tokenExpiry-60000) return cachedToken;
  const key=localStorage.getItem('dbx_key'),secret=localStorage.getItem('dbx_secret'),refresh=localStorage.getItem('dbx_refresh');
  if(!key||!secret||!refresh){setStatus('â˜ï¸ Not connected');return null;}
  try{
    const r=await fetch('https://api.dropbox.com/oauth2/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:'grant_type=refresh_token&refresh_token='+encodeURIComponent(refresh)+'&client_id='+encodeURIComponent(key)+'&client_secret='+encodeURIComponent(secret)});
    const d=await r.json();
    if(!r.ok||!d.access_token){setStatus('â˜ï¸ '+(d.error_description||d.error||'Auth error'));return null;}
    cachedToken=d.access_token;tokenExpiry=Date.now()+(d.expires_in||14400)*1000;
    return cachedToken;
  }catch(e){setStatus('â˜ï¸ Offline');return null;}
}
function hasDbxCredentials(){ return !!(localStorage.getItem('dbx_key')&&localStorage.getItem('dbx_secret')&&localStorage.getItem('dbx_refresh')); }
function tripCloudPath(){ return '/allabroad/'+(openTripId||'trip')+'/data.json'; }
function tripImgPath(id){ return '/allabroad/'+(openTripId||'trip')+'/images/'+id; }

// Merge helpers
function mergeById(a,b){
  const dead=new Set(deletedIds.map(String));const seen=new Map();
  for(const t of [...(a||[]),...(b||[])]){const k=String(t.id);if(!dead.has(k)&&!seen.has(k))seen.set(k,t);}
  return Array.from(seen.values()).sort((x,y)=>Number(x.id)-Number(y.id));
}
function mergeList(a,b,extraDead){
  const dead=new Set([...deletedIds.map(String),...(extraDead||[]).map(String)]);const seen=new Map();
  for(const t of [...(a||[]),...(b||[])]){const k=String(t.id);if(!dead.has(k)&&!seen.has(k))seen.set(k,t);}
  return Array.from(seen.values()).sort((x,y)=>Number(x.id)-Number(y.id));
}
function mergeTravelers(a,b){
  const dead=new Set(deletedTravelers);const map=new Map();
  for(const t of [...(a||[]),...(b||[])]){if(dead.has(t.username))continue;const ex=map.get(t.username);if(!ex||(t.joinedAt||0)>(ex.joinedAt||0))map.set(t.username,t);}
  return Array.from(map.values());
}

async function syncToCloud(){
  if(syncing||!openTripId)return;
  const tok=await getAccessToken();if(!tok)return;
  syncing=true;setStatus('â˜ï¸ Syncingâ€¦');
  try{
    let cloud={};
    try{const r=await dbx.down(tok,tripCloudPath());if(r.ok)cloud=await r.json();}catch(e){}
    deletedIds=[...new Set([...deletedIds,...(cloud.deletedIds||[])].map(String))];
    deletedTravelers=[...new Set([...deletedTravelers,...(cloud.deletedTravelers||[])])];
    const mT=mergeById(cloud.tickets||[],tickets);
    const mM=mergeById(cloud.memories||[],state.memories);
    const mI=mergeById(cloud.itinerary||[],state.itinerary);
    const cloudPL=cloud.personLists||{};
    const mergedPL={};
    [...new Set([...Object.keys(personLists),...Object.keys(cloudPL)])].filter(u=>!deletedTravelers.includes(u)).forEach(u=>{
      const local=personLists[u]||{shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};
      const remote=cloudPL[u]||{shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};
      const mSD=[...new Set([...(local.shoppingDeleted||[]),...(remote.shoppingDeleted||[])].map(String))];
      mergedPL[u]={shopping:mergeList(remote.shopping||[],local.shopping||[],mSD),packing:mergeById(remote.packing||[],local.packing||[]),ukShopping:mergeById(remote.ukShopping||[],local.ukShopping||[]),shoppingDeleted:mSD};
    });
    const mTrav=mergeTravelers(cloud.travelers||[],travelers);
    const payload={itinerary:mI,notes:state.notes,travelers:mTrav,personLists:mergedPL,tickets:mT.map(t=>({id:t.id,name:t.name})),memories:mM.map(m=>({id:m.id,caption:m.caption})),deletedIds,deletedTravelers};
    const res=await dbx.up(tok,tripCloudPath(),JSON.stringify(payload));
    if(!res.ok){setStatus('â˜ï¸ Upload Error âŒ');syncing=false;return;}
    const localKeys=new Set((await idb.allKeys()).map(String));
    for(const item of [...mT,...mM]){if(localKeys.has(String(item.id))){const img=await idb.get(item.id);if(img)try{await dbx.up(tok,tripImgPath(item.id),img);}catch(e){}}}
    tickets=mT;state.memories=mM;state.itinerary=mI;travelers=mTrav;personLists=mergedPL;
    if(!travelers.find(t=>t.username===activeTraveler)) activeTraveler=travelers[0].username;
    saveTripLocal();render();await renderTickets();await renderMemories();renderTravelerSettings();
    setStatus('â˜ï¸ Synced âœ… '+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}));
  }catch(e){setStatus('â˜ï¸ Offline âŒ');}
  syncing=false;
}

async function syncFromCloud(){
  if(syncing||!openTripId)return;
  const tok=await getAccessToken();if(!tok){setStatus('â˜ï¸ Not connected');return;}
  syncing=true;setStatus('â˜ï¸ Connectingâ€¦');
  try{
    const res=await dbx.down(tok,tripCloudPath());
    if(!res.ok){setStatus('â˜ï¸ No cloud data yet');syncing=false;return;}
    const data=await res.json();
    deletedIds=[...new Set([...deletedIds,...(data.deletedIds||[])].map(String))];
    deletedTravelers=[...new Set([...deletedTravelers,...(data.deletedTravelers||[])])];
    const dead=new Set(deletedIds);
    if(data.itinerary) state.itinerary=mergeById(data.itinerary,state.itinerary);
    if(data.notes) state.notes=data.notes;
    tickets=mergeById(data.tickets||[],tickets);
    state.memories=mergeById(data.memories||[],state.memories).filter(m=>!dead.has(String(m.id)));
    if(data.travelers?.length) travelers=mergeTravelers(data.travelers,travelers);
    if(data.personLists){Object.keys(data.personLists).forEach(u=>{if(!personLists[u])personLists[u]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};const remote=data.personLists[u];const mSD=[...new Set([...(personLists[u].shoppingDeleted||[]),...(remote.shoppingDeleted||[])].map(String))];personLists[u]={shopping:mergeList(remote.shopping||[],personLists[u].shopping||[],mSD),packing:mergeById(remote.packing||[],personLists[u].packing||[]),ukShopping:mergeById(remote.ukShopping||[],personLists[u].ukShopping||[]),shoppingDeleted:mSD};});}
    travelers.forEach(t=>{if(!personLists[t.username])personLists[t.username]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};});
    if(!travelers.find(t=>t.username===activeTraveler)) activeTraveler=travelers[0].username;
    const localKeys=new Set((await idb.allKeys()).map(String));
    for(const id of [...tickets.map(t=>t.id),...state.memories.map(m=>m.id)]){if(!localKeys.has(String(id))){try{const r=await dbx.down(tok,tripImgPath(id));if(r.ok){const txt=await r.text();if(txt.startsWith('data:'))await idb.save(id,txt);}}catch(e){}}}
    saveTripLocal();render();await renderTickets();await renderMemories();renderTravelerSettings();
    setStatus('â˜ï¸ Connected âœ…');
  }catch(e){console.error(e);setStatus('â˜ï¸ Error âŒ');}
  syncing=false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITINERARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildDayTabs(){
  const tabs=document.getElementById('dayTabs'),sel=document.getElementById('evDay');if(!tabs||!sel)return;
  tabs.innerHTML=TRIP_DAYS.map((d,i)=>`<button class="day-tab${i===activeDay?' active':''}" onclick="setDay(${i})">${d}</button>`).join('');
  sel.innerHTML=TRIP_DAYS.map((d,i)=>`<option value="${i}">${d}</option>`).join('');
  sel.value=String(activeDay);
}
function setDay(i){activeDay=i;buildDayTabs();renderItinerary();}
function renderItinerary(){
  const list=document.getElementById('itineraryList');if(!list)return;
  const evs=(state.itinerary||[]).filter(e=>Number(e.day)===activeDay).sort((a,b)=>(a.time||'').localeCompare(b.time||''));
  if(!evs.length){list.innerHTML=`<div class="empty">No events for ${TRIP_DAYS[activeDay]} yet.</div>`;return;}
  list.innerHTML=evs.map(e=>`<div class="ev-row">
    <div class="ev-time">${e.time||'--:--'}</div>
    <div class="ev-body"><div class="ev-title">${esc(e.title)}</div>${e.note?`<div class="ev-note">${esc(e.note)}</div>`:''}</div>
    <div style="display:flex;gap:4px;flex-shrink:0;">
      <button onclick="editEvent(${e.id})" class="del-btn" style="opacity:0.45;font-size:0.85rem;" title="Edit">âœï¸</button>
      <button onclick="deleteEvent(${e.id})" class="del-btn" title="Delete">âœ•</button>
    </div>
  </div>`).join('');
}
let editingEventId=null;
function showAddEvent(){
  editingEventId=null;
  document.getElementById('evFormTitle').textContent='Add Event';
  document.getElementById('evSaveBtn').textContent='Save Event';
  document.getElementById('evDay').value=String(activeDay);
  document.getElementById('evTitle').value='';document.getElementById('evNote').value='';document.getElementById('evTime').value='';
  document.getElementById('eventForm').classList.add('on');
  document.getElementById('evTitle').focus();
}
function editEvent(id){
  const ev=state.itinerary.find(e=>e.id===id);if(!ev)return;
  editingEventId=id;
  document.getElementById('evFormTitle').textContent='Edit Event';document.getElementById('evSaveBtn').textContent='Update Event';
  document.getElementById('evDay').value=String(ev.day);document.getElementById('evTime').value=ev.time||'';
  document.getElementById('evTitle').value=ev.title;document.getElementById('evNote').value=ev.note||'';
  document.getElementById('eventForm').classList.add('on');document.getElementById('evTitle').focus();
  setTimeout(()=>document.getElementById('eventForm').scrollIntoView({behavior:'smooth',block:'nearest'}),50);
}
function cancelEvent(){editingEventId=null;document.getElementById('eventForm').classList.remove('on');}
function saveEvent(){
  const title=document.getElementById('evTitle').value.trim();if(!title){alert('Please enter an event title.');return;}
  const day=parseInt(document.getElementById('evDay').value),time=document.getElementById('evTime').value,note=document.getElementById('evNote').value.trim();
  if(editingEventId!==null){const ev=state.itinerary.find(e=>e.id===editingEventId);if(ev){ev.day=day;ev.time=time;ev.title=title;ev.note=note;}}
  else state.itinerary.push({id:Date.now(),day,time,title,note});
  editingEventId=null;document.getElementById('eventForm').classList.remove('on');
  activeDay=day;buildDayTabs();renderItinerary();saveAndSync();
}
function deleteEvent(id){if(!confirm('Delete this event?'))return;state.itinerary=state.itinerary.filter(e=>e.id!==id);renderItinerary();saveAndSync();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNotes(){const el=document.getElementById('notesArea');if(el)el.value=state.notes||'';}
function saveNotes(){
  state.notes=document.getElementById('notesArea').value;
  const lbl=document.getElementById('notesSavedLabel');lbl.textContent='Saved âœ…';setTimeout(()=>lbl.textContent='',2500);
  saveAndSync();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LISTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function curLists(){return personLists[activeTraveler]||(personLists[activeTraveler]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]});}
function addItem(key,inpId){const inp=document.getElementById(inpId),val=inp.value.trim();if(!val)return;curLists()[key].push({id:Date.now(),name:val,checked:false});inp.value='';saveAndSync();}
function toggleItem(key,id){
  const lists=curLists(),item=lists[key].find(i=>i.id===id);if(!item)return;
  if(key==='shopping'&&!item.checked){
    if(confirm(`Move "${item.name}" to your Packing List?`)){
      lists.packing.push({id:Date.now(),name:item.name,checked:false});
      lists.shopping=lists.shopping.filter(i=>i.id!==id);
      if(!lists.shoppingDeleted)lists.shoppingDeleted=[];
      lists.shoppingDeleted=[...new Set([...lists.shoppingDeleted,String(id)])];
      saveAndSync();return;
    }
  }
  item.checked=!item.checked;saveAndSync();
}
function deleteItem(key,id){const lists=curLists();lists[key]=lists[key].filter(i=>i.id!==id);saveAndSync();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processImage(input,forWhat){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      const MAX=1200;let w=img.width,h=img.height;if(w>MAX){h=Math.round(h*MAX/w);w=MAX;}
      const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
      tempImg=c.toDataURL('image/jpeg',0.75);
      if(forWhat==='ticket'){document.getElementById('previewImg').src=tempImg;document.getElementById('photoPreview').classList.add('on');}
      else{document.getElementById('memPreviewImg').src=tempImg;document.getElementById('memPreviewRow').classList.add('on');document.getElementById('memCaption').focus();}
    };img.src=e.target.result;
  };reader.readAsDataURL(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICKETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addTicket(){
  const inp=document.getElementById('ticketName');
  if(!inp.value.trim()){alert('Please enter a ticket name.');return;}
  if(!tempImg){alert('Please attach a photo first (tap ğŸ“·).');return;}
  const id=Date.now();tickets.push({id,name:inp.value.trim()});
  await idb.save(id,tempImg);inp.value='';clearTicketPhoto();
  saveTripLocal();await renderTickets();clearTimeout(syncTimer);syncTimer=setTimeout(syncToCloud,2000);setStatus('â˜ï¸ Pendingâ€¦');
}
function clearTicketPhoto(){tempImg=null;document.getElementById('photoPreview').classList.remove('on');document.getElementById('ticketFile').value='';document.getElementById('previewImg').src='';}
async function deleteTicket(id){
  const t=tickets.find(t=>t.id===id);if(!confirm(`Delete "${t?t.name:'this ticket'}"?`))return;
  tickets=tickets.filter(t=>t.id!==id);deletedIds=[...new Set([...deletedIds,String(id)])];
  await idb.del(id);const tok=await getAccessToken();if(tok)try{await dbx.del(tok,tripImgPath(id));}catch(e){}
  saveTripLocal();await renderTickets();clearTimeout(syncTimer);syncTimer=setTimeout(syncToCloud,2000);setStatus('â˜ï¸ Pendingâ€¦');
}
async function renderTickets(){
  const el=document.getElementById('ticketList');if(!el)return;
  if(!tickets.length){el.innerHTML=`<div class="empty">No tickets yet â€” add your booking confirmations!</div>`;return;}
  const rows=await Promise.all(tickets.map(async t=>{const img=await idb.get(t.id);return `<div class="ticket-card" onclick="viewImage(${t.id})">${img?`<img src="${img}" class="t-thumb" alt="${esc(t.name)}">`:`<div class="t-thumb-ph">ğŸŸï¸</div>`}<span style="flex:1">${esc(t.name)}</span><button onclick="event.stopPropagation();deleteTicket(${t.id})" class="del-btn">âœ•</button></div>`;}));
  el.innerHTML=rows.join('');
}
async function viewImage(id){const img=await idb.get(id);if(!img){alert('Image not available. Tap ğŸ”„ to sync.');return;}document.getElementById('fullImg').src=img;document.getElementById('imgModal').classList.add('open');}
function closeImgModal(){document.getElementById('imgModal').classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEMORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addMemory(){
  if(!tempImg)return;const id=Date.now(),caption=document.getElementById('memCaption').value.trim();
  state.memories.push({id,caption});await idb.save(id,tempImg);tempImg=null;
  document.getElementById('memPreviewRow').classList.remove('on');document.getElementById('memCaption').value='';document.getElementById('memFile').value='';
  saveTripLocal();await renderMemories();clearTimeout(syncTimer);syncTimer=setTimeout(syncToCloud,2000);setStatus('â˜ï¸ Pendingâ€¦');
}
function cancelMemory(){tempImg=null;document.getElementById('memPreviewRow').classList.remove('on');document.getElementById('memFile').value='';}
async function deleteMemory(id){
  if(!confirm('Remove this memory?'))return;state.memories=state.memories.filter(m=>m.id!==id);
  deletedIds=[...new Set([...deletedIds,String(id)])];await idb.del(id);
  const tok=await getAccessToken();if(tok)try{await dbx.del(tok,tripImgPath(id));}catch(e){}
  saveTripLocal();await renderMemories();clearTimeout(syncTimer);syncTimer=setTimeout(syncToCloud,2000);setStatus('â˜ï¸ Pendingâ€¦');
}
async function renderMemories(){
  const grid=document.getElementById('memoriesGrid');if(!grid)return;
  if(!state.memories?.length){grid.innerHTML=`<div class="empty" style="grid-column:1/-1;">No memories yet â€” add photos during your trip! ğŸ“¸</div>`;return;}
  const cells=await Promise.all(state.memories.map(async m=>{const img=await idb.get(m.id);return `<div class="mem-cell" onclick="viewImage(${m.id})">${img?`<img src="${img}" loading="lazy" alt="${esc(m.caption||'memory')}">`:`<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2rem;opacity:0.3">ğŸ–¼ï¸</div>`}<button class="mem-del" onclick="event.stopPropagation();deleteMemory(${m.id})">âœ•</button>${m.caption?`<div class="mem-cap">${esc(m.caption)}</div>`:''}</div>`;}));
  grid.innerHTML=cells.join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRAVELERS (read-only display in settings â€” Allabroad handles add/remove)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AV_COLS2=['#c8a96e','#6fcf97','#56aef7','#e88c6a','#b39ddb','#80cbc4','#f48fb1','#ffe082'];
function avCol2(u){let h=0;for(let i=0;i<u.length;i++)h=(h*31+u.charCodeAt(i))&0xff;return AV_COLS2[h%AV_COLS2.length];}
function renderTravelerTabs(){
  const el=document.getElementById('travelerTabs');if(!el)return;
  el.innerHTML=travelers.map(t=>`<button class="day-tab${t.username===activeTraveler?' active':''}" onclick="switchTraveler('${t.username}')">${esc(t.username)}</button>`).join('');
}
function switchTraveler(u){activeTraveler=u;if(!personLists[u])personLists[u]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};render();}
function renderTravelerSettings(){
  const el=document.getElementById('travelerSettingsList');if(!el)return;
  el.innerHTML=travelers.map(t=>`<div class="trav-row">
    <div class="trav-av" style="background:linear-gradient(135deg,${avCol2(t.username)},${avCol2(t.username+'x')})">${initials(t.username)}</div>
    <div class="trav-info"><div class="trav-name">${esc(t.username)}</div><div class="trav-role">Joined ${new Date(t.joinedAt||Date.now()).toLocaleDateString('en-GB',{day:'numeric',month:'short'})}</div></div>
    <div class="trav-badge ${t.role==='owner'?'b-owner':'b-traveler'}">${t.role==='owner'?'Organiser':'Traveler'}</div>
  </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER (lists + tabs + itinerary)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const lists=curLists();
  ['shopping','ukShopping','packing'].forEach(key=>{
    const elId={shopping:'shopList',ukShopping:'ukShopList',packing:'packList'}[key];
    const el=document.getElementById(elId);if(!el)return;
    const items=lists[key]||[];
    if(!items.length){el.innerHTML=`<div class="empty">No items yet.</div>`;return;}
    el.innerHTML=items.map(i=>`<div class="item-row${i.checked?' checked':''}"><input type="checkbox"${i.checked?' checked':''} onchange="toggleItem('${key}',${i.id})"><span class="item-name">${esc(i.name)}</span><button onclick="deleteItem('${key}',${i.id})" class="del-btn">âœ•</button></div>`).join('');
  });
  renderTravelerTabs();renderItinerary();renderNotes();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCD(){
  if(!TRAVEL_DATE)return;
  const diff=TRAVEL_DATE-Date.now();
  if(diff<=0){checkArrived();return;}
  document.getElementById('cdDays').textContent=Math.floor(diff/86400000);
  document.getElementById('cdHours').textContent=Math.floor((diff%86400000)/3600000);
  document.getElementById('cdMins').textContent=Math.floor((diff%3600000)/60000);
}
function checkArrived(){
  if(!TRAVEL_DATE||TRAVEL_DATE-Date.now()>0||confettiFired)return;
  confettiFired=true;
  document.getElementById('tripBg').style.filter='brightness(0.55)';
  ['cdDaysCell','cdHoursCell','cdMinsCell'].forEach(id=>document.getElementById(id).style.display='none');
  document.querySelectorAll('.cd-sep').forEach(el=>el.style.display='none');
  document.getElementById('arrivedPill').style.display='block';
  document.getElementById('arrivedPill').textContent='ğŸ‰ You\'re in '+TRIP.destination+'!';
  [0,3000,6000].forEach(d=>setTimeout(fireConfetti,d));
}
function fireConfetti(){
  const cols=['#DC143C','#ffffff','#c8a96e','#FFD700','#ff69b4','#00bfff'];
  for(let i=0;i<120;i++){const p=document.createElement('div');p.className='cp';const sz=Math.random()*10+6;p.style.cssText=`left:${Math.random()*100}vw;width:${sz}px;height:${sz}px;background:${cols[~~(Math.random()*cols.length)]};--drift:${(Math.random()-.5)*200}px;animation-duration:${Math.random()*2+2.5}s;animation-delay:${Math.random()*1.5}s;border-radius:${Math.random()>.5?'50%':'2px'};opacity:${Math.random()*.5+.5};`;document.body.appendChild(p);p.addEventListener('animationend',()=>p.remove());}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEATHER â€” geocode destination â†’ lat/lon â†’ open-meteo
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WEATHER_COORDS={
  london:{lat:51.5074,lon:-0.1278},paris:{lat:48.8566,lon:2.3522},tokyo:{lat:35.6762,lon:139.6503},
  rome:{lat:41.9028,lon:12.4964},barcelona:{lat:41.3851,lon:2.1734},bali:{lat:-8.4095,lon:115.1889},
  dubai:{lat:25.2048,lon:55.2708},sydney:{lat:-33.8688,lon:151.2093},newyork:{lat:40.7128,lon:-74.0060},
  nyc:{lat:40.7128,lon:-74.0060},amsterdam:{lat:52.3676,lon:4.9041},bangkok:{lat:13.7563,lon:100.5018},
  singapore:{lat:1.3521,lon:103.8198},lisbon:{lat:38.7169,lon:-9.1399},prague:{lat:50.0755,lon:14.4378},
  vienna:{lat:48.2082,lon:16.3738},istanbul:{lat:41.0082,lon:28.9784},athens:{lat:37.9838,lon:23.7275},
  maldives:{lat:3.2028,lon:73.2207},iceland:{lat:64.9631,lon:-19.0208}
};
async function fetchWeather(dest){
  if(!dest)return;
  const k=dest.toLowerCase().replace(/[\s,]/g,'');
  let coord=null;
  for(const [kw,c] of Object.entries(WEATHER_COORDS)){ if(k.includes(kw)){coord=c;break;} }
  if(!coord)return;
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coord.lat}&longitude=${coord.lon}&current_weather=true`);
    if(!r.ok)return;
    const d=await r.json();
    const wmo=d.current_weather.weathercode;
    const sky=wmo<=1?'â˜€ï¸ Clear':wmo<=3?'â›… Partly cloudy':wmo<=67?'ğŸŒ§ï¸ Rain':'â„ï¸ Snow';
    document.getElementById('tripTemp').textContent=Math.round(d.current_weather.temperature)+'Â°C';
    document.getElementById('tripSky').textContent=sky+' in '+dest;
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function requestNotifPermission(){
  if(!('Notification' in window)){alert('Notifications not supported in this browser.');return;}
  Notification.requestPermission().then(p=>{
    if(p==='granted'){document.getElementById('notifStatus').textContent='Alerts: Active âœ…';new Notification('Allabroad âœˆï¸',{body:'Morning countdown alerts enabled!'});}
    else alert('Permission denied.');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESET TRIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function resetApp(){
  if(!confirm('Reset this trip\'s data?\n\nThis will permanently clear all itinerary, lists, notes and tickets on ALL devices. Cannot be undone.'))return;
  if(!confirm('Are you sure?'))return;
  state={itinerary:[],notes:'',memories:[]};tickets=[];deletedIds=[];deletedTravelers=[];
  personLists={};travelers.forEach(t=>{personLists[t.username]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};});
  saveTripLocal();
  const tok=await getAccessToken();
  if(tok){try{const empty={itinerary:[],notes:'',travelers,personLists,tickets:[],memories:[],deletedIds:[],deletedTravelers:[]};await dbx.up(tok,tripCloudPath(),JSON.stringify(empty));setStatus('â˜ï¸ Reset âœ…');}catch(e){setStatus('â˜ï¸ Local reset done');}}
  render();await renderTickets();await renderMemories();renderTravelerSettings();
  alert('Trip data cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CODE COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyTripCode(){
  if(!TRIP)return;
  if(navigator.clipboard) navigator.clipboard.writeText(TRIP.code).then(()=>showToast('Code '+TRIP.code+' copied! ğŸ“‹'));
  else showToast('Join code: '+TRIP.code);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS & SWIPE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(n,silent){
  currentTab=n;
  document.getElementById('tabsSlider').style.transform=`translateX(${-n*100}%)`;
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',i===n));
  if(!silent) window.scrollTo({top:0,behavior:'smooth'});
}
(function(){
  let sx=0,sy=0,locked=false;
  const sl=document.getElementById('tabsSlider');
  sl.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;locked=false;},{passive:true});
  sl.addEventListener('touchmove',e=>{if(locked)return;const dx=Math.abs(e.touches[0].clientX-sx),dy=Math.abs(e.touches[0].clientY-sy);if(dy>dx*0.8)locked=true;},{passive:true});
  sl.addEventListener('touchend',e=>{if(locked)return;const dx=e.changedTouches[0].clientX-sx,dy=e.changedTouches[0].clientY-sy;if(Math.abs(dx)<50||Math.abs(dy)>Math.abs(dx)*0.8)return;if(dx<0&&currentTab<3)switchTab(currentTab+1);if(dx>0&&currentTab>0)switchTab(currentTab-1);},{passive:true});
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS (dashboard sheet modals)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMd(id){document.getElementById(id).classList.add('open');}
function closeMd(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-bd').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)closeMd(m.id);}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastT=null;
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>t.classList.remove('show'),2800);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STARTUP â€” credentials baked in, zero setup needed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BAKED = {
  key:     'psrzby03p9rz8bh',
  secret:  'vsl3cp8tclkmhjv',
  refresh: 'Fw1F2gzo8eIAAAAAAAAAAeZqHLb6Q-lkoGjp2gEx3X3V79e1sNmFBju_uOT7TRFq'
};

openIDB().then(()=>{
  // Seed credentials on every device â€” no setup needed
  localStorage.setItem('dbx_key',     BAKED.key);
  localStorage.setItem('dbx_secret',  BAKED.secret);
  localStorage.setItem('dbx_refresh', BAKED.refresh);
  if(CU){ renderDashboard(); showScreen('dash'); }
});
</script>
</body>
</html>
