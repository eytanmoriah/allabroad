<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Allabroad</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a1a">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOT & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --red:        #DC143C;
  --red-dark:   #b01030;
  --glass:      rgba(255,255,255,0.11);
  --glass-b:    rgba(255,255,255,0.22);
  --text:       #ffffff;
  --dim:        rgba(255,255,255,0.45);
  --sand:       #c8a96e;
  --cd-h:       68px;
  --tab-h:      64px;
  --sat: env(safe-area-inset-top,0px);
  --sab: env(safe-area-inset-bottom,0px);
  --sal: env(safe-area-inset-left,0px);
  --sar: env(safe-area-inset-right,0px);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;background:#0a0a1a;color:var(--text);font-family:'DM Sans',sans-serif;overflow:hidden;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREENS â€” single-page navigation
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{
  position:fixed;inset:0;
  display:flex;flex-direction:column;
  opacity:0;pointer-events:none;
  transition:opacity 0.3s ease;
  overflow:hidden;
}
/* Trip screen needs its own scroll */
.screen.active{opacity:1;pointer-events:all;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘  AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-auth{
  background:linear-gradient(160deg,#0a0a1a 0%,#1a1a3e 50%,#0a0a1a 100%);
  align-items:center;justify-content:center;
  padding:40px 24px calc(var(--sab)+40px);
  padding-top:calc(var(--sat)+40px);
  overflow-y:auto;-webkit-overflow-scrolling:touch;
}
.auth-bg-word{
  position:absolute;font-family:'Playfair Display',serif;
  font-size:clamp(5rem,25vw,14rem);font-weight:900;
  color:rgba(255,255,255,0.025);letter-spacing:-0.02em;
  top:50%;left:50%;transform:translate(-50%,-50%);
  white-space:nowrap;pointer-events:none;user-select:none;
}
.auth-logo{
  font-family:'Playfair Display',serif;
  font-size:3rem;font-weight:900;letter-spacing:-0.02em;
  color:var(--text);margin-bottom:4px;text-align:center;
}
.auth-logo span{color:var(--red);}
.auth-tag{
  font-size:0.72rem;letter-spacing:0.22em;text-transform:uppercase;
  color:var(--dim);margin-bottom:40px;text-align:center;
}
.auth-brand-col { display: none; }
.auth-form-col  { display: flex; flex-direction: column; align-items: center; width: 100%; }
.auth-card{
  width:100%;max-width:400px;
  background:rgba(255,255,255,0.07);
  border:1px solid var(--glass-b);
  border-radius:24px;padding:28px 24px;
  backdrop-filter:blur(20px);
}
.auth-tabs{
  display:flex;gap:0;
  background:rgba(0,0,0,0.3);
  border-radius:12px;padding:4px;
  margin-bottom:24px;
}
.auth-tab{
  flex:1;padding:8px;border:none;background:none;
  color:var(--dim);font-family:'DM Sans',sans-serif;
  font-size:0.85rem;font-weight:500;border-radius:9px;
  cursor:pointer;transition:all 0.2s;
}
.auth-tab.active{background:var(--red);color:#fff;}
.auth-field{margin-bottom:14px;}
.auth-field label{
  display:block;font-size:0.68rem;letter-spacing:0.14em;
  text-transform:uppercase;color:var(--dim);margin-bottom:7px;
}
.auth-field input{
  width:100%;padding:13px 14px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:11px;color:#fff;
  font-family:'DM Sans',sans-serif;font-size:1rem;
  outline:none;transition:border-color 0.2s;
  -webkit-appearance:none;
}
.auth-field input:focus{border-color:var(--red);}
.auth-field input::placeholder{color:var(--dim);}
.auth-err{font-size:0.78rem;color:#ff6b6b;min-height:18px;margin-bottom:10px;}
.btn-primary{
  width:100%;padding:14px;
  background:linear-gradient(135deg,var(--red),var(--red-dark));
  border:none;border-radius:11px;
  color:#fff;font-family:'DM Sans',sans-serif;
  font-size:0.95rem;font-weight:600;
  cursor:pointer;touch-action:manipulation;
  transition:opacity 0.2s,transform 0.15s;
}
.btn-primary:active{transform:scale(0.98);}
.auth-or{
  text-align:center;color:var(--dim);font-size:0.75rem;
  margin:14px 0;letter-spacing:0.1em;
}
.btn-ghost{
  width:100%;padding:12px;
  background:none;border:1px solid rgba(255,255,255,0.15);
  border-radius:11px;color:var(--dim);
  font-family:'DM Sans',sans-serif;font-size:0.88rem;
  cursor:pointer;touch-action:manipulation;
  transition:border-color 0.2s,color 0.2s;
}
.btn-ghost:hover{border-color:var(--red);color:var(--red);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘¡ DASHBOARD SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-dash{background:#0a0a1a;display:flex;flex-direction:column;align-items:stretch;}
.dash-inner{
  display:flex;flex-direction:column;
  width:100%;max-width:860px;
  margin:0 auto;
  flex:1;min-height:0;
}
.dash-head{
  position:relative;z-index:10;
  padding:calc(var(--sat)+20px) 20px 0;
  background:linear-gradient(to bottom,#0a0a1a 70%,transparent);
  flex-shrink:0;
}
.dash-topbar{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:22px;
}
.dash-logo{
  font-family:'Playfair Display',serif;
  font-size:1.7rem;font-weight:900;letter-spacing:-0.01em;
}
.dash-logo span{color:var(--red);}
.dash-user-row{display:flex;align-items:center;gap:10px;}
.dash-signout{
  background:none;border:none;color:var(--dim);
  font-size:0.75rem;font-family:'DM Sans',sans-serif;
  cursor:pointer;padding:4px 8px;
  transition:color 0.2s;touch-action:manipulation;
}
.dash-signout:hover{color:var(--red);}
.dash-avatar{
  width:36px;height:36px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:600;font-size:0.8rem;color:#0a0a1a;
}
.dash-greeting{
  font-family:'Playfair Display',serif;
  font-size:1.8rem;font-weight:700;line-height:1.15;
  margin-bottom:3px;
}
.dash-greeting em{font-style:italic;color:var(--sand);}
.dash-sub{font-size:0.75rem;color:var(--dim);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:18px;}
.dash-actions{display:flex;gap:9px;margin-bottom:18px;}
.btn-new{
  flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
  padding:13px 16px;
  background:linear-gradient(135deg,var(--red),var(--red-dark));
  border:none;border-radius:14px;
  color:#fff;font-family:'DM Sans',sans-serif;
  font-size:0.9rem;font-weight:600;
  cursor:pointer;touch-action:manipulation;
  transition:opacity 0.2s,transform 0.15s;
}
.btn-new:active{transform:scale(0.97);}
.btn-join{
  padding:13px 18px;
  background:rgba(255,255,255,0.08);
  border:1px solid var(--glass-b);border-radius:14px;
  color:var(--dim);font-family:'DM Sans',sans-serif;
  font-size:0.9rem;white-space:nowrap;
  cursor:pointer;touch-action:manipulation;
  transition:border-color 0.2s,color 0.2s;
}
.btn-join:hover{border-color:var(--red);color:var(--red);}
.dash-lbl{
  font-size:0.67rem;letter-spacing:0.2em;text-transform:uppercase;
  color:var(--dim);padding:0 20px;margin-bottom:12px;flex-shrink:0;
}
.trips-scroll{
  flex:1;overflow-y:auto;overflow-x:hidden;
  padding:0 20px calc(var(--sab)+24px);
  -webkit-overflow-scrolling:touch;
}
.trips-scroll::-webkit-scrollbar{display:none;}

/* Trip cards */
.trips-inner{width:100%;}
.trip-card{
  position:relative;border-radius:20px;overflow:hidden;
  margin-bottom:14px;height:190px;
  cursor:pointer;
  border:1px solid rgba(255,255,255,0.08);
  transition:transform 0.25s cubic-bezier(0.34,1.3,0.64,1);
}
.trip-card:active{transform:scale(0.97);}
.tc-bg{
  position:absolute;inset:0;background-size:cover;background-position:center;
  transition:transform 0.5s ease;
}
.trip-card:hover .tc-bg{transform:scale(1.04);}
.tc-ov{
  position:absolute;inset:0;
  background:linear-gradient(to top,rgba(10,10,26,0.93) 0%,rgba(10,10,26,0.35) 55%,rgba(10,10,26,0.08) 100%);
}
.tc-del-btn{
  position:absolute;top:12px;left:12px;
  width:32px;height:32px;border-radius:50%;
  background:rgba(255,69,96,0.15);
  border:1px solid rgba(255,69,96,0.4);
  color:rgba(255,255,255,0.85);font-size:0.85rem;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;opacity:0;
  transition:opacity 0.2s,background 0.2s;
  z-index:20;
}
.trip-card:hover .tc-del-btn,
.trip-card:focus-within .tc-del-btn{ opacity:1; }
.tc-del-btn:hover{ background:rgba(255,69,96,0.55) !important; }
/* On touch screens always show the delete button */
@media(hover:none){ .tc-del-btn{ opacity:1; } }
.tc-code{
  position:absolute;top:14px;right:14px;
  padding:4px 11px;
  background:rgba(10,10,26,0.7);
  border:1px solid rgba(255,255,255,0.2);
  border-radius:20px;
  font-size:0.65rem;letter-spacing:0.15em;color:var(--sand);
  backdrop-filter:blur(8px);
}
.tc-body{position:absolute;bottom:0;left:0;right:0;padding:18px 20px;}
.tc-badge{
  display:inline-block;padding:3px 10px;
  background:rgba(220,20,60,0.25);border:1px solid rgba(220,20,60,0.4);
  border-radius:20px;font-size:0.63rem;letter-spacing:0.14em;
  text-transform:uppercase;color:var(--red);margin-bottom:7px;
}
.tc-dest{
  font-family:'Playfair Display',serif;
  font-size:1.65rem;font-weight:700;line-height:1.1;margin-bottom:6px;
}
.tc-meta{display:flex;gap:14px;font-size:0.72rem;color:rgba(255,255,255,0.6);}
.dash-empty{text-align:center;padding:60px 20px;}
.dash-empty-icon{font-size:2.8rem;margin-bottom:14px;opacity:0.4;}
.dash-empty-ttl{
  font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;
  color:rgba(255,255,255,0.5);margin-bottom:8px;
}
.dash-empty-sub{font-size:0.8rem;color:var(--dim);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‘¢ TRIP INTERIOR â€” identical structure to London app
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-trip{background:#0a0a1a;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}

/* Dynamic background image */
.trip-bg{
  position:fixed;inset:0;z-index:0;
  background-size:cover;background-position:center;
  filter:brightness(0.35);
  transition:background-image 0.6s ease,filter 1.2s;
}

.airplane{
  position:fixed;top:20px;left:-80px;font-size:2rem;
  z-index:100;animation:fly 18s linear infinite;pointer-events:none;
}
@keyframes fly{0%{left:-80px}100%{left:110vw}}

/* â”€â”€ Countdown bar â”€â”€ */
#cdBar{
  position:fixed;top:0;left:0;right:0;z-index:300;
  height:calc(var(--cd-h) + var(--sat));
  padding-top:var(--sat);
  background:rgba(10,10,26,0.96);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-bottom:1px solid rgba(255,255,255,0.08);
  display:flex;align-items:center;justify-content:center;gap:0;
  padding-left:max(20px,var(--sal));padding-right:max(20px,var(--sar));
}
.cd-cell{text-align:center;flex:1;max-width:90px;}
.cd-num{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;line-height:1;display:block;}
.cd-lbl{font-size:0.58rem;opacity:0.45;letter-spacing:1.2px;text-transform:uppercase;margin-top:2px;display:block;}
.cd-sep{font-family:'Playfair Display',serif;font-size:1.5rem;opacity:0.2;padding:0 4px;align-self:center;margin-bottom:8px;}
#arrivedPill{
  display:none;
  background:linear-gradient(135deg,var(--red),#8B0010);
  border-radius:30px;padding:9px 22px;
  font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;
  animation:pulse 2s infinite;
}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.75}}

/* Back button sits in countdown bar */
#btnBackToTrips{
  position:absolute;left:max(14px,var(--sal));top:calc(var(--sat) + 12px);
  display:flex;align-items:center;gap:5px;
  padding:7px 13px;
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.18);
  border-radius:30px;
  color:#fff;font-size:0.78rem;font-family:'DM Sans',sans-serif;
  cursor:pointer;touch-action:manipulation;
  backdrop-filter:blur(10px);
  transition:border-color 0.2s;
}
#btnBackToTrips:hover{border-color:var(--red);}

/* â”€â”€ Scrollable content â”€â”€ */
.scroll-wrap{
  position:relative;z-index:10;
  width:100%;max-width:800px;margin:0 auto;
  padding-top:calc(var(--cd-h) + var(--sat) + 14px);
  padding-bottom:calc(var(--tab-h) + var(--sab) + 24px);
  padding-left:max(16px,var(--sal));
  padding-right:max(16px,var(--sar));
  box-sizing:border-box;
}

/* â”€â”€ Glass card â”€â”€ */
.glass{
  background:var(--glass);
  backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);
  border:1px solid var(--glass-b);
  border-radius:20px;padding:22px;
  margin-bottom:14px;
}

/* â”€â”€ Trip header â”€â”€ */
.trip-hdr{text-align:center;padding:28px 0 18px;}
.trip-hdr h1{font-family:'Playfair Display',serif;font-size:3rem;line-height:1;}
.trip-hdr h1 span{color:var(--red);}
.trip-hdr-sub{font-size:0.85rem;opacity:0.5;margin-top:6px;}

/* â”€â”€ Buttons â”€â”€ */
.btn{
  padding:10px 18px;border:none;border-radius:10px;
  cursor:pointer;font-weight:500;font-family:'DM Sans',sans-serif;
  transition:background 0.18s,transform 0.1s;
  font-size:0.9rem;-webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
}
.btn:active{transform:scale(0.96);}
.btn-red{background:var(--red);color:#fff;}
.btn-red:hover{background:var(--red-dark);}
.btn-glass{background:rgba(255,255,255,0.1);color:#fff;border:1px solid var(--glass-b);}
.btn-sm{padding:6px 14px;font-size:0.8rem;}
.btn-icon{padding:10px 13px;}

/* â”€â”€ Inputs â”€â”€ */
.input-row{display:flex;gap:9px;margin-bottom:13px;flex-wrap:wrap;}
input[type="text"],input[type="time"],textarea,select{
  flex:1;min-width:0;padding:13px 14px;
  background:rgba(255,255,255,0.1);
  border:1px solid var(--glass-b);
  border-radius:10px;color:#fff;outline:none;
  font-family:'DM Sans',sans-serif;font-size:1rem;
  -webkit-appearance:none;
}
input::placeholder{color:rgba(255,255,255,0.38);}
textarea{resize:vertical;min-height:120px;width:100%;}
select option{background:#1a1a3e;color:#fff;}

/* â”€â”€ List items â”€â”€ */
.item-row{
  display:flex;align-items:center;gap:11px;
  padding:13px 14px;
  background:rgba(255,255,255,0.05);
  border-radius:10px;margin-bottom:8px;
}
.item-row.checked .item-name{text-decoration:line-through;opacity:0.4;}
.item-name{flex:1;font-size:0.95rem;}
.del-btn{
  background:none;border:none;color:white;
  opacity:0.3;cursor:pointer;font-size:1.2rem;
  padding:8px 10px;margin:-6px -4px;
  transition:opacity 0.15s;touch-action:manipulation;
}
.del-btn:active{opacity:0.9;}
.del-btn:hover{opacity:0.7;}
.item-row input[type="checkbox"]{
  width:22px;height:22px;min-width:22px;
  accent-color:var(--red);cursor:pointer;
}
.empty{opacity:0.38;font-size:0.85rem;padding:5px 0;}

/* â”€â”€ Section header â”€â”€ */
.sec-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.sec-hdr h3{margin:0;font-size:1rem;font-weight:600;}

/* â”€â”€ Ticket cards â”€â”€ */
.ticket-card{
  background:rgba(255,255,255,0.07);border-radius:12px;
  padding:12px;margin-bottom:9px;
  display:flex;align-items:center;gap:13px;
  cursor:pointer;transition:background 0.18s;
}
.ticket-card:active{background:rgba(255,255,255,0.14);}
.t-thumb{width:52px;height:52px;border-radius:8px;object-fit:cover;flex-shrink:0;}
.t-thumb-ph{
  width:52px;height:52px;border-radius:8px;flex-shrink:0;
  background:rgba(220,20,60,0.15);
  display:flex;align-items:center;justify-content:center;font-size:1.4rem;
}
.photo-preview{display:none;align-items:center;gap:10px;margin-bottom:12px;padding:10px 13px;background:rgba(255,255,255,0.05);border-radius:10px;}
.photo-preview.on{display:flex;}

/* â”€â”€ Image modal â”€â”€ */
.img-modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,0.94);z-index:1000;
  align-items:center;justify-content:center;flex-direction:column;gap:14px;
}
.img-modal.open{display:flex;}
.img-modal img{max-width:95vw;max-height:85vh;border-radius:12px;}
.img-modal-x{color:white;font-size:0.95rem;opacity:0.55;cursor:pointer;padding:12px 28px;}

/* â”€â”€ Itinerary â”€â”€ */
.ev-row{
  display:flex;gap:10px;align-items:flex-start;
  padding:12px;background:rgba(255,255,255,0.06);
  border-radius:12px;margin-bottom:8px;
  border-left:3px solid var(--red);
}
.ev-time{font-size:0.8rem;color:rgba(255,255,255,0.55);min-width:44px;padding-top:2px;flex-shrink:0;}
.ev-body{flex:1;}
.ev-title{font-weight:500;font-size:0.95rem;}
.ev-note{font-size:0.8rem;opacity:0.5;margin-top:3px;}
.day-tabs{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:14px;}
.day-tab{
  padding:5px 13px;border-radius:20px;font-size:0.8rem;font-weight:500;
  cursor:pointer;border:1px solid var(--glass-b);
  background:rgba(255,255,255,0.07);color:white;
  transition:background 0.18s,border-color 0.18s;
  -webkit-tap-highlight-color:transparent;touch-action:manipulation;
}
.day-tab.active{background:var(--red);border-color:var(--red);}
.ev-form{display:none;margin-top:12px;padding-top:14px;border-top:1px solid var(--glass-b);}
.ev-form.on{display:block;}

/* â”€â”€ Memories â”€â”€ */
.mem-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.mem-cell{aspect-ratio:1;border-radius:10px;overflow:hidden;cursor:pointer;position:relative;background:rgba(255,255,255,0.05);}
.mem-cell img{width:100%;height:100%;object-fit:cover;transition:transform 0.2s;}
.mem-cell:active img{transform:scale(1.06);}
.mem-del{
  position:absolute;top:4px;right:4px;
  background:rgba(0,0,0,0.65);border:none;color:white;
  border-radius:50%;width:24px;height:24px;font-size:0.7rem;
  cursor:pointer;display:none;align-items:center;justify-content:center;
}
.mem-cell:hover .mem-del{display:flex;}
.mem-cap{
  position:absolute;bottom:0;left:0;right:0;
  background:linear-gradient(transparent,rgba(0,0,0,0.7));
  padding:8px 6px 5px;font-size:0.7rem;
  opacity:0;transition:opacity 0.2s;
}
.mem-cell:hover .mem-cap{opacity:1;}
.mem-preview{display:none;margin-bottom:14px;}
.mem-preview.on{display:block;}

/* â”€â”€ Traveler settings â”€â”€ */
#travelerSettingsList .item-row input[type="text"]{
  background:rgba(255,255,255,0.08);border:1px solid var(--glass-b);
  border-radius:8px;color:#fff;font-family:'DM Sans',sans-serif;
}
#travelerSettingsList .item-row input[type="text"]:focus{
  border-color:rgba(255,255,255,0.5);outline:none;
}
.notes-ok{font-size:0.75rem;color:#4caf50;}

/* â”€â”€ Dropbox guide â”€â”€ */
.help-step{display:flex;gap:12px;margin-bottom:16px;align-items:flex-start;}
.step-n{
  background:var(--red);color:white;border-radius:50%;
  width:24px;height:24px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-size:0.75rem;font-weight:700;margin-top:2px;
}
code{font-family:monospace;}

/* â”€â”€ Confetti â”€â”€ */
.cp{position:fixed;top:-12px;z-index:9999;pointer-events:none;animation:cfFall linear forwards;}
@keyframes cfFall{to{top:110vh;transform:rotate(720deg) translateX(var(--drift));}}

/* â”€â”€ Tab slider â”€â”€ */
.tabs-vp{overflow:hidden;}
.tabs-sl{display:flex;transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);will-change:transform;}
.tab-pnl{min-width:100%;}

/* â”€â”€ Bottom tab bar â”€â”€ */
.tab-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:200;
  background:rgba(10,10,26,0.97);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:1px solid rgba(255,255,255,0.1);
  display:flex;
  padding-bottom:var(--sab);
  padding-left:var(--sal);padding-right:var(--sar);
}
.tab-btn{
  flex:1;display:flex;flex-direction:column;
  align-items:center;gap:3px;padding:12px 4px 8px;
  border:none;background:none;color:rgba(255,255,255,0.38);
  cursor:pointer;font-family:'DM Sans',sans-serif;
  font-size:0.65rem;font-weight:500;letter-spacing:0.3px;
  transition:color 0.2s;-webkit-tap-highlight-color:transparent;
  min-height:52px;touch-action:manipulation;
}
.t-icon{font-size:1.35rem;line-height:1;transition:transform 0.2s;display:block;}
.tab-btn.active{color:#fff;}
.tab-btn.active .t-icon{transform:translateY(-2px);}
.tab-btn::after{
  content:'';display:block;width:22px;height:3px;
  border-radius:2px;background:var(--red);
  opacity:0;transform:scaleX(0);
  transition:opacity 0.2s,transform 0.2s;margin-top:2px;
}
.tab-btn.active::after{opacity:1;transform:scaleX(1);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS (bottom-sheet style)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-bd{
  position:fixed;inset:0;background:rgba(0,0,0,0.7);
  z-index:500;display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;
  transition:opacity 0.3s;
  backdrop-filter:blur(4px);
}
.modal-bd.open{opacity:1;pointer-events:all;}
.modal-sh{
  width:100%;max-width:520px;
  background:#111a28;
  border:1px solid var(--glass-b);
  border-radius:28px 28px 0 0;
  padding:12px 26px calc(var(--sab)+32px);
  transform:translateY(30px);
  transition:transform 0.35s cubic-bezier(0.34,1.2,0.64,1);
}
.modal-bd.open .modal-sh{transform:translateY(0);}
.modal-handle{width:40px;height:4px;background:rgba(255,255,255,0.15);border-radius:2px;margin:0 auto 22px;}
.modal-title{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;margin-bottom:5px;}
.modal-sub{font-size:0.78rem;color:var(--dim);margin-bottom:20px;line-height:1.5;}
.modal-field{margin-bottom:14px;}
.modal-field label{
  display:block;font-size:0.67rem;letter-spacing:0.14em;
  text-transform:uppercase;color:var(--dim);margin-bottom:7px;
}
.modal-field input{
  width:100%;padding:13px 14px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:11px;color:#fff;
  font-family:'DM Sans',sans-serif;font-size:1rem;
  outline:none;transition:border-color 0.2s;
  -webkit-appearance:none;
}
.modal-field input:focus{border-color:var(--red);}
.modal-field input::placeholder{color:var(--dim);}
.modal-err{font-size:0.78rem;color:#ff6b6b;min-height:18px;margin-bottom:10px;}
.modal-btns{display:flex;gap:10px;}
.modal-btns .btn-primary{flex:1;}
.btn-cancel{
  padding:14px 18px;
  background:rgba(255,255,255,0.07);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:11px;color:var(--dim);
  font-family:'DM Sans',sans-serif;font-size:0.88rem;
  cursor:pointer;touch-action:manipulation;
}

/* Destination preview */
.dest-prev{width:100%;height:110px;border-radius:11px;overflow:hidden;margin-bottom:14px;display:none;position:relative;}
.dest-prev img{width:100%;height:100%;object-fit:cover;}
.dest-prev-lbl{position:absolute;bottom:0;left:0;right:0;padding:7px 11px;background:linear-gradient(transparent,rgba(10,10,26,0.8));font-size:0.72rem;color:rgba(255,255,255,0.8);}

/* Toast */
.toast{
  position:fixed;bottom:calc(var(--sab)+88px);left:50%;
  transform:translateX(-50%) translateY(16px);
  background:#1a2f45;border:1px solid var(--glass-b);
  border-radius:30px;padding:9px 20px;
  font-size:0.8rem;color:var(--sand);z-index:800;
  opacity:0;transition:opacity 0.2s,transform 0.2s;
  white-space:nowrap;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* Travelers in settings (coloured avatars, no rename) */
.trav-row{
  display:flex;align-items:center;gap:12px;
  padding:12px 14px;
  background:rgba(255,255,255,0.05);border-radius:10px;margin-bottom:8px;
}
.trav-av{
  width:36px;height:36px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:600;font-size:0.82rem;color:#0a0a1a;flex-shrink:0;
}
.trav-info{flex:1;}
.trav-name{font-size:0.9rem;font-weight:500;}
.trav-role{font-size:0.7rem;color:var(--dim);text-transform:uppercase;letter-spacing:0.08em;margin-top:2px;}
.trav-badge{padding:3px 9px;border-radius:20px;font-size:0.63rem;letter-spacing:0.1em;text-transform:uppercase;font-weight:500;}
.b-owner{background:rgba(220,20,60,0.2);color:var(--red);}
.b-traveler{background:rgba(39,174,96,0.15);color:#6fcf97;}

@media(min-width:600px){
  .modal-bd{align-items:center;}
  .modal-sh{border-radius:24px;padding-bottom:28px;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR RANGE PICKER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cal-wrap{ position:relative; }
.cal-display{
  display:flex; align-items:center; justify-content:space-between;
  width:100%; padding:13px 14px; box-sizing:border-box;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:11px; cursor:pointer;
  font-size:0.9rem; color:#fff;
  transition:border-color 0.2s;
}
.cal-display:hover,.cal-display:focus{ border-color:rgba(255,255,255,0.35); outline:none; }
.cal-picker{
  position:relative;
  background:rgba(18,18,36,0.98);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:16px; padding:16px;
  margin-top:8px; z-index:50;
  box-shadow:0 8px 40px rgba(0,0,0,0.6);
}
.cal-nav{
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:12px;
}
.cal-month-title{ font-weight:700; font-size:0.95rem; }
.cal-nav-btn{
  background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12);
  border-radius:8px; color:#fff; width:32px; height:32px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:1.1rem;
  transition:background 0.15s;
}
.cal-nav-btn:hover{ background:rgba(255,255,255,0.18); }
.cal-grid{
  display:grid; grid-template-columns:repeat(7,1fr);
  gap:2px; margin-bottom:10px;
}
.cal-dow{
  text-align:center; font-size:0.65rem; font-weight:600;
  color:rgba(255,255,255,0.4); padding:4px 0;
  text-transform:uppercase; letter-spacing:0.05em;
}
.cal-day{
  aspect-ratio:1; display:flex; align-items:center; justify-content:center;
  border-radius:8px; font-size:0.82rem; cursor:pointer;
  border:none; background:transparent; color:#fff;
  transition:background 0.12s, color 0.12s;
  min-height:34px;
}
.cal-day:hover:not(.cal-empty):not(.cal-past){ background:rgba(255,255,255,0.12); }
.cal-day.cal-empty{ pointer-events:none; }
.cal-day.cal-past{ opacity:0.3; pointer-events:none; }
.cal-day.cal-start,.cal-day.cal-end{
  background:var(--red) !important; color:#fff !important;
  font-weight:700; border-radius:8px;
}
.cal-day.cal-in-range{
  background:rgba(220,20,60,0.18); border-radius:0;
}
.cal-day.cal-start.cal-in-range,.cal-day.cal-start{ border-radius:8px 0 0 8px; }
.cal-day.cal-end.cal-in-range,.cal-day.cal-end{ border-radius:0 8px 8px 0; }
.cal-day.cal-start.cal-end{ border-radius:8px !important; }
.cal-day.cal-today{ font-weight:700; text-decoration:underline; }
.cal-hint{
  text-align:center; font-size:0.75rem; color:rgba(255,255,255,0.45);
  margin-bottom:12px; min-height:18px;
}
.cal-actions{
  display:flex; gap:8px; justify-content:flex-end; margin-top:4px;
}
.cal-actions .btn-cancel{
  padding:8px 16px; border-radius:9px;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
  color:#fff; cursor:pointer; font-size:0.85rem;
}
.cal-actions .btn-primary{
  padding:8px 18px; border-radius:9px;
  background:linear-gradient(135deg,var(--red),var(--red-dark));
  border:none; color:#fff; cursor:pointer; font-size:0.85rem; font-weight:600;
}
.cal-actions .btn-primary:disabled{
  opacity:0.35; cursor:not-allowed;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” Mobile-first, single source of truth
   Covers: Pixel 10 (412px), iPhone SE (375px),
   iPhone 15 Pro Max (430px), iPad, Desktop
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Universal fixes applied to all screen sizes */
html, body { overflow-x: hidden; }

/* Minimum 44px tap targets (Apple/Google HIG) */
button { min-height: 44px; }
.btn-sm, .auth-tab { min-height: 36px; }
.del-btn, .mem-del { min-height: 36px; min-width: 36px; }

/* Prevent iOS/Android zoom on input focus (requires â‰¥16px) */
input, textarea, select { font-size: 16px !important; }

/* Word-wrap inside cards */
.tc-dest, .trav-name, .item-name, .ev-title { word-break: break-word; }

/* Tab slider must never create horizontal scroll */
.tabs-vp { overflow: hidden; }
.tab-pnl { min-width: 100%; box-sizing: border-box; overflow-x: hidden; }

/* Dashboard baseline padding (mobile-first) */
.dash-head    { padding-left: 16px; padding-right: 16px; }
.dash-lbl     { padding: 0 16px; }
.trips-scroll { padding: 0 16px calc(var(--sab) + 24px); }

/* â”€â”€ â‰¤ 430px: Pixel 10 (412px), iPhone SE (375px), iPhone 15 (390px) â”€â”€ */
@media (max-width: 430px) {
  :root { --cd-h: 60px; --tab-h: 58px; }
  .auth-logo   { font-size: 2.3rem; }
  .auth-tag    { font-size: 0.68rem; margin-bottom: 24px; }
  .auth-card   { padding: 20px 16px; border-radius: 20px; }
  .auth-bg-word { font-size: 22vw; }
  .dash-greeting { font-size: 1.55rem; }
  .trip-card   { height: 170px; }
  .tc-dest     { font-size: 1.4rem; }
  .btn-new, .btn-join { font-size: 0.85rem; padding: 11px 12px; }
  .trip-hdr h1 { font-size: 2.1rem; }
  .trip-hdr    { padding: 20px 0 14px; }
  .cd-num      { font-size: 1.65rem; }
  .cd-lbl      { font-size: 0.5rem; letter-spacing: 0.8px; }
  .cd-sep      { font-size: 1.2rem; padding: 0 2px; }
  #btnBackToTrips { font-size: 0.7rem; padding: 6px 10px; }
  .tab-btn     { font-size: 0.6rem; padding: 9px 2px 5px; }
  .t-icon      { font-size: 1.2rem; }
  .glass       { padding: 14px; border-radius: 16px; }
  .mem-grid    { grid-template-columns: repeat(3, 1fr); gap: 6px; }
  .modal-sh    { padding: 12px 16px calc(var(--sab) + 18px); border-radius: 24px 24px 0 0; }
  .modal-title { font-size: 1.25rem; }
  .ev-form .input-row { flex-direction: column; }
  select#evDay, input#evTime { flex: none; max-width: 100%; }
}

/* â”€â”€ 431â€“600px: large phones â”€â”€ */
@media (min-width: 431px) and (max-width: 600px) {
  .auth-logo   { font-size: 2.7rem; }
  .trip-hdr h1 { font-size: 2.6rem; }
  .dash-greeting { font-size: 1.72rem; }
  .trip-card   { height: 185px; }
  .glass       { padding: 18px; }
}

/* â”€â”€ â‰¥ 601px: tablets â”€â”€ */
@media (min-width: 601px) {
  .dash-head    { padding-left: 28px; padding-right: 28px; padding-top: max(24px, calc(var(--sat) + 24px)); }
  .dash-lbl     { padding: 0 28px; }
  .trips-scroll { padding: 0 28px calc(var(--sab) + 28px); }
  .scroll-wrap  { padding-left: max(28px, var(--sal)); padding-right: max(28px, var(--sar)); }
  .trip-card    { height: 210px; }
  .tc-dest      { font-size: 1.85rem; }
  .mem-grid     { grid-template-columns: repeat(4, 1fr); }
  .auth-card    { max-width: 460px; }
  .modal-bd     { align-items: center; }
  .modal-sh     { border-radius: 24px; padding-bottom: 28px; max-width: 540px; }
}

/* â”€â”€ â‰¥ 901px: desktop â”€â”€ */
@media (min-width: 901px) {
  :root { --cd-h: 72px; }
  .dash-inner   { max-width: 960px; }
  .dash-head    { padding-left: 40px; padding-right: 40px; }
  .dash-lbl     { padding: 0 40px; }
  .trips-scroll { padding: 0 40px calc(var(--sab) + 32px); }
  .scroll-wrap  { max-width: 960px; padding-left: max(40px, var(--sal)); padding-right: max(40px, var(--sar)); }
  .mem-grid     { grid-template-columns: repeat(5, 1fr); }
  .tab-bar      { max-width: 960px; left: 50%; transform: translateX(-50%); }
  #cdBar        { padding-left: max(40px, var(--sal)); padding-right: max(40px, var(--sar)); }
  .trip-card    { height: 230px; margin-bottom: 0; }
  .modal-sh     { border-radius: 24px; max-width: 580px; }
  .auth-card    { max-width: 460px; }
  /* Two-column trip card grid on tablet/desktop */
  .trips-inner  { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
  .dash-empty   { grid-column: 1 / -1; }
}

/* â”€â”€ â‰¥ 1201px: wide desktop â”€â”€ */
@media (min-width: 1201px) {
  .dash-inner   { max-width: 1200px; }
  .dash-head    { padding-left: 56px; padding-right: 56px; }
  .dash-lbl     { padding: 0 56px; }
  .trips-scroll { padding: 0 56px calc(var(--sab) + 40px); }
  #trips-list   { width: 100%; }
  .scroll-wrap  { max-width: 1100px; padding-left: 56px; padding-right: 56px; }
  .tab-bar      { max-width: 1100px; left: 50%; transform: translateX(-50%); border-radius: 20px 20px 0 0; }
  #cdBar        { padding-left: max(56px, var(--sal)); padding-right: max(56px, var(--sar)); }
  .mem-grid     { grid-template-columns: repeat(6, 1fr); }
  .modal-sh     { border-radius: 24px; max-width: 680px; }
  .trip-card    { height: 250px; }
  .auth-card    { max-width: 500px; }
  /* Three-column grid on large desktop */
  .trips-inner  { grid-template-columns: repeat(3, 1fr); gap: 20px; }
  /* Desktop auth: two-column layout */
  #s-auth       { flex-direction: row; align-items: stretch; }
  .auth-brand-col {
    flex: 1; display: flex; flex-direction: column;
    justify-content: center; padding: 60px 48px;
    background: linear-gradient(160deg, rgba(200,169,110,0.12) 0%, transparent 60%);
    border-right: 1px solid rgba(255,255,255,0.06);
  }
  .auth-form-col {
    flex: 0 0 520px; display: flex; align-items: center;
    justify-content: center; padding: 60px 48px;
  }
  .auth-bg-word { display: none; }
  .auth-logo    { font-size: 3.5rem; text-align: left; margin-bottom: 12px; }
  .auth-tagline-desktop { display: block; }
}

/* â”€â”€ Landscape on small phones â”€â”€ */
@media (max-height: 500px) and (orientation: landscape) {
  :root { --cd-h: 48px; }
  .cd-lbl      { display: none; }
  .trip-hdr h1 { font-size: 1.8rem; }
  .trip-hdr    { padding: 8px 0; }
  .tab-btn     { padding: 5px 4px 3px; }
  #s-auth      { padding: 14px 20px; }
  .auth-logo   { font-size: 1.9rem; margin-bottom: 0; }
  .auth-tag    { margin-bottom: 10px; }
  .auth-card   { padding: 12px 16px; }
}

/* â”€â”€ Touch screens: disable desktop-only hover effects â”€â”€ */
@media (hover: none) {
  .trip-card:hover .tc-bg    { transform: none; }
  .mem-cell:hover .mem-del   { display: none; }
  .mem-cell:active .mem-del  { display: flex; }
  .mem-cell:hover .mem-cap   { opacity: 0; }
  .mem-cell:active .mem-cap  { opacity: 1; }
}

</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â‘  AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-auth" class="screen active">
  <!-- Desktop: brand column (hidden on mobile) -->
  <div class="auth-brand-col">
    <div class="auth-logo" style="font-size:4rem;">All<span>abroad</span></div>
    <div class="auth-tag" style="font-size:1rem;opacity:0.7;margin-top:12px;text-align:left;">Plan together. Travel further.</div>
    <p style="margin-top:32px;opacity:0.45;font-size:0.9rem;line-height:1.7;max-width:340px;">Create trip itineraries, sync packing lists, and share everything in real time â€” all from one place.</p>
    <div style="margin-top:48px;display:flex;gap:16px;flex-wrap:wrap;">
      <div style="background:rgba(255,255,255,0.06);border-radius:12px;padding:14px 18px;font-size:0.8rem;opacity:0.7;">âœˆï¸ Multi-trip support</div>
      <div style="background:rgba(255,255,255,0.06);border-radius:12px;padding:14px 18px;font-size:0.8rem;opacity:0.7;">â˜ï¸ Cloud sync</div>
      <div style="background:rgba(255,255,255,0.06);border-radius:12px;padding:14px 18px;font-size:0.8rem;opacity:0.7;">ğŸ‘¥ Group planning</div>
    </div>
  </div>
  <!-- Form column (mobile: full width, desktop: right side) -->
  <div class="auth-form-col">
  <div class="auth-bg-word">Allabroad</div>
  <div class="auth-logo">All<span>abroad</span></div>
  <div class="auth-tag">Plan together. Travel further.</div>
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="setAuthTab('login')">Sign In</button>
      <button class="auth-tab" onclick="setAuthTab('signup')">Sign Up</button>
    </div>
    <div id="auth-login">
      <div class="auth-field"><label>Email</label>
        <input type="email" id="li-user" placeholder="jane@example.com" autocomplete="email"
          onkeydown="if(event.key==='Enter')document.getElementById('li-pass').focus()"></div>
      <div class="auth-field"><label>Password</label>
        <input type="password" id="li-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"
          onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div class="auth-err" id="li-err"></div>
      <button class="btn-primary" onclick="doLogin()">Sign In â†’</button>
      <div style="text-align:center;margin-top:12px;">
        <button onclick="openForgotPassword()" style="background:none;border:none;color:var(--dim);font-size:0.78rem;font-family:'DM Sans',sans-serif;cursor:pointer;text-decoration:underline;text-underline-offset:3px;touch-action:manipulation;" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--dim)'">Forgot password?</button>
      </div>
    </div>
    <div id="auth-signup" style="display:none">
      <div style="display:flex;gap:10px;">
        <div class="auth-field" style="flex:1"><label>First Name</label>
          <input type="text" id="su-fname" placeholder="Jane" autocomplete="given-name"
            onkeydown="if(event.key==='Enter')document.getElementById('su-lname').focus()"></div>
        <div class="auth-field" style="flex:1"><label>Last Name</label>
          <input type="text" id="su-lname" placeholder="Smith" autocomplete="family-name"
            onkeydown="if(event.key==='Enter')document.getElementById('su-email').focus()"></div>
      </div>
      <div class="auth-field"><label>Email</label>
        <input type="email" id="su-email" placeholder="jane@example.com" autocomplete="email"
          onkeydown="if(event.key==='Enter')document.getElementById('su-pass').focus()"></div>
      <div class="auth-field"><label>Password</label>
        <input type="password" id="su-pass" placeholder="min 6 characters" autocomplete="new-password"
          onkeydown="if(event.key==='Enter')document.getElementById('su-pass2').focus()"></div>
      <div class="auth-field"><label>Confirm Password</label>
        <input type="password" id="su-pass2" placeholder="repeat password" autocomplete="new-password"
          onkeydown="if(event.key==='Enter')doSignup()"></div>
      <div class="auth-err" id="su-err"></div>
      <button class="btn-primary" onclick="doSignup()">Create Account â†’</button>
    </div>
    <div class="auth-or">â€” or â€”</div>
    <button class="btn-ghost" onclick="doGuest()">Continue as Guest</button>
  </div>
  </div><!-- /auth-form-col -->
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â‘¡ DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-dash" class="screen">
  <div class="dash-inner">
  <div class="dash-head">
    <div class="dash-topbar">
      <div class="dash-logo">All<span>abroad</span></div>
      <div class="dash-user-row">
        <button class="dash-signout" onclick="openAccountSettings()" style="color:var(--dim);">âš™ï¸ Account</button>
        <button class="dash-signout" onclick="doLogout()">Sign out</button>
        <div class="dash-avatar" id="dash-av" onclick="openAccountSettings()" style="cursor:pointer;">?</div>
      </div>
    </div>
    <div class="dash-greeting">Good <em id="dash-tod">day</em>,<br><span id="dash-uname">Traveller</span></div>
    <div class="dash-sub">âœ¦ Ready to explore</div>
    <div class="dash-actions">
      <button class="btn-new" onclick="openNewTrip()"><span style="font-size:1.2rem;font-weight:300;">+</span> New Trip</button>
      <button class="btn-join" onclick="openJoinTrip()">ğŸ”— Join Trip</button>
    </div>
  </div>
  <div class="dash-lbl" id="dash-lbl">Your Trips</div>
  <div class="trips-scroll"><div id="trips-list" class="trips-inner"></div></div>
  </div><!-- /dash-inner -->
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     â‘¢ TRIP INTERIOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-trip" class="screen">
  <div class="trip-bg" id="tripBg"></div>
  <div class="airplane">âœˆï¸</div>

  <!-- Countdown bar (with back button) -->
  <div id="cdBar">
    <button id="btnBackToTrips" onclick="goToDash()">â† Trips</button>
    <div class="cd-cell" id="cdDaysCell"><span class="cd-num" id="cdDays">--</span><span class="cd-lbl">Days</span></div>
    <span class="cd-sep">:</span>
    <div class="cd-cell" id="cdHoursCell"><span class="cd-num" id="cdHours">--</span><span class="cd-lbl">Hours</span></div>
    <span class="cd-sep">:</span>
    <div class="cd-cell" id="cdMinsCell"><span class="cd-num" id="cdMins">--</span><span class="cd-lbl">Mins</span></div>
    <div id="arrivedPill">ğŸ‰ You're there!</div>
  </div>

  <!-- Scrollable content -->
  <div class="scroll-wrap">

    <!-- Trip heading -->
    <div class="trip-hdr">
      <h1 id="tripTitle">Destination<span>.</span></h1>
      <p class="trip-hdr-sub" id="tripSubtitle">Dates TBD</p>
    </div>

    <!-- Weather + sync strip -->
    <div class="glass" style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;">
      <div>
        <div id="tripTemp" style="font-size:1.4rem;font-weight:700;">--Â°C</div>
        <div id="tripSky"  style="font-size:0.78rem;opacity:0.6;margin-top:2px;">Loading weatherâ€¦</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:0.7rem;opacity:0.4;margin-top:2px;" id="tripCodeStrip"></div>
      </div>
    </div>

    <!-- Tab panels -->
    <div class="tabs-vp">
      <div class="tabs-sl" id="tabsSlider">

        <!-- TAB 0: PREP -->
        <div class="tab-pnl">
          <div class="glass" style="padding:12px 16px;margin-bottom:14px;">
            <div style="font-size:0.72rem;opacity:0.5;letter-spacing:1px;text-transform:uppercase;margin-bottom:9px;">Viewing lists for</div>
            <div class="day-tabs" id="travelerTabs" style="margin-bottom:0;"></div>
          </div>
          <div class="glass">
            <h3 style="margin-bottom:14px;">ğŸ›ï¸ Buy Before Trip</h3>
            <div class="input-row">
              <input type="text" id="shopInput" placeholder="Add itemâ€¦" onkeydown="if(event.key==='Enter')addItem('shopping','shopInput')">
              <button class="btn btn-red" onclick="addItem('shopping','shopInput')">Add</button>
            </div>
            <div id="shopList"></div>
          </div>
          <div class="glass">
            <h3 style="margin-bottom:14px;">ğŸ“¦ Packing List</h3>
            <div class="input-row">
              <input type="text" id="packInput" placeholder="Add itemâ€¦" onkeydown="if(event.key==='Enter')addItem('packing','packInput')">
              <button class="btn btn-red" onclick="addItem('packing','packInput')">Add</button>
            </div>
            <div id="packList"></div>
          </div>
          <div class="glass">
            <h3 style="margin-bottom:14px;">ğŸ—ºï¸ Shopping There</h3>
            <div class="input-row">
              <input type="text" id="ukShopInput" placeholder="Add itemâ€¦" onkeydown="if(event.key==='Enter')addItem('ukShopping','ukShopInput')">
              <button class="btn btn-red" onclick="addItem('ukShopping','ukShopInput')">Add</button>
            </div>
            <div id="ukShopList"></div>
          </div>
          <div class="glass">
            <div class="sec-hdr">
              <h3>ğŸ“ Shared Notes</h3>
              <span id="notesSavedLabel" class="notes-ok"></span>
            </div>
            <textarea id="notesArea" placeholder="Hotel confirmations, addresses, things to rememberâ€¦"></textarea>
            <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
              <button class="btn btn-red" onclick="saveNotes()">Save Notes</button>
              <span style="font-size:0.8rem;opacity:0.4;">Syncs to all devices</span>
            </div>
          </div>
        </div>

        <!-- TAB 1: TRIP -->
        <div class="tab-pnl">
          <div class="glass">
            <div class="sec-hdr">
              <h3>ğŸ—“ï¸ Itinerary</h3>
              <button class="btn btn-sm btn-red" onclick="showAddEvent()">+ Add</button>
            </div>
            <div class="day-tabs" id="dayTabs"></div>
            <div id="itineraryList"></div>
            <div class="ev-form" id="eventForm">
              <div style="font-size:0.85rem;font-weight:600;margin-bottom:10px;opacity:0.7;" id="evFormTitle">Add Event</div>
              <div class="input-row">
                <select id="evDay" style="flex:0 0 auto;max-width:108px;"></select>
                <input type="time" id="evTime" style="flex:0 0 108px;">
                <input type="text" id="evTitle" placeholder="Event title" onkeydown="if(event.key==='Enter')saveEvent()">
              </div>
              <div class="input-row">
                <input type="text" id="evNote" placeholder="Note (optional)" onkeydown="if(event.key==='Enter')saveEvent()">
              </div>
              <div style="display:flex;gap:8px;">
                <button class="btn btn-red" id="evSaveBtn" onclick="saveEvent()">Save Event</button>
                <button class="btn btn-glass" onclick="cancelEvent()">Cancel</button>
              </div>
            </div>
          </div>
          <div class="glass">
            <h3 style="margin-bottom:14px;">ğŸŸï¸ Ticket Vault</h3>
            <div class="input-row">
              <input type="text" id="ticketName" placeholder="Ticket nameâ€¦" onkeydown="if(event.key==='Enter')addTicket()">
              <input type="file" id="ticketFile" accept="image/*" style="display:none" onchange="processImage(this,'ticket')">
              <button class="btn btn-glass btn-icon" onclick="document.getElementById('ticketFile').click()">ğŸ“·</button>
              <button class="btn btn-red" onclick="addTicket()">Save</button>
            </div>
            <div class="photo-preview" id="photoPreview">
              <img id="previewImg" style="height:52px;border-radius:7px;border:1px solid var(--glass-b);" alt="">
              <span style="flex:1;font-size:0.85rem;opacity:0.8;">Photo ready âœ…</span>
              <button onclick="clearTicketPhoto()" class="del-btn">âœ•</button>
            </div>
            <div id="ticketList"></div>
          </div>
        </div>

        <!-- TAB 2: MEMORIES -->
        <div class="tab-pnl">
          <div class="glass">
            <div class="sec-hdr">
              <h3>ğŸ“¸ Memories</h3>
              <input type="file" id="memFile" accept="image/*" style="display:none" onchange="processImage(this,'memory')">
              <button class="btn btn-sm btn-red" onclick="document.getElementById('memFile').click()">+ Photo</button>
            </div>
            <div class="mem-preview" id="memPreviewRow">
              <img id="memPreviewImg" style="height:70px;border-radius:8px;border:1px solid var(--glass-b);display:block;margin-bottom:10px;" alt="">
              <div class="input-row" style="margin-bottom:0;">
                <input type="text" id="memCaption" placeholder="Caption (optional)" onkeydown="if(event.key==='Enter')addMemory()">
                <button class="btn btn-red" onclick="addMemory()">Add</button>
                <button class="btn btn-glass" onclick="cancelMemory()">âœ•</button>
              </div>
            </div>
            <div id="memoriesGrid" class="mem-grid"></div>
          </div>
        </div>

        <!-- TAB 3: SETTINGS -->
        <div class="tab-pnl">

          <!-- Sync status pill â€” no user-facing Dropbox config needed -->
          <div class="glass" style="padding:14px 18px;display:flex;align-items:center;justify-content:space-between;">
            <div style="font-size:0.85rem;font-weight:600;">Cloud Sync</div>
            <div style="display:flex;align-items:center;gap:8px;">
              <div id="syncDot" style="width:8px;height:8px;border-radius:50%;background:#4caf50;box-shadow:0 0 6px #4caf50;"></div>
              <div id="syncStatus" style="font-size:0.8rem;color:#4caf50;">Connected</div>
              <button class="btn btn-glass btn-icon" onclick="syncFromCloud()" title="Sync now" style="padding:6px 10px;font-size:0.85rem;">ğŸ”„</button>
            </div>
          </div>

          <!-- Trip Dates â€” organiser can edit -->
          <div class="glass" style="padding:14px 18px;" id="tripDatesCard">
            <div style="font-size:0.85rem;font-weight:600;margin-bottom:3px;">ğŸ“… Trip Dates</div>
            <div style="font-size:0.72rem;opacity:0.5;margin-bottom:12px;" id="tripDatesHint">Tap to change your travel dates.</div>
            <div class="cal-wrap" id="ed-cal-wrap">
              <div class="cal-display" id="ed-dates-display" onclick="calToggle('ed')" tabindex="0"
                onkeydown="if(event.key==='Enter'||event.key===' ')calToggle('ed')">
                <span id="ed-dates-label">Loadingâ€¦</span>
                <span style="opacity:0.4;font-size:0.8rem;">ğŸ“…</span>
              </div>
              <div class="cal-picker" id="ed-cal" style="display:none;">
                <div class="cal-nav">
                  <button type="button" onclick="calPrev('ed')" class="cal-nav-btn">â€¹</button>
                  <span id="ed-cal-title" class="cal-month-title"></span>
                  <button type="button" onclick="calNext('ed')" class="cal-nav-btn">â€º</button>
                </div>
                <div class="cal-grid" id="ed-cal-grid"></div>
                <div class="cal-hint" id="ed-cal-hint">Tap a start date</div>
                <div class="cal-actions">
                  <button type="button" class="btn-cancel" onclick="calClear('ed')">Clear</button>
                  <button type="button" class="btn-primary" id="ed-cal-confirm" onclick="calConfirm('ed')" disabled>Save Dates â†’</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Travelers â€” read-only view (Allabroad handles adding via join codes) -->
          <div class="glass" style="padding:14px 18px;">
            <div style="font-size:0.85rem;font-weight:600;margin-bottom:3px;">ğŸ‘¥ Travelers</div>
            <div style="font-size:0.72rem;opacity:0.5;margin-bottom:12px;">Share the join code to invite others. Each person gets their own prep lists.</div>
            <div id="travelerSettingsList"></div>
            <div style="margin-top:10px;padding:10px 14px;background:rgba(220,20,60,0.08);border:1px solid rgba(220,20,60,0.2);border-radius:10px;font-size:0.8rem;display:flex;align-items:center;justify-content:space-between;">
              <span style="color:var(--dim);">Join code:</span>
              <span id="settingsCodeDisplay" style="font-weight:600;letter-spacing:0.15em;color:var(--sand);cursor:pointer;" onclick="copyTripCode()">â€”â€”</span>
            </div>
          </div>

          <!-- Notifications -->
          <div class="glass" style="padding:14px 18px;">
            <div style="font-size:0.85rem;font-weight:600;margin-bottom:6px;">ğŸ”” Notifications</div>
            <div style="font-size:0.78rem;opacity:0.55;margin-bottom:12px;">Get a morning alert each day counting down to your trip.</div>
            <button class="btn btn-glass" style="width:100%;" onclick="requestNotifPermission()">Enable Morning Alerts</button>
            <div id="notifStatus" style="font-size:0.75rem;opacity:0.5;margin-top:8px;text-align:center;">Alerts: Off</div>
          </div>

          <!-- Danger zone -->
          <div class="glass" style="padding:14px 18px;">
            <div style="font-size:0.85rem;font-weight:600;margin-bottom:6px;">âš ï¸ Danger Zone</div>
            <div style="font-size:0.78rem;opacity:0.55;margin-bottom:12px;">Destructive actions for organisers only.</div>
            <button class="btn btn-glass" style="width:100%;border-color:rgba(220,20,60,0.4);color:rgba(255,100,100,0.85);margin-bottom:10px;" onclick="resetApp()">ğŸ”„ Reset Trip Data</button>
            <div id="deleteTripBtnWrap" style="display:none;">
              <button class="btn btn-glass" style="width:100%;border-color:rgba(255,69,96,0.6);color:#ff4560;background:rgba(255,69,96,0.1);"
                onclick="openDeleteTrip(openTripId)">ğŸ—‘ Delete Trip Permanently</button>
            </div>
          </div>

        </div>
      </div><!-- /tabs-sl -->
    </div><!-- /tabs-vp -->


  </div><!-- /scroll-wrap -->

  <!-- Bottom tab bar -->
  <nav class="tab-bar" id="tripTabBar">
    <button class="tab-btn active" id="tab-0" onclick="switchTab(0)"><span class="t-icon">âœˆï¸</span>Prep</button>
    <button class="tab-btn" id="tab-1" onclick="switchTab(1)"><span class="t-icon">ğŸ—“ï¸</span>Trip</button>
    <button class="tab-btn" id="tab-2" onclick="switchTab(2)"><span class="t-icon">ğŸ“¸</span>Memories</button>
    <button class="tab-btn" id="tab-3" onclick="switchTab(3)"><span class="t-icon">âš™ï¸</span>Settings</button>
  </nav>
</div>

<!-- Fullscreen image modal -->
<div class="img-modal" id="imgModal" onclick="closeImgModal()">
  <img id="fullImg" alt="Full size">
  <span class="img-modal-x">âœ• Tap to close</span>
</div>

<!-- Dashboard modals -->
<div class="modal-bd" id="md-new-trip">
  <div class="modal-sh">
    <div class="modal-handle"></div>
    <div class="modal-title">New Trip</div>
    <div class="modal-sub">Where to? We'll pick a photo and generate a join code automatically.</div>
    <div class="dest-prev" id="dest-prev"><img id="dest-prev-img" src="" alt=""><div class="dest-prev-lbl" id="dest-prev-lbl"></div></div>
    <div class="modal-field"><label>Destination</label>
      <input type="text" id="nd-dest" placeholder="e.g. Tokyo, Amalfi Coast, Maldives" oninput="onDestInput(this.value)" onkeydown="if(event.key==='Enter')document.getElementById('nd-dates').focus()"></div>
    <div class="modal-field"><label>Travel Dates</label>
      <div class="cal-wrap" id="nd-cal-wrap">
        <div class="cal-display" id="nd-dates-display" onclick="calToggle('nd')" tabindex="0"
          onkeydown="if(event.key==='Enter'||event.key===' ')calToggle('nd')">
          <span id="nd-dates-label">Select datesâ€¦</span>
          <span style="opacity:0.4;font-size:0.8rem;">ğŸ“…</span>
        </div>
        <div class="cal-picker" id="nd-cal" style="display:none;">
          <div class="cal-nav">
            <button type="button" onclick="calPrev('nd')" class="cal-nav-btn">â€¹</button>
            <span id="nd-cal-title" class="cal-month-title"></span>
            <button type="button" onclick="calNext('nd')" class="cal-nav-btn">â€º</button>
          </div>
          <div class="cal-grid" id="nd-cal-grid"></div>
          <div class="cal-hint" id="nd-cal-hint">Tap a start date</div>
          <div class="cal-actions">
            <button type="button" class="btn-cancel" onclick="calClear('nd')">Clear</button>
            <button type="button" class="btn-primary" id="nd-cal-confirm" onclick="calConfirm('nd')" disabled>Confirm â†’</button>
          </div>
        </div>
      </div>
      <input type="hidden" id="nd-dates" value=""></div>
    <div class="modal-err" id="nd-err"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeMd('md-new-trip')">Cancel</button>
      <button class="btn-primary" onclick="createTrip()">Create Trip â†’</button>
    </div>
  </div>
</div>

<div class="modal-bd" id="md-join-trip">
  <div class="modal-sh">
    <div class="modal-handle"></div>
    <div class="modal-title">Join a Trip</div>
    <div class="modal-sub">Enter the 6-character code shared by your trip organiser.</div>
    <div class="modal-field"><label>Join Code</label>
      <input type="text" id="jt-code" placeholder="e.g. AX7K9M" maxlength="6"
        style="text-transform:uppercase;letter-spacing:0.2em;font-size:1.1rem;text-align:center;"
        onkeydown="if(event.key==='Enter')joinTrip()"></div>
    <div class="modal-err" id="jt-err"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeMd('md-join-trip')">Cancel</button>
      <button class="btn-primary" onclick="joinTrip()">Join â†’</button>
    </div>
  </div>
</div>


<!-- Delete Trip Modal -->
<div class="modal-bd" id="md-delete-trip">
  <div class="modal-sh">
    <div class="modal-handle"></div>
    <div class="modal-title" style="color:#ff4560;">ğŸ—‘ Delete Trip</div>
    <div class="modal-sub">This permanently deletes the trip and all its data for <strong>every traveller</strong> on all devices. This cannot be undone.</div>
    <div id="dt-trip-name" style="margin:16px 0;padding:14px 16px;background:rgba(255,69,96,0.1);border:1px solid rgba(255,69,96,0.3);border-radius:12px;font-weight:700;font-size:1rem;text-align:center;letter-spacing:0.02em;"></div>
    <div class="modal-field">
      <label>Type the destination to confirm</label>
      <input type="text" id="dt-confirm" placeholder="" autocomplete="off"
        oninput="document.getElementById('dt-delete-btn').disabled=this.value.trim().toLowerCase()!==document.getElementById('dt-expected').value.toLowerCase()">
    </div>
    <input type="hidden" id="dt-trip-id" value="">
    <input type="hidden" id="dt-expected" value="">
    <div class="modal-err" id="dt-err"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeMd('md-delete-trip')">Cancel</button>
      <button class="btn-primary" id="dt-delete-btn" disabled
        style="background:linear-gradient(135deg,#ff4560,#c0002a);"
        onclick="confirmDeleteTrip()">Delete Forever â†’</button>
    </div>
  </div>
</div>

<!-- Account Settings Modal -->
<div class="modal-bd" id="md-account">
  <div class="modal-sh">
    <div class="modal-handle"></div>
    <div class="modal-title">Account</div>
    <div class="modal-sub" id="acct-sub">Manage your profile and password.</div>
    <div id="acct-profile" style="display:flex;align-items:center;gap:14px;margin-bottom:20px;padding:14px;background:rgba(255,255,255,0.05);border-radius:14px;">
      <div id="acct-av" style="width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;color:#0a0a1a;flex-shrink:0;"></div>
      <div>
        <div id="acct-name" style="font-weight:600;font-size:0.95rem;"></div>
        <div id="acct-email" style="font-size:0.75rem;color:var(--dim);margin-top:2px;"></div>
      </div>
    </div>
    <div style="font-size:0.78rem;font-weight:600;text-transform:uppercase;letter-spacing:0.12em;color:var(--dim);margin-bottom:12px;">Change Password</div>
    <div class="modal-field">
      <label>Current Password</label>
      <input type="password" id="cp-current" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
    </div>
    <div class="modal-field">
      <label>New Password</label>
      <input type="password" id="cp-new" placeholder="min 6 characters" autocomplete="new-password">
    </div>
    <div class="modal-field">
      <label>Confirm New Password</label>
      <input type="password" id="cp-new2" placeholder="repeat new password" autocomplete="new-password"
        onkeydown="if(event.key==='Enter')changePassword()">
    </div>
    <div class="modal-err" id="cp-err"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeMd('md-account')">Close</button>
      <button class="btn-primary" onclick="changePassword()">Update Password â†’</button>
    </div>
  </div>
</div>

<!-- Forgot Password Modal -->
<div class="modal-bd" id="md-forgot">
  <div class="modal-sh">
    <div class="modal-handle"></div>
    <div class="modal-title">Reset Password</div>
    <div class="modal-sub">Enter your email address and we'll show you your reset options.</div>
    <div class="modal-field">
      <label>Email Address</label>
      <input type="email" id="fp-email" placeholder="jane@example.com" autocomplete="email"
        onkeydown="if(event.key==='Enter')doForgotPassword()">
    </div>
    <div class="modal-err" id="fp-err"></div>
    <div id="fp-success" style="display:none;padding:14px;background:rgba(39,174,96,0.1);border:1px solid rgba(39,174,96,0.25);border-radius:11px;font-size:0.83rem;line-height:1.6;color:#6fcf97;margin-bottom:14px;"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeMd('md-forgot')">Cancel</button>
      <button class="btn-primary" id="fp-btn" onclick="doForgotPassword()">Send Reset Info â†’</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALLABROAD DB â€” localStorage, keyed per trip
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WAND_KEY = 'allabroad_v2';
function wDB()  { try{return JSON.parse(localStorage.getItem(WAND_KEY))||{users:{},trips:{}};}catch{return{users:{},trips:{}};} }
function wSave(db){ try{localStorage.setItem(WAND_KEY,JSON.stringify(db));}catch(e){} }

// Auth session â€” localStorage with 30-day TTL (survives tab/browser close)
let CU = null;
(function(){
  try{
    const raw = localStorage.getItem('allabroad_session');
    if(raw){
      const s = JSON.parse(raw);
      if(s && s.username && s.expires && Date.now() < s.expires){
        CU = {username: s.username};
        sessionStorage.setItem('allabroad_cu', JSON.stringify({username: s.username}));
      } else {
        localStorage.removeItem('allabroad_session');
      }
    }
  }catch(e){ localStorage.removeItem('allabroad_session'); }
})();

// Currently open trip id
let openTripId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DESTINATION PHOTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEST_PHOTOS = {
  tokyo:     'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=1600&q=80',
  japan:     'https://images.unsplash.com/photo-1528360983277-13d401cdc186?w=1600&q=80',
  paris:     'https://images.unsplash.com/photo-1499856871958-5b9627545d1a?w=1600&q=80',
  france:    'https://images.unsplash.com/photo-1431274172761-fca41d930114?w=1600&q=80',
  london:    'https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=1600&q=80',
  uk:        'https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=1600&q=80',
  rome:      'https://images.unsplash.com/photo-1552832230-c0197dd311b5?w=1600&q=80',
  italy:     'https://images.unsplash.com/photo-1555992336-03a23c7b20ee?w=1600&q=80',
  amalfi:    'https://images.unsplash.com/photo-1533587851505-d119e13fa0d7?w=1600&q=80',
  barcelona: 'https://images.unsplash.com/photo-1511527661048-7fe73d85e9a4?w=1600&q=80',
  spain:     'https://images.unsplash.com/photo-1543783207-ec64e4d95325?w=1600&q=80',
  bali:      'https://images.unsplash.com/photo-1537996194471-e657df975ab4?w=1600&q=80',
  maldives:  'https://images.unsplash.com/photo-1514282401047-d79a71a590e8?w=1600&q=80',
  dubai:     'https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=1600&q=80',
  iceland:   'https://images.unsplash.com/photo-1476610182048-b716b8518aae?w=1600&q=80',
  patagonia: 'https://images.unsplash.com/photo-1508193638397-1c4234db14d8?w=1600&q=80',
  morocco:   'https://images.unsplash.com/photo-1539020140153-e479b8c22e70?w=1600&q=80',
  amsterdam: 'https://images.unsplash.com/photo-1534351590666-13e3e96b5017?w=1600&q=80',
  bangkok:   'https://images.unsplash.com/photo-1508009603885-50cf7c8dd0d5?w=1600&q=80',
  thailand:  'https://images.unsplash.com/photo-1552465011-b4e21bf6e79a?w=1600&q=80',
  sydney:    'https://images.unsplash.com/photo-1524293581917-878a6d017c71?w=1600&q=80',
  australia: 'https://images.unsplash.com/photo-1494233892892-84542a694e72?w=1600&q=80',
  newyork:   'https://images.unsplash.com/photo-1496442226666-8d4d0e62e6e9?w=1600&q=80',
  nyc:       'https://images.unsplash.com/photo-1496442226666-8d4d0e62e6e9?w=1600&q=80',
  santorini: 'https://images.unsplash.com/photo-1570077188670-e3a8d69ac5ff?w=1600&q=80',
  greece:    'https://images.unsplash.com/photo-1533105079780-92b9be482077?w=1600&q=80',
  lisbon:    'https://images.unsplash.com/photo-1555881400-74d7acaacd8b?w=1600&q=80',
  prague:    'https://images.unsplash.com/photo-1540932239986-30128078f3c5?w=1600&q=80',
  singapore: 'https://images.unsplash.com/photo-1525625293386-3f8f99389edd?w=1600&q=80',
  default:   'https://images.unsplash.com/photo-1488085061387-422e29b40080?w=1600&q=80'
};

function getPhoto(dest){
  if(!dest) return DEST_PHOTOS.default;
  const k = dest.toLowerCase().replace(/[\s,.-]/g,'');
  for(const [kw,url] of Object.entries(DEST_PHOTOS)){
    if(kw==='default') continue;
    if(k.includes(kw)) return url;
  }
  return DEST_PHOTOS.default;
}

// Avatar colours
const AV_COLS = ['#c8a96e','#6fcf97','#56aef7','#e88c6a','#b39ddb','#80cbc4','#f48fb1','#ffe082'];
function avColor(u){ let h=0; for(let i=0;i<u.length;i++) h=(h*31+u.charCodeAt(i))&0xff; return AV_COLS[h%AV_COLS.length]; }
function initials(u){ return u.slice(0,2).toUpperCase(); }
function timeWord(){ const h=new Date().getHours(); return h<12?'morning':h<17?'afternoon':'evening'; }
function genCode(){ const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<6;i++) s+=c[Math.floor(Math.random()*c.length)]; return s; }
function saveSession(username){
  const s={username,expires:Date.now()+30*24*60*60*1000};
  localStorage.setItem('allabroad_session',JSON.stringify(s));
  sessionStorage.setItem('allabroad_cu',JSON.stringify({username}));
}
function clearSession(){
  localStorage.removeItem('allabroad_session');
  sessionStorage.removeItem('allabroad_cu');
}
function esc(s){ const m={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}; return String(s||'').replace(/[&<>"']/g,c=>m[c]); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id,skipHash){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('s-'+id).classList.add('active');
  if(!skipHash){
    if(id==='auth')history.replaceState(null,'','#auth');
    else if(id==='dash')history.replaceState(null,'','#dash');
  }
}
function goToDash(){
  openTripId=null;
  clearInterval(cdInterval);
  renderDashboard();
  showScreen('dash',true);
  history.pushState(null,'','#dash');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setAuthTab(t){
  document.querySelectorAll('.auth-tab').forEach((b,i)=>b.classList.toggle('active',(i===0&&t==='login')||(i===1&&t==='signup')));
  document.getElementById('auth-login').style.display  = t==='login' ?'':'none';
  document.getElementById('auth-signup').style.display = t==='signup'?'':'none';
}
async function doLogin(){
  const u=document.getElementById('li-user').value.trim().toLowerCase();
  const p=document.getElementById('li-pass').value;
  const err=document.getElementById('li-err');
  if(!u||!p){err.textContent='Please fill in all fields.';return;}
  const db=wDB();

  // If user not in local DB, try fetching from Dropbox (cross-device login)
  if(!db.users[u]){
    err.textContent='ğŸ” Looking up accountâ€¦';
    try{
      const tok=await getAccessToken();
      if(tok){
        const res=await dbx.down(tok,userCloudPath(u));
        if(res.ok){
          const rec=await res.json();
          // Validate password before caching locally
          if(rec.password!==btoa(p)){err.textContent='Incorrect password.';return;}
          db.users[u]=rec;
          wSave(db);
          err.textContent='';
          CU={username:u}; saveSession(u);
          renderDashboard(); showScreen('dash');
          return;
        }
      }
    }catch(e){}
    err.textContent='No account found with that email.';
    return;
  }

  if(db.users[u].password!==btoa(p)){err.textContent='Incorrect password.';return;}
  err.textContent='';
  CU={username:u}; saveSession(u);
  renderDashboard(); showScreen('dash');
}
async function doSignup(){
  const db=wDB();
  const fname = document.getElementById('su-fname').value.trim();
  const lname  = document.getElementById('su-lname').value.trim();
  const email  = document.getElementById('su-email').value.trim().toLowerCase();
  const p      = document.getElementById('su-pass').value;
  const p2     = document.getElementById('su-pass2').value;
  const err    = document.getElementById('su-err');
  if(!fname||!email||!p){err.textContent='Please fill in all required fields.';return;}
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){err.textContent='Please enter a valid email address.';return;}
  if(p.length<6){err.textContent='Password must be at least 6 characters.';return;}
  if(p!==p2){err.textContent='Passwords do not match.';return;}
  if(db.users[email]){err.textContent='An account with this email already exists.';return;}
  // Store user â€” email is primary key, firstName maps to traveler_name
  db.users[email]={
    password:     btoa(p),
    firstName:    fname,
    lastName:     lname,
    traveler_name: fname,          // maps directly to traveler_name
    displayName:  fname+' '+(lname?lname.charAt(0)+'.':''),
    email:        email,
    createdAt:    Date.now()
  };
  wSave(db);
  err.textContent='';
  CU={username:email}; saveSession(email);
  // Upload user record to Dropbox so login works on any device
  (async()=>{
    try{
      const tok=await getAccessToken();
      if(tok) await dbx.up(tok,userCloudPath(email),JSON.stringify(db.users[email]));
    }catch(e){}
  })();
  renderDashboard(); showScreen('dash');
}
function doGuest(){
  const db=wDB();
  if(!db.users['guest']) db.users['guest']={password:'',createdAt:Date.now()};
  // Seed demo trip for guest if none
  const existing = Object.values(db.trips).find(t=>t.code==='DEMO01');
  if(!existing){
    const photo = getPhoto('london');
    db.trips['demo-london']={
      id:'demo-london', destination:'London', dates:'May 11â€“15, 2026',
      travelDate:'2026-05-11T15:00:00', tripDays:['May 11','May 12','May 13','May 14','May 15'],
      code:'DEMO01', photo, owner:'guest',
      travelers:[{username:'guest',role:'owner',joinedAt:Date.now()}],
      // Trip-specific state
      state:{itinerary:[
        {id:1,day:0,time:'15:00',title:'Land at Heathrow',note:'Terminal 5'},
        {id:2,day:0,time:'18:00',title:'Check in â€” Hotel',note:'St Pancras Renaissance'},
        {id:3,day:1,time:'09:00',title:'Borough Market',note:'Breakfast & local produce'},
        {id:4,day:1,time:'14:00',title:'Tower of London',note:'Book skip-the-line tickets'},
        {id:5,day:2,time:'10:00',title:'Notting Hill walk',note:'Portobello Road market'},
      ],notes:'Remember to get an Oyster card at the airport!\nLooks like it may rain â€” pack a light jacket.',memories:[]},
      tickets:[], deletedIds:[], deletedTravelers:[],
      personLists:{guest:{shopping:[{id:100,name:'Travel adapter',checked:false}],packing:[{id:101,name:'Passport',checked:false},{id:102,name:'Umbrella',checked:false}],ukShopping:[],shoppingDeleted:[]}},
      createdAt:Date.now()
    };
    wSave(db);
  }
  CU={username:'guest'}; saveSession('guest');
  renderDashboard(); showScreen('dash');
}
function doLogout(){
  CU=null; openTripId=null;
  clearInterval(cdInterval);
  clearSession();
  showScreen('auth',true);
  history.replaceState(null,'','#auth');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCOUNT SETTINGS & PASSWORD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAccountSettings(){
  if(!CU) return;
  const db=wDB(), u=CU.username, rec=db.users[u]||{};
  const name = rec.firstName ? rec.firstName+' '+(rec.lastName||'') : u.split('@')[0];
  document.getElementById('acct-name').textContent  = name.trim();
  document.getElementById('acct-email').textContent = rec.email||u;
  const av=document.getElementById('acct-av');
  av.textContent = rec.firstName ? (rec.firstName[0]+(rec.lastName?rec.lastName[0]:'')).toUpperCase() : initials(u);
  av.style.background = `linear-gradient(135deg,${avColor(u)},${avColor(u+'x')})`;
  document.getElementById('cp-current').value='';
  document.getElementById('cp-new').value='';
  document.getElementById('cp-new2').value='';
  document.getElementById('cp-err').textContent='';
  openMd('md-account');
}

function changePassword(){
  if(!CU) return;
  const db=wDB(), u=CU.username, rec=db.users[u];
  const cur  = document.getElementById('cp-current').value;
  const np   = document.getElementById('cp-new').value;
  const np2  = document.getElementById('cp-new2').value;
  const err  = document.getElementById('cp-err');
  if(!cur||!np||!np2){err.textContent='Please fill in all fields.';return;}
  if(rec.password!==btoa(cur)){err.textContent='Current password is incorrect.';return;}
  if(np.length<6){err.textContent='New password must be at least 6 characters.';return;}
  if(np!==np2){err.textContent='New passwords do not match.';return;}
  rec.password=btoa(np);
  wSave(db);
  // Sync updated password to cloud
  (async()=>{try{const tok=await getAccessToken();if(tok)await dbx.up(tok,userCloudPath(u),JSON.stringify(rec));}catch(e){}})();
  err.style.color='#4caf50';
  err.textContent='Password updated successfully âœ…';
  document.getElementById('cp-current').value='';
  document.getElementById('cp-new').value='';
  document.getElementById('cp-new2').value='';
  setTimeout(()=>{err.textContent='';err.style.color='#ff6b6b';},3000);
}

function openForgotPassword(){
  document.getElementById('fp-email').value='';
  document.getElementById('fp-err').textContent='';
  document.getElementById('fp-success').style.display='none';
  document.getElementById('fp-btn').style.display='';
  closeMd('md-account');
  openMd('md-forgot');
  setTimeout(()=>document.getElementById('fp-email').focus(),400);
}

function doForgotPassword(){
  const db=wDB();
  const email=document.getElementById('fp-email').value.trim().toLowerCase();
  const err=document.getElementById('fp-err');
  const suc=document.getElementById('fp-success');
  if(!email){err.textContent='Please enter your email address.';return;}
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){err.textContent='Please enter a valid email address.';return;}
  if(!db.users[email]){err.textContent='No account found with that email address.';return;}
  err.textContent='';
  // Since this is a client-side app (no backend email server), we show
  // the user their account info securely and instruct them to use
  // the Change Password flow. A real backend would send a tokenised reset link.
  const rec=db.users[email];
  const name=rec.firstName||email.split('@')[0];
  suc.innerHTML = `<strong>Account found for ${esc(name)} âœ…</strong><br><br>
    Since Allabroad runs entirely in your browser, password reset emails require a backend server (not yet configured).<br><br>
    <strong>To reset your password right now:</strong><br>
    1. Sign in with your current password<br>
    2. Go to <strong>âš™ï¸ Account</strong> on the dashboard<br>
    3. Use the <em>Change Password</em> section<br><br>
    <span style="opacity:0.7;font-size:0.75rem;">If you've forgotten your password entirely, you'll need to create a new account or contact the app admin to reset it directly in the database.</span>`;
  suc.style.display='block';
  document.getElementById('fp-btn').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  if(!CU) return;
  const db=wDB(), u=CU.username;
  document.getElementById('dash-tod').textContent   = timeWord();
  const userRec = db.users[u]||{};
  const displayFirst = userRec.firstName || userRec.displayName || u.split('@')[0];
  document.getElementById('dash-uname').textContent = displayFirst.charAt(0).toUpperCase()+displayFirst.slice(1);
  const av=document.getElementById('dash-av');
  av.textContent = userRec.firstName ? (userRec.firstName[0]+(userRec.lastName?userRec.lastName[0]:'')).toUpperCase() : initials(u);
  av.style.background=`linear-gradient(135deg,${avColor(u)},${avColor(u+'x')})`;

  const mine = Object.values(db.trips)
    .filter(t=>t.travelers&&t.travelers.some(tr=>tr.username===u))
    .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  document.getElementById('dash-lbl').textContent = mine.length?`Your Trips (${mine.length})`:'Your Trips';
  const list=document.getElementById('trips-list');
  if(!mine.length){
    list.innerHTML=`<div class="dash-empty"><div class="dash-empty-icon">ğŸŒ</div><div class="dash-empty-ttl">No trips yet</div><div class="dash-empty-sub">Tap <strong>+ New Trip</strong> to start planning</div></div>`;
    return;
  }
  list.innerHTML = mine.map((trip,i)=>{
    const isOwner=trip.owner===u, tc=trip.travelers?.length||1;
    return `<div class="trip-card" onclick="openTrip('${trip.id}')" style="animation:fadeUp 0.35s ${i*0.06}s ease both;">
      <div class="tc-bg" style="background-image:url('${trip.photo||getPhoto(trip.destination)}')"></div>
      <div class="tc-ov"></div>
      <div class="tc-code">${trip.code}</div>
      ${isOwner?`<button class="tc-del-btn" title="Delete trip" onclick="event.stopPropagation();openDeleteTrip('${trip.id}')">ğŸ—‘</button>`:''}
      <div class="tc-body">
        <div class="tc-badge">${isOwner?'âœ¦ Organiser':'âœˆ Traveler'}</div>
        <div class="tc-dest">${esc(trip.destination)}</div>
        <div class="tc-meta"><span>ğŸ“… ${esc(trip.dates||'Dates TBD')}</span><span>ğŸ‘¥ ${tc} ${tc===1?'person':'people'}</span></div>
      </div>
    </div>`;
  }).join('');
}
// Inject fadeUp keyframe only (responsive CSS is in <style> block)
document.head.insertAdjacentHTML('beforeend','<style>@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:none}}</style>');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW TRIP / JOIN TRIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR RANGE PICKER
// Instances keyed by prefix: 'nd' (new trip) | 'ed' (edit dates)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _cal = {};   // per-instance state

function calInit(prefix, existingDates){
  const today = new Date(); today.setHours(0,0,0,0);
  // Parse existing dates into start/end if provided (format: "Jun 12 â€“ Jun 20, 2026")
  let start = null, end = null;
  if(existingDates){
    const parts = existingDates.split('â€“').map(s=>s.trim());
    if(parts.length === 2){
      // Try to parse both sides: "Jun 12, 2026" or just "Jun 12"
      const tryParse = str => {
        // append current year if missing
        const d = new Date(str.match(/\d{4}/) ? str : str + ', ' + today.getFullYear());
        return isNaN(d) ? null : (d.setHours(0,0,0,0), d);
      };
      start = tryParse(parts[0]);
      end   = tryParse(parts[1]);
    }
  }
  const viewMonth = (start || today);
  _cal[prefix] = {
    viewYear:  viewMonth.getFullYear(),
    viewMonth: viewMonth.getMonth(),   // 0-based
    start, end, today,
    selecting: start ? 'end' : 'start'
  };
  calRender(prefix);
}

function calToggle(prefix){
  const picker = document.getElementById(prefix+'-cal');
  if(!picker) return;
  const open = picker.style.display !== 'none';
  if(open){ picker.style.display='none'; return; }
  // Init with current value if any
  const label = document.getElementById(prefix+'-dates-label');
  const hidden = document.getElementById(prefix+'-dates');
  calInit(prefix, hidden ? hidden.value : '');
  picker.style.display = 'block';
}

function calPrev(prefix){ _cal[prefix].viewMonth--; if(_cal[prefix].viewMonth<0){_cal[prefix].viewMonth=11;_cal[prefix].viewYear--;} calRender(prefix); }
function calNext(prefix){ _cal[prefix].viewMonth++; if(_cal[prefix].viewMonth>11){_cal[prefix].viewMonth=0;_cal[prefix].viewYear++;} calRender(prefix); }

function calRender(prefix){
  const s = _cal[prefix];
  const DAYS = ['Su','Mo','Tu','We','Th','Fr','Sa'];
  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const SHORT_MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  document.getElementById(prefix+'-cal-title').textContent = MONTHS[s.viewMonth] + ' ' + s.viewYear;

  const firstDay = new Date(s.viewYear, s.viewMonth, 1).getDay();
  const daysInMonth = new Date(s.viewYear, s.viewMonth+1, 0).getDate();

  let html = DAYS.map(d=>`<div class="cal-dow">${d}</div>`).join('');
  for(let i=0; i<firstDay; i++) html += `<div class="cal-day cal-empty"></div>`;

  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(s.viewYear, s.viewMonth, d);
    const isPast = date < s.today;
    const isStart = s.start && date.getTime()===s.start.getTime();
    const isEnd   = s.end   && date.getTime()===s.end.getTime();
    const inRange = s.start && s.end && date > s.start && date < s.end;
    const isToday = date.getTime()===s.today.getTime();
    let cls = 'cal-day';
    if(isPast) cls += ' cal-past';
    if(isToday) cls += ' cal-today';
    if(isStart) cls += ' cal-start';
    if(isEnd)   cls += ' cal-end';
    if(inRange||isStart||isEnd) cls += ' cal-in-range';
    html += `<div class="${cls}" onclick="calPickDay('${prefix}',${s.viewYear},${s.viewMonth},${d})">${d}</div>`;
  }

  document.getElementById(prefix+'-cal-grid').innerHTML = html;

  // Hint text
  const hint = document.getElementById(prefix+'-cal-hint');
  if(s.start && s.end){
    const nights = Math.round((s.end-s.start)/(1000*60*60*24));
    hint.textContent = `${nights} night${nights===1?'':'s'} selected`;
  } else if(s.start){
    hint.textContent = 'Now tap an end date';
  } else {
    hint.textContent = 'Tap a start date';
  }

  // Confirm button
  const confirmBtn = document.getElementById(prefix+'-cal-confirm');
  if(confirmBtn) confirmBtn.disabled = !(s.start && s.end);
}

function calPickDay(prefix, yr, mo, d){
  const s = _cal[prefix];
  const clicked = new Date(yr, mo, d);
  clicked.setHours(0,0,0,0);
  if(s.selecting === 'start' || !s.start || (s.end && clicked < s.start)){
    s.start = clicked; s.end = null; s.selecting = 'end';
  } else if(clicked.getTime() === s.start.getTime()){
    // Clicked same day as start â€” reset
    s.start = null; s.end = null; s.selecting = 'start';
  } else if(clicked < s.start){
    s.start = clicked; s.end = null; s.selecting = 'end';
  } else {
    s.end = clicked; s.selecting = 'start';
  }
  calRender(prefix);
}

function calClear(prefix){
  if(_cal[prefix]){ _cal[prefix].start=null; _cal[prefix].end=null; _cal[prefix].selecting='start'; calRender(prefix); }
  const hidden = document.getElementById(prefix+'-dates');
  if(hidden) hidden.value = '';
  const label = document.getElementById(prefix+'-dates-label');
  if(label) label.textContent = 'Select datesâ€¦';
}

function calConfirm(prefix){
  const s = _cal[prefix];
  if(!s.start || !s.end) return;
  const SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const sameMonth = s.start.getMonth()===s.end.getMonth() && s.start.getFullYear()===s.end.getFullYear();
  let label;
  if(sameMonth){
    label = `${SHORT[s.start.getMonth()]} ${s.start.getDate()} â€“ ${s.end.getDate()}, ${s.end.getFullYear()}`;
  } else {
    label = `${SHORT[s.start.getMonth()]} ${s.start.getDate()} â€“ ${SHORT[s.end.getMonth()]} ${s.end.getDate()}, ${s.end.getFullYear()}`;
  }
  // Store in hidden input
  const hidden = document.getElementById(prefix+'-dates');
  if(hidden) hidden.value = label;
  // Update display
  const display = document.getElementById(prefix+'-dates-label');
  if(display) display.textContent = label;
  // Close picker
  document.getElementById(prefix+'-cal').style.display = 'none';
  // If editing dates (ed prefix), apply immediately
  if(prefix === 'ed') applyNewDates(label, s.start, s.end);
}

function openNewTrip(){
  document.getElementById('nd-dest').value='';
  document.getElementById('nd-dates').value='';
  // Reset calendar picker display
  const ndLabel = document.getElementById('nd-dates-label');
  if(ndLabel) ndLabel.textContent='Select datesâ€¦';
  const ndCal = document.getElementById('nd-cal');
  if(ndCal) ndCal.style.display='none';
  document.getElementById('nd-err').textContent='';
  document.getElementById('dest-prev').style.display='none';
  openMd('md-new-trip');
  setTimeout(()=>document.getElementById('nd-dest').focus(),400);
}
let destDebounce=null;
function onDestInput(val){
  clearTimeout(destDebounce);
  destDebounce=setTimeout(()=>{
    const prev=document.getElementById('dest-prev');
    if(val.trim().length>2){
      const url=getPhoto(val);
      document.getElementById('dest-prev-img').src=url;
      document.getElementById('dest-prev-lbl').textContent=val;
      prev.style.display='block';
    }else prev.style.display='none';
  },350);
}
function createTrip(){
  const dest=document.getElementById('nd-dest').value.trim();
  const dates=document.getElementById('nd-dates').value.trim();
  const err=document.getElementById('nd-err');
  if(!dest){err.textContent='Please enter a destination.';return;}
  if(!dates){err.textContent='Please select travel dates.';return;}
  const db=wDB(), id='trip-'+Date.now(), code=genCode();
  // Parse a travel date from the dates field if possible
  let travelDate = null;
  const m = dates.match(/(\d{1,2})[\/\-\s](\w+)[\/\-\s]?(\d{4})?/);
  if(m) travelDate = dates; // store raw string for countdown parsing

  db.trips[id]={
    id, destination:dest, dates, code,
    photo:getPhoto(dest), owner:CU.username,
    travelers:[{username:CU.username,role:'owner',joinedAt:Date.now()}],
    travelDate: parseTravelDate(dates),
    tripDays: buildTripDays(dates),
    state:{itinerary:[],notes:'',memories:[]},
    tickets:[],deletedIds:[],deletedTravelers:[],
    personLists:{},
    createdAt:Date.now()
  };
  // Create prep lists for owner
  db.trips[id].personLists[CU.username]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};
  wSave(db);
  closeMd('md-new-trip');
  renderDashboard();
  // Push trip metadata and code index to cloud so joiners on other devices can find it
  (async()=>{
    try{
      const tok=await getAccessToken();
      if(!tok) return;
      // Write metadata (everything except personLists/state/tickets)
      const meta={id,destination:dest,dates,code,photo:db.trips[id].photo,
        owner:CU.username,travelDate:db.trips[id].travelDate,
        tripDays:db.trips[id].tripDays,createdAt:db.trips[id].createdAt};
      await dbx.up(tok,tripMetaPath(id),JSON.stringify(meta));
      // Update global codeâ†’id index
      let index={};
      try{const r=await dbx.down(tok,indexCloudPath());if(r.ok)index=await r.json();}catch(e){}
      index[code]=id;
      await dbx.up(tok,indexCloudPath(),JSON.stringify(index));
    }catch(e){}
  })();
  setTimeout(()=>openTrip(id),200);
}

function parseTravelDate(dates){
  // Try to extract an ISO date from strings like "June 12â€“20, 2026" or "12 June 2026"
  if(!dates) return null;
  const months={january:1,february:2,march:3,april:4,may:5,june:6,july:7,august:8,september:9,october:10,november:11,december:12,
    jan:1,feb:2,mar:3,apr:4,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
  const d=dates.toLowerCase();
  for(const [mn,mo] of Object.entries(months)){
    const re=new RegExp(mn+'[\\s]+([\\d]+)[^\\d]*(\\d{4})?','i');
    const m=d.match(re)||d.match(new RegExp('([\\d]+)[^\\d]*'+mn+'[^\\d]*(\\d{4})?','i'));
    if(m){
      const day=parseInt(m[1]||m[2]||1);
      const yr=parseInt(m[3]||m[2]||new Date().getFullYear());
      return new Date(yr,mo-1,day,12,0,0).toISOString();
    }
  }
  return null;
}
function buildTripDays(dates){
  // Generate day labels from a date range string
  if(!dates) return ['Day 1','Day 2','Day 3','Day 4','Day 5'];
  const SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  // New calendar format: "Jun 12 â€“ Jun 20, 2026" or "Jun 12 â€“ 20, 2026"
  // Split on em-dash, en-dash, or " - "
  const parts = dates.split(/\s*[â€“â€”\-]\s*/);
  if(parts.length === 2){
    const yr = dates.match(/\d{4}/);
    const year = yr ? parseInt(yr[0]) : new Date().getFullYear();
    // Try parsing both sides as dates
    const tryParse = str => {
      const s = str.trim().replace(/,?\s*\d{4}/, ''); // strip year from end
      const d = new Date(s + ', ' + year);
      if(!isNaN(d)) return d;
      // fallback: try adding current month context
      return null;
    };
    const startD = tryParse(parts[0]);
    // End might be just a number (same month): "Jun 12 â€“ 20"
    let endD = tryParse(parts[1]);
    if(!endD && startD && /^\s*\d+\s*/.test(parts[1])){
      endD = new Date(startD);
      endD.setDate(parseInt(parts[1].trim()));
    }
    if(startD && endD && endD >= startD){
      const days = [];
      const cur = new Date(startD); cur.setHours(0,0,0,0);
      const last = new Date(endD);  last.setHours(0,0,0,0);
      while(cur <= last && days.length < 28){
        days.push(SHORT[cur.getMonth()] + ' ' + cur.getDate());
        cur.setDate(cur.getDate()+1);
      }
      if(days.length) return days;
    }
  }

  // Legacy fallback: "June 12â€“20, 2026" style (just a number range)
  const m = dates.match(/(\d+)[â€“\-â€”to]+(\d+)/);
  if(!m) return ['Day 1','Day 2','Day 3','Day 4','Day 5'];
  const start=parseInt(m[1]), end=parseInt(m[2]);
  const len=Math.min(end-start+1,14);
  const months={jan:'Jan',feb:'Feb',mar:'Mar',apr:'Apr',may:'May',jun:'Jun',jul:'Jul',aug:'Aug',sep:'Sep',oct:'Oct',nov:'Nov',dec:'Dec'};
  let prefix='';
  for(const [k,v] of Object.entries(months)){ if(dates.toLowerCase().includes(k)){prefix=v+' ';break;} }
  return Array.from({length:len>0?len:5},(_,i)=>prefix?(prefix+(start+i)):'Day '+(i+1));
}

function openJoinTrip(){
  document.getElementById('jt-code').value='';
  document.getElementById('jt-err').textContent='';
  openMd('md-join-trip');
  setTimeout(()=>document.getElementById('jt-code').focus(),400);
}
async function joinTrip(){
  const code=document.getElementById('jt-code').value.trim().toUpperCase();
  const err=document.getElementById('jt-err');
  if(code.length<4){err.textContent='Please enter a valid code.';return;}
  err.textContent='ğŸ” Searchingâ€¦';

  const db=wDB();
  // 1. Try local first (same device, already has the trip)
  let trip=Object.values(db.trips).find(t=>t.code===code);

  // 2. If not found locally, search Dropbox via the global index
  if(!trip){
    try{
      const tok=await getAccessToken();
      if(!tok){err.textContent='Could not connect to cloud. Check your connection.';return;}
      // Fetch the global codeâ†’tripId index
      const idxRes=await dbx.down(tok,indexCloudPath());
      if(!idxRes.ok){err.textContent='No trip found with that code.';return;}
      const index=await idxRes.json();
      const tripId=index[code];
      if(!tripId){err.textContent='No trip found with that code.';return;}
      // Fetch trip metadata
      const metaRes=await dbx.down(tok,tripMetaPath(tripId));
      if(!metaRes.ok){err.textContent='Trip found but metadata missing â€” ask the organiser to open the trip once.';return;}
      const meta=await metaRes.json();
      // Reconstruct local trip record
      db.trips[tripId]={
        ...meta,
        travelers:[],
        state:{itinerary:[],notes:'',memories:[]},
        tickets:[],deletedIds:[],deletedTravelers:[],
        personLists:{}
      };
      wSave(db);
      trip=db.trips[tripId];
    }catch(e){err.textContent='Network error â€” please try again.';return;}
  }

  err.textContent='';
  const alreadyIn=trip.travelers?.some(t=>t.username===CU.username);
  if(alreadyIn){err.textContent="You're already in this trip!";return;}
  if(!trip.travelers) trip.travelers=[];
  trip.travelers.push({username:CU.username,role:'traveler',joinedAt:Date.now()});
  if(!trip.personLists) trip.personLists={};
  if(!trip.personLists[CU.username]) trip.personLists[CU.username]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};
  wSave(db);
  closeMd('md-join-trip');
  showToast(`Joined "${trip.destination}"! ğŸ‰`);
  renderDashboard();
  // Open trip, then pull full state from cloud, then push our membership
  setTimeout(async ()=>{
    openTrip(trip.id);
    await syncFromCloud();   // pull itinerary/notes/etc from owner's cloud file
    await syncToCloud();     // write our username into the cloud travelers array
  }, 600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRIP INTERIOR â€” load trip into London-app engine
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// All trip-engine state lives here, loaded fresh each time a trip opens
let TRIP=null; // current trip object from wDB
let TRIP_DAYS=[];
let TRAVEL_DATE=null;
let travelers=[], personLists={}, state={itinerary:[],notes:'',memories:[]};
let tickets=[], deletedIds=[], deletedTravelers=[], tempImg=null;
let activeTraveler=null, activeDay=0, currentTab=0, confettiFired=false;
let syncing=false, syncTimer=null, cdInterval=null;

function openTrip(id){
  const db=wDB();
  TRIP=db.trips[id];
  if(!TRIP) return;
  openTripId=id;

  // Load trip state into engine vars
  TRIP_DAYS  = TRIP.tripDays||['Day 1','Day 2','Day 3','Day 4','Day 5'];
  TRAVEL_DATE= TRIP.travelDate ? new Date(TRIP.travelDate).getTime() : null;
  travelers  = TRIP.travelers||[{username:CU.username,role:'owner',joinedAt:Date.now()}];
  personLists= TRIP.personLists||{};
  state      = TRIP.state||{itinerary:[],notes:'',memories:[]};
  tickets    = TRIP.tickets||[];
  deletedIds = TRIP.deletedIds||[];
  deletedTravelers=TRIP.deletedTravelers||[];
  tempImg    = null;
  activeDay  = 0; currentTab=0; confettiFired=false;
  // Restore last active day for this trip
  try{const d=localStorage.getItem('abt_day_'+id);if(d!==null){const n=parseInt(d);if(!isNaN(n)&&n>=0)activeDay=n;}}catch(e){}

  // Ensure current user has a traveler entry + prep list
  if(!travelers.find(t=>t.username===CU.username)){
    travelers.push({username:CU.username,role:'traveler',joinedAt:Date.now()});
  }
  activeTraveler=CU.username;
  if(!personLists[activeTraveler]) personLists[activeTraveler]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};

  // Update UI
  document.getElementById('tripBg').style.backgroundImage=`url('${TRIP.photo||getPhoto(TRIP.destination)}')`;
  document.getElementById('tripTitle').innerHTML=esc(TRIP.destination)+'<span>.</span>';
  document.getElementById('tripSubtitle').textContent=TRIP.dates||'';
  document.getElementById('tripCodeStrip').textContent='Code: '+TRIP.code;
  document.getElementById('settingsCodeDisplay').textContent=TRIP.code;

  // Reset tabs & slider
  switchTab(0,true);
  document.getElementById('tabsSlider').style.transform='translateX(0)';

  // Render everything
  buildDayTabs(); renderItinerary(); renderNotes();
  renderTravelerTabs(); renderTravelerSettings();
  renderTickets(); renderMemories();

  // Countdown
  clearInterval(cdInterval);
  if(TRAVEL_DATE){ checkArrived(); updateCD(); cdInterval=setInterval(updateCD,1000); }
  else { document.getElementById('cdDays').textContent='--'; document.getElementById('cdHours').textContent='--'; document.getElementById('cdMins').textContent='--'; }

  // Save initial state to localStorage so sync merges correctly
  saveTripLocal();
  // Weather â€” fetch for destination
  fetchWeather(TRIP.destination);
  history.replaceState(null,'','#trip/'+id+'/'+currentTab);
  showScreen('trip',true);
}

// Persist trip state back to wDB
function saveTripLocal(){
  if(!openTripId) return;
  const db=wDB();
  if(!db.trips[openTripId]) return;
  db.trips[openTripId].state      = state;
  db.trips[openTripId].tickets    = tickets;
  db.trips[openTripId].deletedIds = deletedIds;
  db.trips[openTripId].deletedTravelers=deletedTravelers;
  db.trips[openTripId].travelers  = travelers;
  db.trips[openTripId].personLists= personLists;
  wSave(db);
  TRIP=db.trips[openTripId];
}
function saveAndSync(){ saveTripLocal(); render(); setStatus('â˜ï¸ Pendingâ€¦'); clearTimeout(syncTimer); syncTimer=setTimeout(syncToCloud,2000); }
function setStatus(msg){
  const el=document.getElementById('syncStatus');
  const dot=document.getElementById('syncDot');
  if(el)el.textContent=msg;
  if(dot){
    const ok=msg.includes('âœ…')||msg.includes('Connected');
    const err=msg.includes('âŒ')||msg.includes('Error')||msg.includes('Offline');
    const busy=msg.includes('â€¦')||msg.includes('Syncing')||msg.includes('Connecting');
    dot.style.background = ok?'#4caf50':err?'#e74c3c':'#f39c12';
    dot.style.boxShadow  = ok?'0 0 6px #4caf50':err?'0 0 6px #e74c3c':'0 0 6px #f39c12';
    if(el) el.style.color = ok?'#4caf50':err?'#e74c3c':'#f39c12';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDEXEDDB (for images â€” trip-scoped key prefix)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _db;
function openIDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open('AllabroadImages',1);
    r.onupgradeneeded=e=>{ if(!e.target.result.objectStoreNames.contains('imgs')) e.target.result.createObjectStore('imgs',{keyPath:'id'}); };
    r.onsuccess=e=>{_db=e.target.result;res();};
    r.onerror=rej;
  });
}
function idbKey(id){ return (openTripId||'x')+':'+String(id); }
const idb={
  save:(id,url)=>new Promise((res,rej)=>{ const tx=_db.transaction('imgs','readwrite'); tx.objectStore('imgs').put({id:idbKey(id),dataUrl:url}); tx.oncomplete=res;tx.onerror=rej; }),
  get: id=>new Promise(res=>{ const r=_db.transaction('imgs','readonly').objectStore('imgs').get(idbKey(id)); r.onsuccess=()=>res(r.result?r.result.dataUrl:null);r.onerror=()=>res(null); }),
  del: id=>new Promise(res=>{ const tx=_db.transaction('imgs','readwrite'); tx.objectStore('imgs').delete(idbKey(id)); tx.oncomplete=res;tx.onerror=res; }),
  allKeys:()=>new Promise(res=>{ const r=_db.transaction('imgs','readonly').objectStore('imgs').getAllKeys(); r.onsuccess=()=>res((r.result||[]).filter(k=>k.startsWith((openTripId||'x')+':')).map(k=>k.split(':').slice(1).join(':'))); r.onerror=()=>res([]); })
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DROPBOX â€” per trip (uses trip code as folder)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const dbx={
  up:(tok,path,body)=>fetch('https://content.dropboxapi.com/2/files/upload',{method:'POST',headers:{'Authorization':'Bearer '+tok,'Dropbox-API-Arg':JSON.stringify({path,mode:'overwrite',autorename:false,mute:true}),'Content-Type':'application/octet-stream'},body}),
  down:(tok,path)=>fetch('https://content.dropboxapi.com/2/files/download',{method:'POST',headers:{'Authorization':'Bearer '+tok,'Dropbox-API-Arg':JSON.stringify({path})}}),
  del:(tok,path)=>fetch('https://api.dropboxapi.com/2/files/delete_v2',{method:'POST',headers:{'Authorization':'Bearer '+tok,'Content-Type':'application/json'},body:JSON.stringify({path})})
};
let cachedToken=null,tokenExpiry=0;
async function getAccessToken(){
  if(cachedToken&&Date.now()<tokenExpiry-60000) return cachedToken;
  const key=localStorage.getItem('dbx_key'),secret=localStorage.getItem('dbx_secret'),refresh=localStorage.getItem('dbx_refresh');
  if(!key||!secret||!refresh){setStatus('â˜ï¸ Not connected');return null;}
  try{
    const r=await fetch('https://api.dropbox.com/oauth2/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:'grant_type=refresh_token&refresh_token='+encodeURIComponent(refresh)+'&client_id='+encodeURIComponent(key)+'&client_secret='+encodeURIComponent(secret)});
    const d=await r.json();
    if(!r.ok||!d.access_token){setStatus('â˜ï¸ '+(d.error_description||d.error||'Auth error'));return null;}
    cachedToken=d.access_token;tokenExpiry=Date.now()+(d.expires_in||14400)*1000;
    return cachedToken;
  }catch(e){setStatus('â˜ï¸ Offline');return null;}
}
function hasDbxCredentials(){ return !!(localStorage.getItem('dbx_key')&&localStorage.getItem('dbx_secret')&&localStorage.getItem('dbx_refresh')); }
function tripCloudPath(){ return '/allabroad/'+(openTripId||'trip')+'/data.json'; }
function tripImgPath(id){ return '/allabroad/'+(openTripId||'trip')+'/images/'+id; }
function indexCloudPath(){ return '/allabroad/_index.json'; }
function userCloudPath(email){ return '/allabroad/_users/'+encodeURIComponent(email)+'.json'; }
function tripMetaPath(id){ return '/allabroad/'+id+'/meta.json'; }

// Merge helpers
function mergeById(a,b){
  const dead=new Set(deletedIds.map(String));const seen=new Map();
  for(const t of [...(a||[]),...(b||[])]){const k=String(t.id);if(!dead.has(k)&&!seen.has(k))seen.set(k,t);}
  return Array.from(seen.values()).sort((x,y)=>Number(x.id)-Number(y.id));
}
function mergeList(a,b,extraDead){
  const dead=new Set([...deletedIds.map(String),...(extraDead||[]).map(String)]);const seen=new Map();
  for(const t of [...(a||[]),...(b||[])]){const k=String(t.id);if(!dead.has(k)&&!seen.has(k))seen.set(k,t);}
  return Array.from(seen.values()).sort((x,y)=>Number(x.id)-Number(y.id));
}
function mergeTravelers(a,b){
  const dead=new Set(deletedTravelers);const map=new Map();
  for(const t of [...(a||[]),...(b||[])]){if(dead.has(t.username))continue;const ex=map.get(t.username);if(!ex||(t.joinedAt||0)>(ex.joinedAt||0))map.set(t.username,t);}
  return Array.from(map.values());
}

async function syncToCloud(){
  if(syncing||!openTripId)return;
  const tok=await getAccessToken();if(!tok)return;
  syncing=true;setStatus('â˜ï¸ Syncingâ€¦');
  try{
    let cloud={};
    try{const r=await dbx.down(tok,tripCloudPath());if(r.ok)cloud=await r.json();}catch(e){}
    deletedIds=[...new Set([...deletedIds,...(cloud.deletedIds||[])].map(String))];
    deletedTravelers=[...new Set([...deletedTravelers,...(cloud.deletedTravelers||[])])];
    const mT=mergeById(cloud.tickets||[],tickets);
    const mM=mergeById(cloud.memories||[],state.memories);
    const mI=mergeById(cloud.itinerary||[],state.itinerary);
    const cloudPL=cloud.personLists||{};
    const mergedPL={};
    [...new Set([...Object.keys(personLists),...Object.keys(cloudPL)])].filter(u=>!deletedTravelers.includes(u)).forEach(u=>{
      const local=personLists[u]||{shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};
      const remote=cloudPL[u]||{shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};
      const mSD=[...new Set([...(local.shoppingDeleted||[]),...(remote.shoppingDeleted||[])].map(String))];
      mergedPL[u]={shopping:mergeList(remote.shopping||[],local.shopping||[],mSD),packing:mergeById(remote.packing||[],local.packing||[]),ukShopping:mergeById(remote.ukShopping||[],local.ukShopping||[]),shoppingDeleted:mSD};
    });
    const mTrav=mergeTravelers(cloud.travelers||[],travelers);
    const payload={itinerary:mI,notes:state.notes,travelers:mTrav,personLists:mergedPL,tickets:mT.map(t=>({id:t.id,name:t.name})),memories:mM.map(m=>({id:m.id,caption:m.caption})),deletedIds,deletedTravelers};
    const res=await dbx.up(tok,tripCloudPath(),JSON.stringify(payload));
    if(!res.ok){setStatus('â˜ï¸ Upload Error âŒ');syncing=false;return;}
    const localKeys=new Set((await idb.allKeys()).map(String));
    for(const item of [...mT,...mM]){if(localKeys.has(String(item.id))){const img=await idb.get(item.id);if(img)try{await dbx.up(tok,tripImgPath(item.id),img);}catch(e){}}}
    tickets=mT;state.memories=mM;state.itinerary=mI;travelers=mTrav;personLists=mergedPL;
    // Preserve current user's lists after merge
    if(CU&&!personLists[CU.username]) personLists[CU.username]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};
    if(CU&&travelers.find(t=>t.username===CU.username)) activeTraveler=CU.username;
    else if(!travelers.find(t=>t.username===activeTraveler)) activeTraveler=travelers[0]?.username||CU?.username;
    saveTripLocal();render();await renderTickets();await renderMemories();renderTravelerSettings();
    setStatus('â˜ï¸ Synced âœ… '+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}));
  }catch(e){setStatus('â˜ï¸ Offline âŒ');}
  syncing=false;
}

async function syncFromCloud(){
  if(syncing||!openTripId)return;
  const tok=await getAccessToken();if(!tok){setStatus('â˜ï¸ Not connected');return;}
  syncing=true;setStatus('â˜ï¸ Connectingâ€¦');
  try{
    const res=await dbx.down(tok,tripCloudPath());
    if(!res.ok){setStatus('â˜ï¸ No cloud data yet');syncing=false;return;}
    const data=await res.json();
    deletedIds=[...new Set([...deletedIds,...(data.deletedIds||[])].map(String))];
    deletedTravelers=[...new Set([...deletedTravelers,...(data.deletedTravelers||[])])];
    const dead=new Set(deletedIds);
    if(data.itinerary) state.itinerary=mergeById(data.itinerary,state.itinerary).filter(e=>!dead.has(String(e.id)));
    if(data.notes) state.notes=data.notes;
    tickets=mergeById(data.tickets||[],tickets);
    state.memories=mergeById(data.memories||[],state.memories).filter(m=>!dead.has(String(m.id)));
    if(data.travelers?.length) travelers=mergeTravelers(data.travelers,travelers);
    if(data.personLists){Object.keys(data.personLists).forEach(u=>{if(!personLists[u])personLists[u]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};const remote=data.personLists[u];const mSD=[...new Set([...(personLists[u].shoppingDeleted||[]),...(remote.shoppingDeleted||[])].map(String))];personLists[u]={shopping:mergeList(remote.shopping||[],personLists[u].shopping||[],mSD),packing:mergeById(remote.packing||[],personLists[u].packing||[]),ukShopping:mergeById(remote.ukShopping||[],personLists[u].ukShopping||[]),shoppingDeleted:mSD};});}
    travelers.forEach(t=>{if(!personLists[t.username])personLists[t.username]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};});
    // Always ensure current user's lists exist after merge
    if(CU&&!personLists[CU.username]) personLists[CU.username]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};
    // Keep activeTraveler as current user if they're still a member
    if(CU&&travelers.find(t=>t.username===CU.username)) activeTraveler=CU.username;
    else if(!travelers.find(t=>t.username===activeTraveler)) activeTraveler=travelers[0]?.username||CU?.username;
    const localKeys=new Set((await idb.allKeys()).map(String));
    for(const id of [...tickets.map(t=>t.id),...state.memories.map(m=>m.id)]){if(!localKeys.has(String(id))){try{const r=await dbx.down(tok,tripImgPath(id));if(r.ok){const txt=await r.text();if(txt.startsWith('data:'))await idb.save(id,txt);}}catch(e){}}}
    saveTripLocal();render();await renderTickets();await renderMemories();renderTravelerSettings();
    setStatus('â˜ï¸ Connected âœ…');
  }catch(e){console.error(e);setStatus('â˜ï¸ Error âŒ');}
  syncing=false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ITINERARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildDayTabs(){
  const tabs=document.getElementById('dayTabs'),sel=document.getElementById('evDay');if(!tabs||!sel)return;
  tabs.innerHTML=TRIP_DAYS.map((d,i)=>`<button class="day-tab${i===activeDay?' active':''}" onclick="setDay(${i})">${d}</button>`).join('');
  sel.innerHTML=TRIP_DAYS.map((d,i)=>`<option value="${i}">${d}</option>`).join('');
  sel.value=String(activeDay);
}
function setDay(i){
  activeDay=i;
  buildDayTabs();renderItinerary();
  // Persist active day so page refresh restores to same day
  if(openTripId) try{localStorage.setItem('abt_day_'+openTripId,String(i));}catch(e){}
}
function renderItinerary(){
  const list=document.getElementById('itineraryList');if(!list)return;
  const evs=(state.itinerary||[]).filter(e=>Number(e.day)===activeDay).sort((a,b)=>(a.time||'').localeCompare(b.time||''));
  if(!evs.length){list.innerHTML=`<div class="empty">No events for ${TRIP_DAYS[activeDay]} yet.</div>`;return;}
  list.innerHTML=evs.map(e=>`<div class="ev-row">
    <div class="ev-time">${e.time||'--:--'}</div>
    <div class="ev-body"><div class="ev-title">${esc(e.title)}</div>${e.note?`<div class="ev-note">${esc(e.note)}</div>`:''}</div>
    <div style="display:flex;gap:4px;flex-shrink:0;">
      <button onclick="editEvent(${e.id})" class="del-btn" style="opacity:0.45;font-size:0.85rem;" title="Edit">âœï¸</button>
      <button onclick="deleteEvent(${e.id})" class="del-btn" title="Delete">âœ•</button>
    </div>
  </div>`).join('');
}
let editingEventId=null;
function showAddEvent(){
  editingEventId=null;
  document.getElementById('evFormTitle').textContent='Add Event';
  document.getElementById('evSaveBtn').textContent='Save Event';
  document.getElementById('evDay').value=String(activeDay);
  document.getElementById('evTitle').value='';document.getElementById('evNote').value='';document.getElementById('evTime').value='';
  document.getElementById('eventForm').classList.add('on');
  document.getElementById('evTitle').focus();
}
function editEvent(id){
  const ev=state.itinerary.find(e=>e.id===id);if(!ev)return;
  editingEventId=id;
  document.getElementById('evFormTitle').textContent='Edit Event';document.getElementById('evSaveBtn').textContent='Update Event';
  document.getElementById('evDay').value=String(ev.day);document.getElementById('evTime').value=ev.time||'';
  document.getElementById('evTitle').value=ev.title;document.getElementById('evNote').value=ev.note||'';
  document.getElementById('eventForm').classList.add('on');document.getElementById('evTitle').focus();
  setTimeout(()=>document.getElementById('eventForm').scrollIntoView({behavior:'smooth',block:'nearest'}),50);
}
function cancelEvent(){editingEventId=null;document.getElementById('eventForm').classList.remove('on');}
function saveEvent(){
  const title=document.getElementById('evTitle').value.trim();if(!title){alert('Please enter an event title.');return;}
  const day=parseInt(document.getElementById('evDay').value),time=document.getElementById('evTime').value,note=document.getElementById('evNote').value.trim();
  if(editingEventId!==null){const ev=state.itinerary.find(e=>e.id===editingEventId);if(ev){ev.day=day;ev.time=time;ev.title=title;ev.note=note;}}
  else state.itinerary.push({id:Date.now(),day,time,title,note});
  editingEventId=null;document.getElementById('eventForm').classList.remove('on');
  activeDay=day;buildDayTabs();renderItinerary();saveAndSync();
}
function deleteEvent(id){if(!confirm('Delete this event?'))return;state.itinerary=state.itinerary.filter(e=>e.id!==id);deletedIds=[...new Set([...deletedIds,String(id)])];renderItinerary();saveAndSync();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNotes(){const el=document.getElementById('notesArea');if(el)el.value=state.notes||'';}
function saveNotes(){
  state.notes=document.getElementById('notesArea').value;
  const lbl=document.getElementById('notesSavedLabel');lbl.textContent='Saved âœ…';setTimeout(()=>lbl.textContent='',2500);
  saveAndSync();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LISTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function curLists(){return personLists[activeTraveler]||(personLists[activeTraveler]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]});}
function addItem(key,inpId){const inp=document.getElementById(inpId),val=inp.value.trim();if(!val)return;curLists()[key].push({id:Date.now(),name:val,checked:false});inp.value='';saveAndSync();}
function toggleItem(key,id){
  const lists=curLists(),item=lists[key].find(i=>i.id===id);if(!item)return;
  if(key==='shopping'&&!item.checked){
    if(confirm(`Move "${item.name}" to your Packing List?`)){
      lists.packing.push({id:Date.now(),name:item.name,checked:false});
      lists.shopping=lists.shopping.filter(i=>i.id!==id);
      if(!lists.shoppingDeleted)lists.shoppingDeleted=[];
      lists.shoppingDeleted=[...new Set([...lists.shoppingDeleted,String(id)])];
      saveAndSync();return;
    }
  }
  item.checked=!item.checked;saveAndSync();
}
function deleteItem(key,id){const lists=curLists();lists[key]=lists[key].filter(i=>i.id!==id);deletedIds=[...new Set([...deletedIds,String(id)])];saveAndSync();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processImage(input,forWhat){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      const MAX=1200;let w=img.width,h=img.height;if(w>MAX){h=Math.round(h*MAX/w);w=MAX;}
      const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
      tempImg=c.toDataURL('image/jpeg',0.75);
      if(forWhat==='ticket'){document.getElementById('previewImg').src=tempImg;document.getElementById('photoPreview').classList.add('on');}
      else{document.getElementById('memPreviewImg').src=tempImg;document.getElementById('memPreviewRow').classList.add('on');document.getElementById('memCaption').focus();}
    };img.src=e.target.result;
  };reader.readAsDataURL(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICKETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addTicket(){
  const inp=document.getElementById('ticketName');
  if(!inp.value.trim()){alert('Please enter a ticket name.');return;}
  if(!tempImg){alert('Please attach a photo first (tap ğŸ“·).');return;}
  const id=Date.now();tickets.push({id,name:inp.value.trim()});
  await idb.save(id,tempImg);inp.value='';clearTicketPhoto();
  saveTripLocal();await renderTickets();clearTimeout(syncTimer);syncTimer=setTimeout(syncToCloud,2000);setStatus('â˜ï¸ Pendingâ€¦');
}
function clearTicketPhoto(){tempImg=null;document.getElementById('photoPreview').classList.remove('on');document.getElementById('ticketFile').value='';document.getElementById('previewImg').src='';}
async function deleteTicket(id){
  const t=tickets.find(t=>t.id===id);if(!confirm(`Delete "${t?t.name:'this ticket'}"?`))return;
  tickets=tickets.filter(t=>t.id!==id);deletedIds=[...new Set([...deletedIds,String(id)])];
  await idb.del(id);const tok=await getAccessToken();if(tok)try{await dbx.del(tok,tripImgPath(id));}catch(e){}
  saveTripLocal();await renderTickets();clearTimeout(syncTimer);syncTimer=setTimeout(syncToCloud,2000);setStatus('â˜ï¸ Pendingâ€¦');
}
async function renderTickets(){
  const el=document.getElementById('ticketList');if(!el)return;
  if(!tickets.length){el.innerHTML=`<div class="empty">No tickets yet â€” add your booking confirmations!</div>`;return;}
  const rows=await Promise.all(tickets.map(async t=>{const img=await idb.get(t.id);return `<div class="ticket-card" onclick="viewImage(${t.id})">${img?`<img src="${img}" class="t-thumb" alt="${esc(t.name)}">`:`<div class="t-thumb-ph">ğŸŸï¸</div>`}<span style="flex:1">${esc(t.name)}</span><button onclick="event.stopPropagation();deleteTicket(${t.id})" class="del-btn">âœ•</button></div>`;}));
  el.innerHTML=rows.join('');
}
async function viewImage(id){const img=await idb.get(id);if(!img){alert('Image not available. Tap ğŸ”„ to sync.');return;}document.getElementById('fullImg').src=img;document.getElementById('imgModal').classList.add('open');}
function closeImgModal(){document.getElementById('imgModal').classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEMORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addMemory(){
  if(!tempImg)return;const id=Date.now(),caption=document.getElementById('memCaption').value.trim();
  state.memories.push({id,caption});await idb.save(id,tempImg);tempImg=null;
  document.getElementById('memPreviewRow').classList.remove('on');document.getElementById('memCaption').value='';document.getElementById('memFile').value='';
  saveTripLocal();await renderMemories();clearTimeout(syncTimer);syncTimer=setTimeout(syncToCloud,2000);setStatus('â˜ï¸ Pendingâ€¦');
}
function cancelMemory(){tempImg=null;document.getElementById('memPreviewRow').classList.remove('on');document.getElementById('memFile').value='';}
async function deleteMemory(id){
  if(!confirm('Remove this memory?'))return;state.memories=state.memories.filter(m=>m.id!==id);
  deletedIds=[...new Set([...deletedIds,String(id)])];await idb.del(id);
  const tok=await getAccessToken();if(tok)try{await dbx.del(tok,tripImgPath(id));}catch(e){}
  saveTripLocal();await renderMemories();clearTimeout(syncTimer);syncTimer=setTimeout(syncToCloud,2000);setStatus('â˜ï¸ Pendingâ€¦');
}
async function renderMemories(){
  const grid=document.getElementById('memoriesGrid');if(!grid)return;
  if(!state.memories?.length){grid.innerHTML=`<div class="empty" style="grid-column:1/-1;">No memories yet â€” add photos during your trip! ğŸ“¸</div>`;return;}
  const cells=await Promise.all(state.memories.map(async m=>{const img=await idb.get(m.id);return `<div class="mem-cell" onclick="viewImage(${m.id})">${img?`<img src="${img}" loading="lazy" alt="${esc(m.caption||'memory')}">`:`<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2rem;opacity:0.3">ğŸ–¼ï¸</div>`}<button class="mem-del" onclick="event.stopPropagation();deleteMemory(${m.id})">âœ•</button>${m.caption?`<div class="mem-cap">${esc(m.caption)}</div>`:''}</div>`;}));
  grid.innerHTML=cells.join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRAVELERS (read-only display in settings â€” Allabroad handles add/remove)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AV_COLS2=['#c8a96e','#6fcf97','#56aef7','#e88c6a','#b39ddb','#80cbc4','#f48fb1','#ffe082'];
function displayName(username){
  try{const r=wDB().users[username];if(r&&r.firstName)return r.firstName+(r.lastName?' '+r.lastName.charAt(0)+'.':'');}catch(e){}
  return username.includes('@')?username.split('@')[0]:username;
}
function displayInitials(username){
  try{const r=wDB().users[username];if(r&&r.firstName)return(r.firstName[0]+(r.lastName?r.lastName[0]:'')).toUpperCase();}catch(e){}
  return username.slice(0,2).toUpperCase();
}
function avCol2(u){let h=0;for(let i=0;i<u.length;i++)h=(h*31+u.charCodeAt(i))&0xff;return AV_COLS2[h%AV_COLS2.length];}
function renderTravelerTabs(){
  const el=document.getElementById('travelerTabs');if(!el)return;
  el.innerHTML=travelers.map(t=>`<button class="day-tab${t.username===activeTraveler?' active':''}" onclick="switchTraveler('${t.username}')">${esc(displayName(t.username))}</button>`).join('');
}
function switchTraveler(u){activeTraveler=u;if(!personLists[u])personLists[u]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};render();}
function renderTravelerSettings(){
  const el=document.getElementById('travelerSettingsList');if(!el)return;
  el.innerHTML=travelers.map(t=>`<div class="trav-row">
    <div class="trav-av" style="background:linear-gradient(135deg,${avCol2(t.username)},${avCol2(t.username+'x')})">${displayInitials(t.username)}</div>
    <div class="trav-info"><div class="trav-name">${esc(displayName(t.username))}</div><div class="trav-role">Joined ${new Date(t.joinedAt||Date.now()).toLocaleDateString('en-GB',{day:'numeric',month:'short'})}</div></div>
    <div class="trav-badge ${t.role==='owner'?'b-owner':'b-traveler'}">${t.role==='owner'?'Organiser':'Traveler'}</div>
  </div>`).join('');
  // Show delete-trip button only to the organiser
  const wrap=document.getElementById('deleteTripBtnWrap');
  if(wrap) wrap.style.display=(TRIP&&TRIP.owner===CU.username)?'block':'none';
  // Populate date picker with current trip dates
  initSettingsDatePicker();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER (lists + tabs + itinerary)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const lists=curLists();
  ['shopping','ukShopping','packing'].forEach(key=>{
    const elId={shopping:'shopList',ukShopping:'ukShopList',packing:'packList'}[key];
    const el=document.getElementById(elId);if(!el)return;
    const items=lists[key]||[];
    if(!items.length){el.innerHTML=`<div class="empty">No items yet.</div>`;return;}
    el.innerHTML=items.map(i=>`<div class="item-row${i.checked?' checked':''}"><input type="checkbox"${i.checked?' checked':''} onchange="toggleItem('${key}',${i.id})"><span class="item-name">${esc(i.name)}</span><button onclick="deleteItem('${key}',${i.id})" class="del-btn">âœ•</button></div>`).join('');
  });
  renderTravelerTabs();renderItinerary();renderNotes();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCD(){
  if(!TRAVEL_DATE)return;
  const diff=TRAVEL_DATE-Date.now();
  if(diff<=0){checkArrived();return;}
  document.getElementById('cdDays').textContent=Math.floor(diff/86400000);
  document.getElementById('cdHours').textContent=Math.floor((diff%86400000)/3600000);
  document.getElementById('cdMins').textContent=Math.floor((diff%3600000)/60000);
}
function checkArrived(){
  if(!TRAVEL_DATE||TRAVEL_DATE-Date.now()>0||confettiFired)return;
  confettiFired=true;
  document.getElementById('tripBg').style.filter='brightness(0.55)';
  ['cdDaysCell','cdHoursCell','cdMinsCell'].forEach(id=>document.getElementById(id).style.display='none');
  document.querySelectorAll('.cd-sep').forEach(el=>el.style.display='none');
  document.getElementById('arrivedPill').style.display='block';
  document.getElementById('arrivedPill').textContent='ğŸ‰ You\'re in '+TRIP.destination+'!';
  [0,3000,6000].forEach(d=>setTimeout(fireConfetti,d));
}
function fireConfetti(){
  const cols=['#DC143C','#ffffff','#c8a96e','#FFD700','#ff69b4','#00bfff'];
  for(let i=0;i<120;i++){const p=document.createElement('div');p.className='cp';const sz=Math.random()*10+6;p.style.cssText=`left:${Math.random()*100}vw;width:${sz}px;height:${sz}px;background:${cols[~~(Math.random()*cols.length)]};--drift:${(Math.random()-.5)*200}px;animation-duration:${Math.random()*2+2.5}s;animation-delay:${Math.random()*1.5}s;border-radius:${Math.random()>.5?'50%':'2px'};opacity:${Math.random()*.5+.5};`;document.body.appendChild(p);p.addEventListener('animationend',()=>p.remove());}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEATHER â€” geocode destination â†’ lat/lon â†’ open-meteo
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WEATHER_COORDS={
  london:{lat:51.5074,lon:-0.1278},paris:{lat:48.8566,lon:2.3522},tokyo:{lat:35.6762,lon:139.6503},
  rome:{lat:41.9028,lon:12.4964},barcelona:{lat:41.3851,lon:2.1734},bali:{lat:-8.4095,lon:115.1889},
  dubai:{lat:25.2048,lon:55.2708},sydney:{lat:-33.8688,lon:151.2093},newyork:{lat:40.7128,lon:-74.0060},
  nyc:{lat:40.7128,lon:-74.0060},amsterdam:{lat:52.3676,lon:4.9041},bangkok:{lat:13.7563,lon:100.5018},
  singapore:{lat:1.3521,lon:103.8198},lisbon:{lat:38.7169,lon:-9.1399},prague:{lat:50.0755,lon:14.4378},
  vienna:{lat:48.2082,lon:16.3738},istanbul:{lat:41.0082,lon:28.9784},athens:{lat:37.9838,lon:23.7275},
  maldives:{lat:3.2028,lon:73.2207},iceland:{lat:64.9631,lon:-19.0208}
};
async function fetchWeather(dest){
  if(!dest)return;
  const k=dest.toLowerCase().replace(/[\s,]/g,'');
  let coord=null;
  for(const [kw,c] of Object.entries(WEATHER_COORDS)){ if(k.includes(kw)){coord=c;break;} }
  if(!coord)return;
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coord.lat}&longitude=${coord.lon}&current_weather=true`);
    if(!r.ok)return;
    const d=await r.json();
    const wmo=d.current_weather.weathercode;
    const sky=wmo<=1?'â˜€ï¸ Clear':wmo<=3?'â›… Partly cloudy':wmo<=67?'ğŸŒ§ï¸ Rain':'â„ï¸ Snow';
    document.getElementById('tripTemp').textContent=Math.round(d.current_weather.temperature)+'Â°C';
    document.getElementById('tripSky').textContent=sky+' in '+dest;
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function requestNotifPermission(){
  if(!('Notification' in window)){alert('Notifications not supported in this browser.');return;}
  Notification.requestPermission().then(p=>{
    if(p==='granted'){document.getElementById('notifStatus').textContent='Alerts: Active âœ…';new Notification('Allabroad âœˆï¸',{body:'Morning countdown alerts enabled!'});}
    else alert('Permission denied.');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESET TRIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDeleteTrip(tripId){
  const db=wDB();
  const trip=db.trips[tripId];
  if(!trip||trip.owner!==CU.username){
    showToast('Only the organiser can delete a trip.');
    return;
  }
  document.getElementById('dt-trip-id').value   = tripId;
  document.getElementById('dt-expected').value  = trip.destination.toLowerCase();
  document.getElementById('dt-trip-name').textContent = trip.destination;
  document.getElementById('dt-confirm').value   = '';
  document.getElementById('dt-confirm').placeholder = trip.destination;
  document.getElementById('dt-delete-btn').disabled = true;
  document.getElementById('dt-err').textContent = '';
  openMd('md-delete-trip');
  setTimeout(()=>document.getElementById('dt-confirm').focus(), 400);
}

async function confirmDeleteTrip(){
  const tripId = document.getElementById('dt-trip-id').value;
  const err    = document.getElementById('dt-err');
  if(!tripId){err.textContent='Error: no trip selected.';return;}

  const db=wDB();
  const trip=db.trips[tripId];
  if(!trip||trip.owner!==CU.username){
    err.textContent='Only the organiser can delete a trip.';
    return;
  }

  // Disable button to prevent double-click
  const btn=document.getElementById('dt-delete-btn');
  btn.disabled=true;
  btn.textContent='Deletingâ€¦';
  err.textContent='';

  // 1. Delete from localStorage immediately
  delete db.trips[tripId];
  wSave(db);

  // 2. Delete active-day key from localStorage
  try{ localStorage.removeItem('abt_day_'+tripId); }catch(e){}

  // 3. Delete all IndexedDB images for this trip
  // idb.allKeys uses openTripId â€” temporarily set it so keys resolve correctly
  const prevOpenId = openTripId;
  openTripId = tripId;
  try{
    const imgKeys = await idb.allKeys();
    for(const k of imgKeys){ try{ await idb.del(k); }catch(e){} }
  }catch(e){}
  openTripId = prevOpenId;

  // 4. Delete Dropbox files (best-effort â€” don't block on failure)
  try{
    const tok = await getAccessToken();
    if(tok){
      const delJobs = [
        dbx.del(tok, '/allabroad/'+tripId+'/data.json').catch(()=>{}),
        dbx.del(tok, '/allabroad/'+tripId+'/meta.json').catch(()=>{}),
        // Also remove the trip folder itself (Dropbox delete_v2 on a folder removes all contents)
        dbx.del(tok, '/allabroad/'+tripId).catch(()=>{}),
      ];
      // Remove from codeâ†’id index
      delJobs.push((async()=>{
        try{
          const idxRes = await dbx.down(tok, indexCloudPath());
          if(idxRes.ok){
            const index = await idxRes.json();
            if(trip.code && index[trip.code]){
              delete index[trip.code];
              await dbx.up(tok, indexCloudPath(), JSON.stringify(index));
            }
          }
        }catch(e){}
      })());
      await Promise.allSettled(delJobs);
    }
  }catch(e){}

  closeMd('md-delete-trip');
  showToast('Trip deleted.');

  // If we were inside this trip, go back to dashboard
  if(openTripId===tripId){
    openTripId=null;
    clearInterval(cdInterval);
  }
  renderDashboard();
  showScreen('dash');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT TRIP DATES (Settings tab)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyNewDates(dateLabel, startDate, endDate){
  if(!openTripId || !TRIP) return;

  // Build new TRIP_DAYS array from the selected date range
  const newDays = [];
  const SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const cur = new Date(startDate);
  cur.setHours(0,0,0,0);
  const last = new Date(endDate);
  last.setHours(0,0,0,0);
  while(cur <= last && newDays.length < 28){
    newDays.push(`${SHORT[cur.getMonth()]} ${cur.getDate()}`);
    cur.setDate(cur.getDate()+1);
  }
  if(!newDays.length) return;

  const newDayCount = newDays.length;
  const oldDayCount = TRIP_DAYS.length;

  // Remove itinerary events whose day index >= newDayCount (orphaned days)
  const removedDayIndices = new Set();
  for(let i = newDayCount; i < oldDayCount; i++) removedDayIndices.add(i);

  if(removedDayIndices.size > 0){
    const orphanIds = state.itinerary
      .filter(e => removedDayIndices.has(Number(e.day)))
      .map(e => String(e.id));
    // Add orphan IDs to deletedIds tombstone
    deletedIds = [...new Set([...deletedIds, ...orphanIds])];
    // Remove from in-memory itinerary
    state.itinerary = state.itinerary.filter(e => !removedDayIndices.has(Number(e.day)));
    if(orphanIds.length > 0){
      showToast(`Removed ${orphanIds.length} event${orphanIds.length===1?'':'s'} from dates no longer in the trip.`);
    }
  }

  // Update in-memory + TRIP object
  TRIP_DAYS = newDays;
  TRIP.tripDays   = newDays;
  TRIP.dates      = dateLabel;
  TRIP.travelDate = startDate.toISOString();

  // If activeDay is now out of range, reset to 0
  if(activeDay >= newDayCount){
    activeDay = 0;
    try{ localStorage.setItem('abt_day_'+openTripId, '0'); }catch(e){}
  }

  // Persist to localStorage + cloud
  const db = wDB();
  if(db.trips[openTripId]){
    db.trips[openTripId].tripDays   = newDays;
    db.trips[openTripId].dates      = dateLabel;
    db.trips[openTripId].travelDate = startDate.toISOString();
    db.trips[openTripId].state      = state;
    db.trips[openTripId].deletedIds = deletedIds;
    wSave(db);
    TRIP = db.trips[openTripId];
  }

  // Update the trip header subtitle
  const sub = document.getElementById('tripSubtitle');
  if(sub) sub.textContent = dateLabel;

  // Update countdown
  TRAVEL_DATE = startDate.getTime();
  clearInterval(cdInterval);
  checkArrived(); updateCD(); cdInterval = setInterval(updateCD, 1000);

  // Re-render itinerary with new days
  buildDayTabs();
  renderItinerary();

  // Update the settings date label to reflect new value
  const lbl = document.getElementById('ed-dates-label');
  if(lbl) lbl.textContent = dateLabel;

  // Queue cloud sync
  setStatus('â˜ï¸ Pendingâ€¦');
  clearTimeout(syncTimer);
  syncTimer = setTimeout(syncToCloud, 2000);
}

// Populate the settings date picker when the settings tab is opened
function initSettingsDatePicker(){
  const lbl = document.getElementById('ed-dates-label');
  if(!lbl) return;
  const dates = TRIP ? (TRIP.dates || '') : '';
  lbl.textContent = dates || 'Select datesâ€¦';
  const hidden = document.getElementById('ed-dates');
  if(hidden) hidden.value = dates;
}

async function resetApp(){
  if(!confirm('Reset this trip\'s data?\n\nThis will permanently clear all itinerary, lists, notes and tickets on ALL devices. Cannot be undone.'))return;
  if(!confirm('Are you sure?'))return;
  state={itinerary:[],notes:'',memories:[]};tickets=[];deletedIds=[];deletedTravelers=[];
  personLists={};travelers.forEach(t=>{personLists[t.username]={shopping:[],packing:[],ukShopping:[],shoppingDeleted:[]};});
  saveTripLocal();
  const tok=await getAccessToken();
  if(tok){try{const empty={itinerary:[],notes:'',travelers,personLists,tickets:[],memories:[],deletedIds:[],deletedTravelers:[]};await dbx.up(tok,tripCloudPath(),JSON.stringify(empty));setStatus('â˜ï¸ Reset âœ…');}catch(e){setStatus('â˜ï¸ Local reset done');}}
  render();await renderTickets();await renderMemories();renderTravelerSettings();
  alert('Trip data cleared.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CODE COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyTripCode(){
  if(!TRIP)return;
  if(navigator.clipboard) navigator.clipboard.writeText(TRIP.code).then(()=>showToast('Code '+TRIP.code+' copied! ğŸ“‹'));
  else showToast('Join code: '+TRIP.code);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS & SWIPE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(n,silent){
  currentTab=n;
  document.getElementById('tabsSlider').style.transform=`translateX(${-n*100}%)`;
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',i===n));
  if(!silent){
    const sc=document.getElementById('s-trip');if(sc)sc.scrollTo({top:0,behavior:'smooth'});
    if(openTripId)history.replaceState(null,'','#trip/'+openTripId+'/'+n);
  }
}
(function(){
  let sx=0,sy=0,locked=false;
  const sl=document.getElementById('tabsSlider');
  sl.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;locked=false;},{passive:true});
  sl.addEventListener('touchmove',e=>{if(locked)return;const dx=Math.abs(e.touches[0].clientX-sx),dy=Math.abs(e.touches[0].clientY-sy);if(dy>dx*0.8)locked=true;},{passive:true});
  sl.addEventListener('touchend',e=>{if(locked)return;const dx=e.changedTouches[0].clientX-sx,dy=e.changedTouches[0].clientY-sy;if(Math.abs(dx)<50||Math.abs(dy)>Math.abs(dx)*0.8)return;if(dx<0&&currentTab<3)switchTab(currentTab+1);if(dx>0&&currentTab>0)switchTab(currentTab-1);},{passive:true});
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS (dashboard sheet modals)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMd(id){document.getElementById(id).classList.add('open');}
function closeMd(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-bd').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)closeMd(m.id);}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastT=null;
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>t.classList.remove('show'),2800);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STARTUP â€” credentials baked in, zero setup needed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BAKED = {
  key:     'psrzby03p9rz8bh',
  secret:  'vsl3cp8tclkmhjv',
  refresh: 'Fw1F2gzo8eIAAAAAAAAAAeZqHLb6Q-lkoGjp2gEx3X3V79e1sNmFBju_uOT7TRFq'
};

openIDB().then(async ()=>{
  localStorage.setItem('dbx_key',     BAKED.key);
  localStorage.setItem('dbx_secret',  BAKED.secret);
  localStorage.setItem('dbx_refresh', BAKED.refresh);
  const hash=window.location.hash.replace('#','');
  const parts=hash.split('/');
  const route=parts[0]||'dash';
  if(!CU){showScreen('auth',true);history.replaceState(null,'','#auth');return;}
  if(route==='trip'&&parts[1]){
    const db=wDB();
    if(db.trips[parts[1]]){
      openTrip(parts[1]);
      const tab=parseInt(parts[2]||'0')||0;
      if(tab>0)switchTab(tab,true);
      // Sync from cloud: immediately if trip appears empty, otherwise after 1s
      const hasLocalData = (state.itinerary&&state.itinerary.length>0)||
                           (tickets&&tickets.length>0)||
                           (state.notes&&state.notes.trim());
      setTimeout(syncFromCloud, hasLocalData ? 2500 : 100);
      return;
    }
  }
  renderDashboard();showScreen('dash',true);history.replaceState(null,'','#dash');
});
window.addEventListener('popstate',()=>{
  const hash=window.location.hash.replace('#','');
  const parts=hash.split('/');
  if(!CU){showScreen('auth',true);return;}
  if(parts[0]==='trip'&&parts[1]){const db=wDB();if(db.trips[parts[1]]){openTrip(parts[1]);if(parts[2])switchTab(parseInt(parts[2])||0,true);return;}}
  renderDashboard();showScreen('dash',true);
});
</script>
</body>
</html>
